---
phase: 34-state-machine-auto-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sites/55meet.com/app/db/models.py
  - sites/55meet.com/app/routers/sessions.py
  - sites/55meet.com/app/routers/participant.py
  - sites/55meet.com/app/services/images.py
autonomous: true

must_haves:
  truths:
    - "Creating a session immediately puts it in CAPTURING state (no DRAFT step)"
    - "Image browser shows ~60 images per session instead of full library"
    - "No code path references DRAFT state anywhere"
  artifacts:
    - path: "sites/55meet.com/app/db/models.py"
      provides: "SessionState enum without DRAFT"
      contains: "CAPTURING"
    - path: "sites/55meet.com/app/routers/sessions.py"
      provides: "Session creation in CAPTURING state, no /start endpoint"
      contains: "state=SessionState.CAPTURING"
    - path: "sites/55meet.com/app/services/images.py"
      provides: "get_shuffled_images with limit parameter"
      contains: "limit"
  key_links:
    - from: "sites/55meet.com/app/routers/sessions.py"
      to: "sites/55meet.com/app/db/models.py"
      via: "SessionState.CAPTURING used in create_session"
      pattern: "SessionState\\.CAPTURING"
    - from: "sites/55meet.com/app/routers/participant.py"
      to: "sites/55meet.com/app/services/images.py"
      via: "get_shuffled_images called with limit=60"
      pattern: "get_shuffled_images.*limit"
---

<objective>
Remove DRAFT state from session lifecycle and add image subset limiting.

Purpose: Sessions should start capturing immediately on creation (no manual "Start" step). Image browser should show a manageable ~60 image subset rather than the full library.
Output: Clean state machine (CAPTURING -> CLOSED -> REVEALED) and image limit parameter.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

Key source files:
@sites/55meet.com/app/db/models.py — SessionState enum (line 18-23), Session model default (line 65)
@sites/55meet.com/app/routers/sessions.py — create_session (line 67-119), start_capturing (line 238-254)
@sites/55meet.com/app/routers/participant.py — DRAFT checks (line 313, line 560-561)
@sites/55meet.com/app/services/images.py — get_shuffled_images (line 86-102)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove DRAFT state and update all references</name>
  <files>
    sites/55meet.com/app/db/models.py
    sites/55meet.com/app/routers/sessions.py
    sites/55meet.com/app/routers/participant.py
  </files>
  <action>
1. In `app/db/models.py`:
   - Remove `DRAFT = "draft"` from SessionState enum
   - Change `default=SessionState.DRAFT` to `default=SessionState.CAPTURING` on Session.state column (line 65)

2. In `app/routers/sessions.py`:
   - In `create_session()` (line 110-115): Change `state=SessionState.DRAFT` to `state=SessionState.CAPTURING`
   - Remove the entire `start_capturing()` endpoint (lines 238-254) — no longer needed
   - In `view_session()` template context: The template handles state display, no Python changes needed here

3. In `app/routers/participant.py`:
   - In `respond_form()` (line 313): Remove the `if session.state == SessionState.DRAFT:` branch. The remaining logic handles CLOSED/REVEALED gracefully already.
   - In `view_synthesis()` (line 560-561): Remove `if session.state == SessionState.DRAFT:` check. Replace with: if session is CAPTURING or CLOSED, redirect to waiting (existing logic on line 563 handles this). Simply remove the DRAFT-specific block.

4. Run a migration on the database:
   - Execute: `sqlite3 /var/www/sites/55meet.com/db/the55.db "UPDATE sessions SET state = 'capturing' WHERE state = 'draft';"`
   - Verify: `sqlite3 /var/www/sites/55meet.com/db/the55.db "SELECT COUNT(*) FROM sessions WHERE state = 'draft';"` should return 0

Do NOT remove the `/synthesize` or `/reveal` endpoints — those are kept as manual fallbacks.
  </action>
  <verify>
    grep -r "DRAFT" sites/55meet.com/app/ — should return zero matches
    grep "start_capturing" sites/55meet.com/app/routers/sessions.py — should return zero matches
    sqlite3 /var/www/sites/55meet.com/db/the55.db "SELECT COUNT(*) FROM sessions WHERE state = 'draft';" — returns 0
  </verify>
  <done>SessionState enum has only CAPTURING/CLOSED/REVEALED. Creating a session sets state to CAPTURING. No code references DRAFT anywhere in app/. Database has no draft sessions.</done>
</task>

<task type="auto">
  <name>Task 2: Add limit parameter to image shuffling</name>
  <files>
    sites/55meet.com/app/services/images.py
    sites/55meet.com/app/routers/participant.py
  </files>
  <action>
1. In `app/services/images.py`, modify `get_shuffled_images()` (line 86):
   - Add `limit: int = None` parameter after `seed: int`
   - After the shuffle, if limit is not None, slice: `images = images[:limit]`
   - Update docstring to document the limit parameter

2. In `app/routers/participant.py`, in `respond_form()` (line 339):
   - Change: `shuffled_images = library.get_shuffled_images(seed=session.id)`
   - To: `shuffled_images = library.get_shuffled_images(seed=session.id, limit=60)`
   - This ensures participants see a consistent subset of ~60 images per session

3. Also update `get_paginated_images()` in images.py (line 104) to pass through a limit parameter:
   - Add `limit: int = None` parameter
   - Change internal call: `all_images = self.get_shuffled_images(seed, limit=limit)`
   - This keeps the pagination API consistent (though it may not be actively used with the new limit)
  </action>
  <verify>
    grep "limit" sites/55meet.com/app/services/images.py — should show limit parameter in get_shuffled_images and get_paginated_images
    grep "limit=60" sites/55meet.com/app/routers/participant.py — should show the limit being passed
    python3 -c "import sys; sys.path.insert(0, '/var/www/sites/55meet.com'); from app.services.images import ImageLibrary; from pathlib import Path; lib = ImageLibrary(Path('/var/www/sites/55meet.com/static/images/library/reducedlive')); imgs = lib.get_shuffled_images(seed=1, limit=60); print(f'Got {len(imgs)} images'); assert len(imgs) <= 60"
  </verify>
  <done>get_shuffled_images accepts limit parameter. Participant image browser passes limit=60, showing a consistent 60-image subset per session.</done>
</task>

</tasks>

<verification>
- No references to DRAFT in app/ directory
- Session creation defaults to CAPTURING
- /start endpoint removed
- Image library returns at most 60 images when limit=60 is passed
- Database has no sessions in 'draft' state
</verification>

<success_criteria>
- SessionState enum: CAPTURING, CLOSED, REVEALED only
- New sessions start in CAPTURING immediately
- Participant flow has no DRAFT-related checks
- Image browser shows 60 images per session
- Application starts without errors after changes
</success_criteria>

<output>
After completion, create `.planning/phases/34-state-machine-auto-flow/34-01-SUMMARY.md`
</output>
