---
phase: 34-state-machine-auto-flow
plan: 02
type: execute
wave: 2
depends_on: ["34-01"]
files_modified:
  - sites/55meet.com/app/routers/sessions.py
  - sites/55meet.com/app/services/synthesis.py
  - sites/55meet.com/app/routers/participant.py
autonomous: true

must_haves:
  truths:
    - "Closing capture automatically triggers synthesis in background"
    - "Synthesis completion automatically sets state to REVEALED with revealed_at timestamp"
    - "Participant status endpoint includes synthesis_progress when session is CLOSED"
  artifacts:
    - path: "sites/55meet.com/app/routers/sessions.py"
      provides: "Close endpoint triggers background synthesis"
      contains: "background_tasks.add_task(run_synthesis_task"
    - path: "sites/55meet.com/app/services/synthesis.py"
      provides: "Auto-reveal after successful synthesis"
      contains: "SessionState.REVEALED"
    - path: "sites/55meet.com/app/routers/participant.py"
      provides: "Enhanced status with synthesis_progress"
      contains: "synthesis_progress"
  key_links:
    - from: "sites/55meet.com/app/routers/sessions.py"
      to: "sites/55meet.com/app/services/synthesis.py"
      via: "close_capture triggers run_synthesis_task"
      pattern: "background_tasks\\.add_task.*run_synthesis_task"
    - from: "sites/55meet.com/app/services/synthesis.py"
      to: "sites/55meet.com/app/db/models.py"
      via: "Sets REVEALED state after synthesis completes"
      pattern: "session\\.state.*SessionState\\.REVEALED"
    - from: "sites/55meet.com/app/routers/participant.py"
      to: "status endpoint"
      via: "Returns synthesis_progress object"
      pattern: "synthesis_progress"
---

<objective>
Wire auto-synthesize on close, auto-reveal on synthesis complete, and enhanced status polling.

Purpose: The facilitator should only need to click "Close Capture" — synthesis triggers automatically, and results auto-reveal to participants when ready. No manual "Synthesize" or "Reveal" button clicks needed.
Output: Fully automated close -> synthesize -> reveal pipeline with progress visibility.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/34-state-machine-auto-flow/34-01-SUMMARY.md

Key source files:
@sites/55meet.com/app/routers/sessions.py — close_capture (line 257-274), trigger_synthesis (line 356-392)
@sites/55meet.com/app/services/synthesis.py — _generate_and_store_synthesis (line 87-168)
@sites/55meet.com/app/routers/participant.py — get_participant_status (line 597-627)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Auto-synthesize on close and auto-reveal on complete</name>
  <files>
    sites/55meet.com/app/routers/sessions.py
    sites/55meet.com/app/services/synthesis.py
  </files>
  <action>
1. In `app/routers/sessions.py`, modify `close_capture()` (line 257):
   - Add `background_tasks: BackgroundTasks` parameter to the function signature
   - After setting state to CLOSED and committing, set the "GENERATING..." marker:
     ```python
     session.synthesis_themes = "GENERATING..."
     db.commit()
     ```
   - Then trigger synthesis: `background_tasks.add_task(run_synthesis_task, session_id)`
   - This mirrors the logic from `trigger_synthesis()` but happens automatically

2. In `app/services/synthesis.py`, modify `_generate_and_store_synthesis()`:
   - After storing synthesis results successfully (after line 153, before db.commit()):
     ```python
     # Auto-reveal: transition CLOSED -> REVEALED
     if session.state == SessionState.CLOSED:
         session.state = SessionState.REVEALED
         session.revealed_at = datetime.utcnow()
     ```
   - Add `from datetime import datetime` import if not already present (it's imported in models.py but check synthesis.py)
   - Add `SessionState` to the imports from `app.db.models` (currently only imports Session, Response)

3. Keep the manual `/synthesize` and `/reveal` endpoints intact as fallbacks for error recovery. Do NOT remove them.

4. In the error handling branch of `_generate_and_store_synthesis()` (line 156-166):
   - Do NOT auto-reveal on failure. The existing error handling stores "Synthesis generation failed..." which is correct.
   - The facilitator can use the retry endpoint to re-trigger.
  </action>
  <verify>
    grep "background_tasks" sites/55meet.com/app/routers/sessions.py | grep "close_capture" — should show BackgroundTasks in signature
    grep "run_synthesis_task" sites/55meet.com/app/routers/sessions.py — should appear in both close_capture and trigger_synthesis
    grep "SessionState.REVEALED" sites/55meet.com/app/services/synthesis.py — should show auto-reveal logic
    grep "revealed_at" sites/55meet.com/app/services/synthesis.py — should show timestamp being set
  </verify>
  <done>Closing capture auto-triggers synthesis. Successful synthesis auto-transitions to REVEALED with timestamp. Manual endpoints preserved as fallback.</done>
</task>

<task type="auto">
  <name>Task 2: Enhanced participant status with synthesis progress</name>
  <files>
    sites/55meet.com/app/routers/participant.py
  </files>
  <action>
1. In `app/routers/participant.py`, modify `get_participant_status()` (line 597):
   - After the existing response data, add a `synthesis_progress` object when session is CLOSED:
     ```python
     # Build synthesis progress for CLOSED state
     synthesis_progress = None
     if session.state == SessionState.CLOSED:
         if session.synthesis_themes is None:
             synthesis_progress = {
                 "status": "pending",
                 "message": "Preparing analysis..."
             }
         elif session.synthesis_themes.lower() == "generating...":
             synthesis_progress = {
                 "status": "generating",
                 "message": "Analyzing team responses..."
             }
         elif "failed" in session.synthesis_themes.lower():
             synthesis_progress = {
                 "status": "failed",
                 "message": "Analysis encountered an issue. Your facilitator will retry."
             }
         else:
             synthesis_progress = {
                 "status": "complete",
                 "message": "Analysis complete!"
             }
     ```
   - Add `"synthesis_progress": synthesis_progress` to the JSONResponse dict

2. The participant waiting page already polls this endpoint. The new field gives the frontend visibility into synthesis progress without requiring page changes yet (Phase 37 will use this for live UI updates).
  </action>
  <verify>
    grep "synthesis_progress" sites/55meet.com/app/routers/participant.py — should show the new field
    curl -s http://localhost:8000/join/TESTCODE/session/1/status 2>/dev/null | python3 -m json.tool — should include synthesis_progress field (or verify via grep that the response dict includes it)
  </verify>
  <done>Participant status endpoint returns synthesis_progress object with status and message fields when session is in CLOSED state. Null for other states.</done>
</task>

</tasks>

<verification>
- Close endpoint triggers synthesis automatically (check BackgroundTasks usage)
- Synthesis service sets REVEALED state on success
- Synthesis service does NOT set REVEALED on failure
- Participant status includes synthesis_progress
- Manual /synthesize and /reveal endpoints still work as fallbacks
- Application restarts cleanly
</verification>

<success_criteria>
- Full automated pipeline: Create session (CAPTURING) -> Close (CLOSED + auto-synthesize) -> Complete (REVEALED)
- Facilitator only clicks "Close Capture" — everything else is automatic
- Participants can see synthesis progress via polling
- Error recovery preserved via manual endpoints
</success_criteria>

<output>
After completion, create `.planning/phases/34-state-machine-auto-flow/34-02-SUMMARY.md`
</output>
