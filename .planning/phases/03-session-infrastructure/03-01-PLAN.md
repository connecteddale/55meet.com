---
phase: 12-session-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - the55/app/routers/sessions.py
  - the55/app/routers/__init__.py
  - the55/app/main.py
autonomous: true

must_haves:
  truths:
    - "Facilitator can create session for team/month"
    - "Facilitator can start capturing (draft → capturing)"
    - "Facilitator can close capture (capturing → closed)"
    - "Facilitator can reveal synthesis (closed → revealed)"
    - "State transitions are enforced (no skipping states)"
    - "Session status endpoint returns participant counts"
  artifacts:
    - path: "the55/app/routers/sessions.py"
      provides: "Session CRUD and control endpoints"
      contains: "close_capture"
    - path: "the55/app/routers/sessions.py"
      provides: "Session status polling endpoint"
      contains: "get_session_status"
  key_links:
    - from: "sessions router"
      to: "Session model"
      via: "SQLAlchemy ORM"
      pattern: "db.query(Session)"
    - from: "state transitions"
      to: "SessionState enum"
      via: "enforcement logic"
      pattern: "SessionState.CAPTURING"
---

<objective>
Create session CRUD operations and state control API for facilitator.

Purpose: Enable facilitator to create monthly sessions and control their lifecycle (draft → capturing → closed → revealed).
Output: Sessions router with create, state transitions, and status polling endpoint.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@the55/app/db/models.py
@the55/app/routers/teams.py
@the55/app/dependencies.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sessions router with CRUD and control</name>
  <files>the55/app/routers/sessions.py</files>
  <action>
    Create sessions.py router with all session management endpoints:
    ```python
    """
    The 55 App - Sessions Router

    Session management and control endpoints for facilitator.
    """

    from datetime import datetime
    from typing import Optional

    from fastapi import APIRouter, Request, Form, HTTPException
    from fastapi.responses import RedirectResponse, JSONResponse
    from fastapi.templating import Jinja2Templates

    from app.dependencies import AuthDep, DbDep
    from app.db.models import Team, Member, Session, Response, SessionState

    router = APIRouter(prefix="/admin/sessions", tags=["sessions"])
    templates = Jinja2Templates(directory="app/templates")


    def get_current_month() -> str:
        """Get current month in YYYY-MM format."""
        return datetime.utcnow().strftime("%Y-%m")


    @router.get("/team/{team_id}")
    async def list_team_sessions(request: Request, team_id: int, auth: AuthDep, db: DbDep):
        """List all sessions for a team."""
        team = db.query(Team).filter(Team.id == team_id).first()
        if not team:
            return RedirectResponse(url="/admin/teams", status_code=303)

        sessions = db.query(Session).filter(
            Session.team_id == team_id
        ).order_by(Session.month.desc()).all()

        return templates.TemplateResponse(
            "admin/sessions/list.html",
            {"request": request, "team": team, "sessions": sessions}
        )


    @router.get("/team/{team_id}/create")
    async def create_session_form(request: Request, team_id: int, auth: AuthDep, db: DbDep):
        """Show create session form."""
        team = db.query(Team).filter(Team.id == team_id).first()
        if not team:
            return RedirectResponse(url="/admin/teams", status_code=303)

        return templates.TemplateResponse(
            "admin/sessions/create.html",
            {
                "request": request,
                "team": team,
                "current_month": get_current_month(),
                "error": None
            }
        )


    @router.post("/team/{team_id}/create")
    async def create_session(
        request: Request,
        team_id: int,
        auth: AuthDep,
        db: DbDep,
        month: str = Form(...)
    ):
        """Create a new session for a team."""
        team = db.query(Team).filter(Team.id == team_id).first()
        if not team:
            return RedirectResponse(url="/admin/teams", status_code=303)

        # Validate month format (YYYY-MM)
        try:
            datetime.strptime(month, "%Y-%m")
        except ValueError:
            return templates.TemplateResponse(
                "admin/sessions/create.html",
                {
                    "request": request,
                    "team": team,
                    "current_month": get_current_month(),
                    "error": "Invalid month format. Use YYYY-MM."
                }
            )

        # Check for existing session
        existing = db.query(Session).filter(
            Session.team_id == team_id,
            Session.month == month
        ).first()
        if existing:
            return templates.TemplateResponse(
                "admin/sessions/create.html",
                {
                    "request": request,
                    "team": team,
                    "current_month": get_current_month(),
                    "error": f"Session for {month} already exists."
                }
            )

        # Create session in draft state
        session = Session(
            team_id=team_id,
            month=month,
            state=SessionState.DRAFT
        )
        db.add(session)
        db.commit()

        return RedirectResponse(url=f"/admin/sessions/{session.id}", status_code=303)


    @router.get("/{session_id}")
    async def view_session(request: Request, session_id: int, auth: AuthDep, db: DbDep):
        """View session details and control panel."""
        session = db.query(Session).filter(Session.id == session_id).first()
        if not session:
            return RedirectResponse(url="/admin/teams", status_code=303)

        team = session.team
        members = db.query(Member).filter(Member.team_id == team.id).order_by(Member.name).all()

        # Get response status for each member
        responses = db.query(Response).filter(Response.session_id == session_id).all()
        responded_member_ids = {r.member_id for r in responses}

        member_status = []
        for member in members:
            member_status.append({
                "id": member.id,
                "name": member.name,
                "submitted": member.id in responded_member_ids
            })

        return templates.TemplateResponse(
            "admin/sessions/view.html",
            {
                "request": request,
                "session": session,
                "team": team,
                "member_status": member_status,
                "total_members": len(members),
                "submitted_count": len(responded_member_ids)
            }
        )


    @router.post("/{session_id}/start")
    async def start_capturing(session_id: int, auth: AuthDep, db: DbDep):
        """Transition session from draft to capturing."""
        session = db.query(Session).filter(Session.id == session_id).first()
        if not session:
            raise HTTPException(status_code=404, detail="Session not found")

        if session.state != SessionState.DRAFT:
            raise HTTPException(
                status_code=400,
                detail=f"Cannot start capturing. Session is in '{session.state.value}' state."
            )

        session.state = SessionState.CAPTURING
        db.commit()

        return RedirectResponse(url=f"/admin/sessions/{session_id}", status_code=303)


    @router.post("/{session_id}/close")
    async def close_capture(session_id: int, auth: AuthDep, db: DbDep):
        """Transition session from capturing to closed."""
        session = db.query(Session).filter(Session.id == session_id).first()
        if not session:
            raise HTTPException(status_code=404, detail="Session not found")

        if session.state != SessionState.CAPTURING:
            raise HTTPException(
                status_code=400,
                detail=f"Cannot close capture. Session is in '{session.state.value}' state."
            )

        session.state = SessionState.CLOSED
        session.closed_at = datetime.utcnow()
        db.commit()

        return RedirectResponse(url=f"/admin/sessions/{session_id}", status_code=303)


    @router.post("/{session_id}/reveal")
    async def reveal_synthesis(session_id: int, auth: AuthDep, db: DbDep):
        """Transition session from closed to revealed."""
        session = db.query(Session).filter(Session.id == session_id).first()
        if not session:
            raise HTTPException(status_code=404, detail="Session not found")

        if session.state != SessionState.CLOSED:
            raise HTTPException(
                status_code=400,
                detail=f"Cannot reveal synthesis. Session is in '{session.state.value}' state."
            )

        session.state = SessionState.REVEALED
        session.revealed_at = datetime.utcnow()
        db.commit()

        return RedirectResponse(url=f"/admin/sessions/{session_id}", status_code=303)


    @router.get("/{session_id}/status")
    async def get_session_status(session_id: int, auth: AuthDep, db: DbDep):
        """Get session status for polling (JSON endpoint)."""
        session = db.query(Session).filter(Session.id == session_id).first()
        if not session:
            raise HTTPException(status_code=404, detail="Session not found")

        team = session.team
        members = db.query(Member).filter(Member.team_id == team.id).all()
        responses = db.query(Response).filter(Response.session_id == session_id).all()
        responded_member_ids = {r.member_id for r in responses}

        member_status = []
        for member in members:
            member_status.append({
                "id": member.id,
                "name": member.name,
                "submitted": member.id in responded_member_ids
            })

        return JSONResponse({
            "session_id": session_id,
            "state": session.state.value,
            "total_members": len(members),
            "submitted_count": len(responded_member_ids),
            "members": member_status
        })


    @router.post("/{session_id}/recalibration")
    async def mark_recalibration_complete(
        session_id: int,
        auth: AuthDep,
        db: DbDep,
        completed: bool = Form(...)
    ):
        """Mark recalibration action as completed."""
        session = db.query(Session).filter(Session.id == session_id).first()
        if not session:
            raise HTTPException(status_code=404, detail="Session not found")

        session.recalibration_completed = completed
        db.commit()

        return RedirectResponse(url=f"/admin/sessions/{session_id}", status_code=303)
    ```
  </action>
  <verify>python -c "from app.routers.sessions import router; print('OK')"</verify>
  <done>Sessions router with CRUD and state control created</done>
</task>

<task type="auto">
  <name>Task 2: Register sessions router in main app</name>
  <files>the55/app/routers/__init__.py, the55/app/main.py</files>
  <action>
    Update routers/__init__.py to export sessions_router:
    ```python
    from app.routers.auth import router as auth_router
    from app.routers.admin import router as admin_router
    from app.routers.images import router as images_router
    from app.routers.teams import router as teams_router
    from app.routers.members import router as members_router
    from app.routers.sessions import router as sessions_router
    ```

    Update main.py to include sessions router:
    ```python
    from app.routers import auth_router, admin_router, images_router, teams_router, members_router, sessions_router

    # In app setup section, add:
    app.include_router(sessions_router)
    ```
  </action>
  <verify>grep "sessions_router" /var/www/the55/app/main.py</verify>
  <done>Sessions router registered in main app</done>
</task>

<task type="auto">
  <name>Task 3: Test session state transitions</name>
  <files>None (testing only)</files>
  <action>
    Test state transitions via Python:
    ```bash
    cd /var/www/the55
    source venv/bin/activate
    python -c "
    from app.db.database import SessionLocal
    from app.db.models import Team, Session, SessionState
    from datetime import datetime

    db = SessionLocal()

    # Create test team
    team = Team(company_name='State Test Co', team_name='State Test', code='STATETEST')
    db.add(team)
    db.commit()

    # Create session in draft
    session = Session(team_id=team.id, month='2026-01', state=SessionState.DRAFT)
    db.add(session)
    db.commit()

    # Test valid transition: draft -> capturing
    assert session.state == SessionState.DRAFT
    session.state = SessionState.CAPTURING
    db.commit()
    assert session.state == SessionState.CAPTURING
    print('draft -> capturing: OK')

    # Test valid transition: capturing -> closed
    session.state = SessionState.CLOSED
    session.closed_at = datetime.utcnow()
    db.commit()
    assert session.state == SessionState.CLOSED
    print('capturing -> closed: OK')

    # Test valid transition: closed -> revealed
    session.state = SessionState.REVEALED
    session.revealed_at = datetime.utcnow()
    db.commit()
    assert session.state == SessionState.REVEALED
    print('closed -> revealed: OK')

    # Clean up
    db.delete(session)
    db.delete(team)
    db.commit()
    db.close()
    print('All state transition tests passed')
    "
    ```

    Verify endpoints accessible:
    ```bash
    cd /var/www/the55
    source venv/bin/activate
    uvicorn app.main:app --host 0.0.0.0 --port 8055 &
    sleep 2

    # Test that sessions endpoints exist (will redirect to login)
    curl -s -o /dev/null -w "%{http_code}" http://localhost:8055/admin/sessions/team/1
    # Should return 303 (redirect to login - protected)

    pkill -f "uvicorn app.main:app"
    ```
  </action>
  <verify>All state transition tests pass</verify>
  <done>Session state machine tested and verified</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Sessions router created with CRUD endpoints
- [ ] State transitions enforced (draft → capturing → closed → revealed)
- [ ] Status polling endpoint returns JSON with member counts
- [ ] Recalibration completion endpoint works
- [ ] Router registered in main app
</verification>

<success_criteria>
- All tasks completed
- Session CRUD functional
- State transitions enforced
- Polling endpoint returns correct status
</success_criteria>

<output>
After completion, create `.planning/phases/12-session-infrastructure/12-01-SUMMARY.md`
</output>
