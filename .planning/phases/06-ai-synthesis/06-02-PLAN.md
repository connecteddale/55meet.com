---
phase: 15-ai-synthesis
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - the55/app/routers/sessions.py
  - the55/app/templates/admin/sessions/view.html
autonomous: true

must_haves:
  truths:
    - "Facilitator can trigger synthesis generation from session view"
    - "Synthesis only runs when session is in CLOSED state"
    - "UI shows synthesis status (pending, complete, error)"
    - "Synthesis does not block HTTP response"
  artifacts:
    - path: "the55/app/routers/sessions.py"
      provides: "POST synthesize endpoint"
      contains: "/synthesize"
    - path: "the55/app/templates/admin/sessions/view.html"
      provides: "Synthesis trigger button and status display"
      contains: "Generate Synthesis"
  key_links:
    - from: "the55/app/routers/sessions.py"
      to: "the55/app/services/synthesis.py"
      via: "import run_synthesis_task"
      pattern: "from app.services.synthesis import run_synthesis_task"
    - from: "the55/app/routers/sessions.py"
      to: "fastapi.BackgroundTasks"
      via: "background_tasks.add_task"
      pattern: "background_tasks.add_task"
---

<objective>
Add synthesis trigger endpoint and update facilitator UI to generate and display synthesis.

Purpose: Facilitator needs to trigger synthesis after closing capture. The synthesis runs in background (10-30 seconds) while the UI shows progress. Once complete, facilitator can reveal to participants.

Output:
- POST `/admin/sessions/{session_id}/synthesize` endpoint
- Updated session view template with synthesis controls
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/15-ai-synthesis/15-01-SUMMARY.md

# Existing patterns
@the55/app/routers/sessions.py
@the55/app/templates/admin/sessions/view.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add synthesis trigger endpoint to sessions router</name>
  <files>the55/app/routers/sessions.py</files>
  <action>
Update `app/routers/sessions.py`:

1. Add imports:
   - `from fastapi import BackgroundTasks`
   - `from app.services.synthesis import run_synthesis_task`

2. Add new endpoint `POST /{session_id}/synthesize`:
   ```python
   @router.post("/{session_id}/synthesize")
   async def trigger_synthesis(
       session_id: int,
       background_tasks: BackgroundTasks,
       auth: AuthDep,
       db: DbDep
   ):
   ```

   - Fetch session, return 404 if not found
   - Validate state is CLOSED (HTTPException 400 if not)
   - Check if synthesis already exists (synthesis_themes is not None)
     - If exists and not error message, redirect back (already done)
   - Add background task: `background_tasks.add_task(run_synthesis_task, session_id)`
   - Redirect back to session view (303)

3. Update `view_session` to include synthesis data:
   - Pass `synthesis_themes`, `synthesis_statements`, `synthesis_gap_type` to template
   - Parse `synthesis_statements` from JSON if not None (handle empty string/null)
   - Add `synthesis_pending` flag: True if state is CLOSED and synthesis_themes is None

4. Update `get_session_status` to include synthesis status:
   - Add `has_synthesis: bool` to JSON response
   - Add `synthesis_pending: bool` to JSON response
  </action>
  <verify>
```bash
cd /var/www/the55 && source venv/bin/activate && python -c "
from app.routers.sessions import router
routes = [r.path for r in router.routes]
assert '/{session_id}/synthesize' in routes, 'Missing synthesize route'
print('Synthesize route exists')
"
```
  </verify>
  <done>POST /{session_id}/synthesize endpoint exists and validates CLOSED state</done>
</task>

<task type="auto">
  <name>Task 2: Update session view template for synthesis controls</name>
  <files>the55/app/templates/admin/sessions/view.html</files>
  <action>
Update `app/templates/admin/sessions/view.html`:

1. In the CLOSED state section, replace simple "Reveal Synthesis" button with:
   - If `synthesis_pending` (no synthesis yet):
     - Show "Generate Synthesis" button (POST to /synthesize)
     - Show hint: "This will analyze responses and generate themes."
   - If synthesis exists (synthesis_themes is not None):
     - Show synthesis preview card with:
       - Themes (synthesis_themes text)
       - Gap type badge (synthesis_gap_type)
       - Number of attributed statements
     - Show "Reveal to Participants" button (existing reveal action)
   - If synthesis is generating (determined by polling):
     - Show spinner with "Generating synthesis..." message

2. Add synthesis display section (shown in CLOSED and REVEALED states):
   ```html
   {% if synthesis_themes %}
   <div class="card synthesis-preview">
       <h3>Synthesis Preview</h3>
       <div class="synthesis-themes">
           <h4>Themes</h4>
           <p>{{ synthesis_themes }}</p>
       </div>
       {% if synthesis_gap_type %}
       <div class="synthesis-gap">
           <h4>Gap Type</h4>
           <span class="gap-badge gap-{{ synthesis_gap_type|lower }}">{{ synthesis_gap_type }}</span>
       </div>
       {% endif %}
       {% if synthesis_statements %}
       <div class="synthesis-statements">
           <h4>Key Insights</h4>
           <ul>
           {% for stmt in synthesis_statements %}
               <li>{{ stmt.statement }} <em>({{ stmt.participants|join(', ') }})</em></li>
           {% endfor %}
           </ul>
       </div>
       {% endif %}
   </div>
   {% endif %}
   ```

3. Add CSS for synthesis components:
   - `.synthesis-preview` card styling
   - `.gap-badge` with colors for Direction (blue), Alignment (orange), Commitment (green)
   - `.synthesis-statements` list styling

4. Update polling script to check synthesis status:
   - Poll /status endpoint in CLOSED state too
   - When `has_synthesis` becomes true, reload page to show preview
  </action>
  <verify>Manual verification required - check template syntax is valid</verify>
  <done>Session view shows synthesis controls based on state and synthesis existence</done>
</task>

</tasks>

<verification>
1. Navigate to session in CLOSED state without synthesis - see "Generate Synthesis" button
2. Click "Generate Synthesis" - page reloads, synthesis processes in background
3. After synthesis completes (poll or refresh), see synthesis preview card
4. See "Reveal to Participants" button only after synthesis exists
</verification>

<success_criteria>
- Synthesis trigger only available in CLOSED state
- Background task does not block HTTP response
- Synthesis preview displays themes, gap type, and statements
- Reveal button only shows after synthesis is complete
</success_criteria>

<output>
After completion, create `.planning/phases/15-ai-synthesis/15-02-SUMMARY.md`
</output>
