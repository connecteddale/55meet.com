---
phase: 15-ai-synthesis
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - the55/app/services/synthesis.py
  - the55/app/schemas/__init__.py
autonomous: true
user_setup:
  - service: anthropic
    why: "Claude API for synthesis generation"
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "Anthropic Console -> API Keys -> Create key"
    dashboard_config: []

must_haves:
  truths:
    - "Synthesis service can call Claude API asynchronously"
    - "Synthesis prompt includes strategy statement and all responses"
    - "Claude returns structured JSON with themes, statements, gap_type"
    - "Background task wrapper handles event loop correctly"
  artifacts:
    - path: "the55/app/services/synthesis.py"
      provides: "Claude API integration, prompt building, background task"
      exports: ["run_synthesis_task", "SynthesisOutput"]
    - path: "the55/app/schemas/__init__.py"
      provides: "Pydantic schemas for synthesis"
      contains: "class SynthesisOutput"
  key_links:
    - from: "the55/app/services/synthesis.py"
      to: "anthropic.AsyncAnthropic"
      via: "API client instantiation"
      pattern: "AsyncAnthropic\\(\\)"
    - from: "the55/app/services/synthesis.py"
      to: "the55/app/db/database.py"
      via: "SessionLocal import for background task"
      pattern: "from app.db.database import SessionLocal"
---

<objective>
Create the synthesis service layer that integrates Claude API to generate insights from team responses.

Purpose: This service is the core AI integration, providing structured synthesis output (themes, attributed statements, gap diagnosis) from team member responses. The background task pattern avoids blocking the HTTP response while Claude processes.

Output:
- `app/services/synthesis.py` with Claude integration
- Pydantic schemas in `app/schemas/__init__.py`
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-ai-synthesis/15-RESEARCH.md

# Existing patterns
@the55/app/services/auth.py
@the55/app/db/database.py
@the55/app/db/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Pydantic schemas for synthesis output</name>
  <files>the55/app/schemas/__init__.py</files>
  <action>
Update `app/schemas/__init__.py` to add synthesis-related Pydantic models:

1. `AttributedStatement` model:
   - `statement: str` - The insight or observation
   - `participants: List[str]` - Names of team members supporting this insight

2. `SynthesisOutput` model:
   - `themes: str` - 2-4 sentences summarizing team experience
   - `statements: List[AttributedStatement]` - Specific insights with attribution
   - `gap_type: Literal["Direction", "Alignment", "Commitment"]` - Primary gap type
   - `gap_reasoning: str` - 1-2 sentence explanation for gap diagnosis

Use Field() with descriptions for each field (helps with structured output schema).
  </action>
  <verify>
```bash
cd /var/www/the55 && source venv/bin/activate && python -c "from app.schemas import SynthesisOutput, AttributedStatement; print('Schemas imported successfully')"
```
  </verify>
  <done>SynthesisOutput and AttributedStatement schemas importable from app.schemas</done>
</task>

<task type="auto">
  <name>Task 2: Create synthesis service with Claude integration</name>
  <files>the55/app/services/synthesis.py</files>
  <action>
Create `app/services/synthesis.py` with:

1. **Imports:**
   - `json`, `asyncio` from stdlib
   - `AsyncAnthropic` from anthropic (not transform_schema - use manual JSON mode)
   - `SessionLocal` from `app.db.database`
   - `Session`, `Response` from `app.db.models`
   - `SynthesisOutput` from `app.schemas`

2. **Claude client:**
   - Instantiate `AsyncAnthropic()` at module level (uses ANTHROPIC_API_KEY env var)

3. **`build_synthesis_prompt(responses, strategy_statement)` function:**
   - Build prompt following pattern from RESEARCH.md
   - Include each participant's name, image number, and bullet points
   - Define the three output sections (themes, statements, gap diagnosis)
   - Request JSON output matching SynthesisOutput schema
   - Include explicit enum constraint for gap_type

4. **`_generate_and_store_synthesis(session_id)` async function:**
   - Create new DB session via `SessionLocal()`
   - Fetch session and validate it exists
   - Fetch all responses for session (with member relationship)
   - Check minimum 3 responses (else store fallback message)
   - Build response data list: `[{"name": ..., "image_number": ..., "bullets": ...}]`
   - Call Claude using `client.messages.create()` with:
     - model: "claude-sonnet-4-5-20250929"
     - max_tokens: 2048
     - messages: single user message with prompt
   - Parse JSON response, validate with SynthesisOutput schema
   - Store results: session.synthesis_themes, session.synthesis_statements (JSON string), session.synthesis_gap_type
   - Handle exceptions: on error, store error message in synthesis_themes, empty array in statements
   - Always close DB session in finally block

5. **`run_synthesis_task(session_id)` sync function:**
   - Create new event loop with `asyncio.new_event_loop()`
   - Set as current event loop
   - Run `_generate_and_store_synthesis(session_id)` in loop
   - Close loop in finally block
   - This is the function passed to BackgroundTasks

Note: Do NOT use the beta structured outputs API (requires specific beta flag). Use standard messages API with JSON output instruction in prompt.
  </action>
  <verify>
```bash
cd /var/www/the55 && source venv/bin/activate && python -c "from app.services.synthesis import run_synthesis_task, build_synthesis_prompt; print('Synthesis service imported successfully')"
```
  </verify>
  <done>Synthesis service with run_synthesis_task and build_synthesis_prompt functions importable</done>
</task>

</tasks>

<verification>
1. Both schemas import without error
2. Synthesis service imports without error
3. build_synthesis_prompt returns string containing required sections
4. run_synthesis_task is a synchronous function (not async)
</verification>

<success_criteria>
- SynthesisOutput schema validates gap_type as one of ["Direction", "Alignment", "Commitment"]
- Synthesis service creates new event loop in sync wrapper (per RESEARCH.md pattern)
- Prompt includes strategy statement and all response data
- Error handling stores fallback message rather than crashing
</success_criteria>

<output>
After completion, create `.planning/phases/15-ai-synthesis/15-01-SUMMARY.md`
</output>
