---
phase: 15-ai-synthesis
plan: 03
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - the55/app/routers/participant.py
  - the55/app/templates/participant/synthesis.html
autonomous: true

must_haves:
  truths:
    - "Participant can view synthesis when session is REVEALED"
    - "Synthesis page shows themes, attributed statements, and gap type"
    - "Participant is redirected to synthesis from waiting page when revealed"
    - "Non-revealed sessions redirect back to waiting"
  artifacts:
    - path: "the55/app/routers/participant.py"
      provides: "GET synthesis view endpoint"
      contains: "/synthesis"
    - path: "the55/app/templates/participant/synthesis.html"
      provides: "Synthesis display for participants"
      contains: "synthesis-themes"
  key_links:
    - from: "the55/app/templates/participant/waiting.html"
      to: "/join/{code}/session/{session_id}/synthesis"
      via: "JavaScript redirect on revealed state"
      pattern: "window.location.href.*synthesis"
---

<objective>
Create participant synthesis view to display the revealed analysis.

Purpose: After the facilitator reveals synthesis, participants can see the team's themes, attributed insights, and gap diagnosis. This is the culmination of the 55-minute session.

Output:
- GET `/join/{code}/session/{session_id}/synthesis` endpoint
- `app/templates/participant/synthesis.html` template
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/15-ai-synthesis/15-01-SUMMARY.md

# Existing patterns
@the55/app/routers/participant.py
@the55/app/templates/participant/waiting.html
@the55/app/templates/base.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add synthesis view endpoint to participant router</name>
  <files>the55/app/routers/participant.py</files>
  <action>
Update `app/routers/participant.py`:

1. Add import at top: `import json` (if not already present)

2. Add new endpoint `GET /{code}/session/{session_id}/synthesis`:
   ```python
   @router.get("/{code}/session/{session_id}/synthesis")
   async def view_synthesis(
       request: Request,
       code: str,
       session_id: int,
       db: DbDep
   ):
   ```

   Implementation:
   - Normalize code (uppercase, strip)
   - Fetch team by code, redirect to /join if not found
   - Fetch session, redirect to /join if not found or wrong team
   - Validate session state is REVEALED:
     - If CAPTURING or CLOSED, redirect to waiting page (synthesis not ready)
     - If DRAFT, redirect to /join
   - Parse synthesis_statements from JSON (handle None/empty)
   - Render synthesis.html template with:
     - request, team, session
     - synthesis_themes: session.synthesis_themes
     - synthesis_statements: parsed list of dicts
     - synthesis_gap_type: session.synthesis_gap_type

3. The waiting page redirect (line ~498) already points to this endpoint - verify it works.
  </action>
  <verify>
```bash
cd /var/www/the55 && source venv/bin/activate && python -c "
from app.routers.participant import router
routes = [r.path for r in router.routes]
assert '/{code}/session/{session_id}/synthesis' in routes, 'Missing synthesis route'
print('Synthesis route exists')
"
```
  </verify>
  <done>GET /{code}/session/{session_id}/synthesis endpoint exists and validates REVEALED state</done>
</task>

<task type="auto">
  <name>Task 2: Create participant synthesis template</name>
  <files>the55/app/templates/participant/synthesis.html</files>
  <action>
Create `app/templates/participant/synthesis.html`:

```html
{% extends "base.html" %}

{% block title %}Team Synthesis - The 55{% endblock %}

{% block header %}
<header class="participant-header">
    <div class="container">
        <h1>The 55</h1>
        <span class="team-badge">{{ team.team_name }}</span>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="synthesis-page">
    <div class="synthesis-header">
        <h2>{{ session.month }} Synthesis</h2>
        <p class="synthesis-subtitle">{{ team.company_name }}</p>
    </div>

    {% if synthesis_themes %}
    <div class="synthesis-section themes-section">
        <h3>Team Themes</h3>
        <p class="themes-text">{{ synthesis_themes }}</p>
    </div>
    {% endif %}

    {% if synthesis_gap_type %}
    <div class="synthesis-section gap-section">
        <h3>Primary Gap</h3>
        <div class="gap-indicator gap-{{ synthesis_gap_type|lower }}">
            <span class="gap-type">{{ synthesis_gap_type }}</span>
        </div>
        <p class="gap-description">
            {% if synthesis_gap_type == 'Direction' %}
            The team may lack shared understanding of goals or priorities.
            {% elif synthesis_gap_type == 'Alignment' %}
            The team's work may be disconnected or uncoordinated.
            {% elif synthesis_gap_type == 'Commitment' %}
            Individual interests may be overriding collective success.
            {% endif %}
        </p>
    </div>
    {% endif %}

    {% if synthesis_statements %}
    <div class="synthesis-section statements-section">
        <h3>Key Insights</h3>
        <ul class="insights-list">
            {% for stmt in synthesis_statements %}
            <li class="insight-item">
                <span class="insight-text">{{ stmt.statement }}</span>
                <span class="insight-attribution">({{ stmt.participants|join(', ') }})</span>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {% if not synthesis_themes %}
    <div class="synthesis-section empty-section">
        <p>Synthesis results are not yet available.</p>
    </div>
    {% endif %}

    <div class="synthesis-footer">
        <p class="footer-message">
            Discuss these insights with your team to identify action items.
        </p>
    </div>
</div>
{% endblock %}
```

Add CSS in the template or ensure base.html styles cover:
- `.synthesis-page` - centered container, max-width 600px
- `.synthesis-section` - card-like sections with padding, margin-bottom
- `.themes-text` - larger font, comfortable line-height
- `.gap-indicator` - colored badge based on gap type
  - `.gap-direction` - blue (#3B82F6)
  - `.gap-alignment` - orange (#F59E0B)
  - `.gap-commitment` - green (#10B981)
- `.insights-list` - bullet-free list with padding
- `.insight-attribution` - smaller, muted text
  </action>
  <verify>Check template exists and renders without Jinja errors</verify>
  <done>Synthesis template displays themes, gap type, and attributed statements</done>
</task>

<task type="auto">
  <name>Task 3: Add synthesis page styles to base CSS</name>
  <files>the55/app/static/css/style.css</files>
  <action>
Add synthesis-specific styles to `app/static/css/style.css`:

```css
/* Synthesis Page */
.synthesis-page {
    max-width: 600px;
    margin: 0 auto;
    padding: var(--spacing-md);
}

.synthesis-header {
    text-align: center;
    margin-bottom: var(--spacing-lg);
}

.synthesis-header h2 {
    margin-bottom: var(--spacing-xs);
}

.synthesis-subtitle {
    color: var(--text-muted);
}

.synthesis-section {
    background: var(--surface);
    border-radius: var(--radius);
    padding: var(--spacing-md);
    margin-bottom: var(--spacing-md);
}

.synthesis-section h3 {
    margin-top: 0;
    margin-bottom: var(--spacing-sm);
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
}

.themes-text {
    font-size: 1.125rem;
    line-height: 1.6;
}

/* Gap Indicator */
.gap-indicator {
    display: inline-flex;
    align-items: center;
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius);
    font-weight: 600;
    margin-bottom: var(--spacing-sm);
}

.gap-direction {
    background: #DBEAFE;
    color: #1D4ED8;
}

.gap-alignment {
    background: #FEF3C7;
    color: #B45309;
}

.gap-commitment {
    background: #D1FAE5;
    color: #047857;
}

.gap-description {
    color: var(--text-muted);
    font-size: 0.9rem;
}

/* Insights List */
.insights-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.insight-item {
    padding: var(--spacing-sm) 0;
    border-bottom: 1px solid var(--border);
}

.insight-item:last-child {
    border-bottom: none;
}

.insight-text {
    display: block;
    margin-bottom: var(--spacing-xs);
}

.insight-attribution {
    font-size: 0.85rem;
    color: var(--text-muted);
    font-style: italic;
}

/* Synthesis Footer */
.synthesis-footer {
    text-align: center;
    padding: var(--spacing-lg) 0;
}

.footer-message {
    color: var(--text-muted);
    font-style: italic;
}

/* Admin Synthesis Preview */
.synthesis-preview {
    border-left: 4px solid var(--primary);
}

.synthesis-preview h4 {
    margin: var(--spacing-sm) 0;
    font-size: 0.9rem;
    color: var(--text-muted);
}

.gap-badge {
    display: inline-block;
    padding: 0.25em 0.75em;
    border-radius: var(--radius);
    font-weight: 600;
    font-size: 0.9rem;
}

.gap-badge.gap-direction { background: #DBEAFE; color: #1D4ED8; }
.gap-badge.gap-alignment { background: #FEF3C7; color: #B45309; }
.gap-badge.gap-commitment { background: #D1FAE5; color: #047857; }
```
  </action>
  <verify>CSS file updated with synthesis styles</verify>
  <done>Synthesis page has proper styling for themes, gap types, and insights</done>
</task>

</tasks>

<verification>
1. With session in REVEALED state, navigate to `/join/{code}/session/{session_id}/synthesis`
2. See themes, gap type with appropriate color, and attributed statements
3. From waiting page, when state becomes REVEALED, auto-redirect to synthesis
4. Direct access to synthesis URL with non-REVEALED session redirects appropriately
</verification>

<success_criteria>
- PART-11 satisfied: Participant can view synthesis when revealed
- Synthesis page is mobile-friendly (max-width 600px, responsive)
- Gap type has distinct color coding (Direction=blue, Alignment=orange, Commitment=green)
- Waiting page correctly redirects to synthesis on REVEALED state
</success_criteria>

<output>
After completion, create `.planning/phases/15-ai-synthesis/15-03-SUMMARY.md`
</output>
