# Phase 21: Combined QR + Status - Research

**Researched:** 2026-01-19
**Domain:** Projector-optimized UI with real-time updates
**Confidence:** HIGH

## Summary

Phase 21 combines two existing components into a single projectable view: the team QR code (already generated by `/admin/qr/team/{team_id}`) and the session participant status (already polled via `/admin/sessions/{session_id}/status`). The existing infrastructure handles both concerns well - this phase is primarily a layout and CSS exercise.

The key technical decisions are straightforward:
1. Create a new endpoint/template at `/admin/sessions/{session_id}/capture` for the combined view
2. Reuse existing QR generation (team-level, not session-level)
3. Adapt existing polling.js for the new template structure
4. Apply presentation-mode styling patterns already established in `present.html`

**Primary recommendation:** Build a new template that combines existing QR and status components, styled for projection with minimal JavaScript changes.

## Standard Stack

The established libraries/tools for this domain:

### Core (Already in Project)
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| qrcode | existing | QR code generation | Already used in `/admin/qr/` endpoints |
| FastAPI | existing | Endpoint routing | Project standard |
| Jinja2 | existing | Template rendering | Project standard |
| Vanilla JS | - | Polling/DOM updates | Project avoids frameworks |

### Supporting (Already in Project)
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| CSS variables | - | Theme consistency | All styling |
| fetch API | native | AJAX polling | Real-time updates |

### No New Dependencies Required
This phase requires NO new libraries. All functionality exists.

## Architecture Patterns

### Recommended Endpoint Structure
```
/admin/sessions/{session_id}/capture  -> Combined QR + Status view (NEW)
/admin/sessions/{session_id}/status   -> JSON status endpoint (EXISTS)
/admin/qr/team/{team_id}              -> QR code PNG (EXISTS)
```

### Template Organization
```
app/templates/admin/sessions/
├── view.html          # Existing control panel
├── present.html       # Existing synthesis presentation
├── capture.html       # NEW: Combined QR + status for projection
└── ...
```

### Pattern 1: Dual-Panel Projector Layout
**What:** Side-by-side QR code and status list optimized for projection
**When to use:** Capture phase when facilitator projects for room
**Example:**
```html
<!-- Source: Derived from present.html patterns -->
<div class="capture-container">
    <div class="capture-qr-panel">
        <img src="/admin/qr/team/{{ team.id }}"
             alt="Scan to join"
             class="capture-qr-code">
        <div class="capture-join-code">{{ team.code }}</div>
        <div class="capture-join-url">{{ base_url }}/join</div>
    </div>
    <div class="capture-status-panel" data-session-id="{{ session.id }}">
        <div class="capture-progress">
            <span id="submitted-count">{{ submitted_count }}</span>
            <span class="progress-divider">/</span>
            <span id="total-members">{{ total_members }}</span>
        </div>
        <div class="capture-member-list" id="member-status-list">
            {% for member in member_status %}
            <div class="capture-member" data-member-id="{{ member.id }}">
                <span class="member-name">{{ member.name }}</span>
                <span class="status-indicator {% if member.submitted %}submitted{% else %}waiting{% endif %}">
                    {% if member.submitted %}&#10003;{% else %}...{% endif %}
                </span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
```

### Pattern 2: Flicker-Free DOM Updates
**What:** Update only changed elements, not full innerHTML replacement
**When to use:** Real-time status polling
**Example:**
```javascript
// Source: Adapted from existing polling.js pattern
function updateMemberStatus(members) {
    members.forEach(member => {
        const item = document.querySelector(`[data-member-id="${member.id}"]`);
        if (!item) return;

        const indicator = item.querySelector('.status-indicator');
        if (!indicator) return;

        // Only update if state changed
        const isCurrentlySubmitted = indicator.classList.contains('submitted');
        if (member.submitted !== isCurrentlySubmitted) {
            if (member.submitted) {
                indicator.classList.remove('waiting');
                indicator.classList.add('submitted');
                indicator.textContent = '\u2713';  // Checkmark
            } else {
                indicator.classList.remove('submitted');
                indicator.classList.add('waiting');
                indicator.textContent = '...';
            }
        }
    });
}
```

### Pattern 3: High-Contrast Projector Styling
**What:** Dark background, high contrast colors for visibility from back of room
**When to use:** Any projectable view
**Example:**
```css
/* Source: Based on existing presentation-mode in main.css */
.capture-mode {
    background: #1a1a2e;
    color: #eaeaea;
    min-height: 100vh;
}

.capture-qr-code {
    width: 400px;
    height: 400px;
    background: white;
    padding: 16px;
    border-radius: 8px;
}

.status-indicator.submitted {
    color: #22c55e;  /* Bright green checkmark */
    font-weight: bold;
}

.status-indicator.waiting {
    color: rgba(255, 255, 255, 0.4);  /* Dim while waiting */
}
```

### Anti-Patterns to Avoid
- **Full page reload on status change:** Use targeted DOM updates instead
- **Replacing innerHTML of container:** Causes flicker; update individual elements
- **Small QR codes:** Must be 400px+ for scanning from back of room
- **Low contrast colors:** Projectors wash out subtle colors
- **Complex layouts:** Keep simple for readability at distance

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| QR code generation | Custom QR library | Existing `/admin/qr/team/{team_id}` | Already tested, handles error correction |
| Status polling | New polling mechanism | Adapt existing polling.js | 2.5s interval already established |
| Dark theme | New CSS variables | Existing `.presentation-mode` patterns | Consistency with present.html |
| Member status tracking | Custom state logic | Existing `/admin/sessions/{id}/status` | Returns exactly what's needed |

**Key insight:** This phase is 95% layout/styling and 5% wiring existing components together.

## Common Pitfalls

### Pitfall 1: QR Code Too Small for Room
**What goes wrong:** QR code renders at default size, unreadable from back of conference room
**Why it happens:** Default `<img>` sizing doesn't account for projection distance
**How to avoid:** Explicitly set `width: 400px; height: 400px;` minimum on QR image
**Warning signs:** QR code looks fine on laptop but fails in live session

### Pitfall 2: Status Flicker on Poll
**What goes wrong:** Visible flash/flicker when status updates
**Why it happens:** Replacing entire list content instead of updating individual elements
**How to avoid:** Use targeted DOM updates (querySelector by member ID, toggle classes)
**Warning signs:** Test with Network tab throttled to see timing

### Pitfall 3: Projector Color Washout
**What goes wrong:** Subtle colors (grays, pastels) become invisible on projected display
**Why it happens:** Projectors have limited dynamic range
**How to avoid:** Use high-contrast colors: bright green (#22c55e), pure white, dark backgrounds
**Warning signs:** Status indicators hard to distinguish in presentation mode

### Pitfall 4: Missing Team Context for QR
**What goes wrong:** Session endpoint tries to access team.id but team not loaded
**Why it happens:** Session route doesn't eager-load team relationship
**How to avoid:** Ensure query includes team relationship: `session.team.id` for QR URL
**Warning signs:** AttributeError or extra database query per request

### Pitfall 5: Polling Continues After State Change
**What goes wrong:** Polling keeps running after session moves to CLOSED
**Why it happens:** No state change detection
**How to avoid:** Check `data.state` in poll response; reload page if changed from 'capturing'
**Warning signs:** Existing polling.js already handles this - don't break it

## Code Examples

Verified patterns from existing codebase:

### Existing QR Code Display (from edit.html)
```html
<!-- Source: /var/www/the55/app/templates/admin/teams/edit.html -->
<div class="qr-display">
    <img src="/admin/qr/team/{{ team.id }}"
         alt="QR Code for {{ team.code }}"
         class="qr-image">
</div>
<div class="qr-code-text">
    <code>{{ team.code }}</code>
</div>
```

### Existing Session Status Endpoint Response
```json
// Source: /admin/sessions/{session_id}/status endpoint
{
    "session_id": 123,
    "state": "capturing",
    "total_members": 8,
    "submitted_count": 5,
    "members": [
        {"id": 1, "name": "Alice", "submitted": true},
        {"id": 2, "name": "Bob", "submitted": false},
        // ...
    ],
    "has_synthesis": false,
    "synthesis_pending": false
}
```

### Existing Polling Pattern
```javascript
// Source: /var/www/the55/static/js/polling.js
const POLL_INTERVAL = 2500;
const sessionId = container.dataset.sessionId;

async function pollStatus() {
    const response = await fetch(`/admin/sessions/${sessionId}/status`);
    const data = await response.json();

    // State change detection - triggers reload
    if (lastState !== null && lastState !== data.state) {
        window.location.reload();
        return;
    }
    lastState = data.state;

    // Update UI
    updateMemberStatus(data.members);
    updateStats(data.submitted_count, data.total_members);
}

setInterval(pollStatus, POLL_INTERVAL);
```

### Existing Presentation Mode Styling
```css
/* Source: /var/www/the55/app/static/css/main.css lines 1514-1640 */
.presentation-mode {
    background: #1a1a2e;
    color: #eaeaea;
    min-height: 100vh;
}

.presentation-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: var(--space-8);
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| WebSocket for real-time | Polling (2.5s) | Project decision | Simpler, proven reliable |
| Full page refresh | Targeted DOM updates | Phase 13 | No flicker |
| Session-specific QR | Team-level QR | Project design | One QR works for all sessions |

**Design decisions already made:**
- QR codes use ERROR_CORRECT_M for display (confirmed in qr.py line 47)
- 2.5 second polling interval (confirmed in polling.js line 11)
- Presentation mode uses dark theme (confirmed in present.html)
- Auth required for admin endpoints (confirmed via AuthDep in sessions.py)

## Implementation Approach

### Task Breakdown (Recommended)
1. **New endpoint:** Add `GET /admin/sessions/{session_id}/capture` route in sessions.py
2. **New template:** Create `capture.html` with dual-panel layout
3. **CSS additions:** Add `.capture-mode` styles to main.css
4. **Link integration:** Add "Capture View" button to session view.html during CAPTURING state
5. **Test:** Verify QR scannable at 400px, status updates without flicker

### CSS Structure for Capture View
```css
/* Capture mode (projectable) */
.capture-mode {
    background: #1a1a2e;
    color: #eaeaea;
    min-height: 100vh;
}

.capture-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-8);
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--space-8);
    min-height: 100vh;
    align-items: center;
}

/* QR Panel */
.capture-qr-panel {
    text-align: center;
}

.capture-qr-code {
    width: 400px;
    height: 400px;
    background: white;
    padding: 16px;
    border-radius: 8px;
}

.capture-join-code {
    font-size: 3rem;
    font-weight: 700;
    letter-spacing: 0.2em;
    margin-top: var(--space-6);
}

.capture-join-url {
    color: rgba(255, 255, 255, 0.6);
    margin-top: var(--space-2);
}

/* Status Panel */
.capture-status-panel {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: var(--space-6);
}

.capture-progress {
    font-size: 4rem;
    font-weight: 700;
    text-align: center;
    margin-bottom: var(--space-6);
}

.capture-member-list {
    max-height: 60vh;
    overflow-y: auto;
}

.capture-member {
    display: flex;
    justify-content: space-between;
    padding: var(--space-3) var(--space-4);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    font-size: 1.25rem;
}

.capture-member .status-indicator.submitted {
    color: #22c55e;
    font-weight: bold;
}

.capture-member .status-indicator.waiting {
    color: rgba(255, 255, 255, 0.3);
}
```

## Open Questions

Things that couldn't be fully resolved:

1. **Exit button placement**
   - What we know: present.html has footer exit link
   - What's unclear: Should capture view have visible exit or keyboard-only (F)?
   - Recommendation: Add subtle footer exit link matching present.html pattern

2. **Team name display**
   - What we know: Room needs context which session this is for
   - What's unclear: How prominent should team/session info be?
   - Recommendation: Small header with "Team Name - Session Month"

3. **Mobile responsiveness for capture view**
   - What we know: This is a projector view, likely from laptop
   - What's unclear: Need for responsive design?
   - Recommendation: Desktop-only, single breakpoint collapse to stacked layout

## Sources

### Primary (HIGH confidence)
- `/var/www/the55/app/routers/qr.py` - QR generation implementation
- `/var/www/the55/app/routers/sessions.py` - Session status endpoint
- `/var/www/the55/static/js/polling.js` - Polling implementation
- `/var/www/the55/app/static/css/main.css` - Presentation mode styles
- `/var/www/the55/app/templates/admin/sessions/view.html` - Member status list pattern
- `/var/www/the55/app/templates/admin/sessions/present.html` - Projection styling pattern
- `/var/www/the55/app/templates/admin/teams/edit.html` - QR display pattern

### Secondary (MEDIUM confidence)
- Project STATE.md decisions (QR error correction, polling interval)

### Tertiary (LOW confidence)
- None - all patterns verified in codebase

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - All components exist in codebase
- Architecture: HIGH - Clear patterns from existing templates
- Pitfalls: HIGH - Based on existing implementation patterns

**Research date:** 2026-01-19
**Valid until:** Indefinite (internal codebase patterns)
