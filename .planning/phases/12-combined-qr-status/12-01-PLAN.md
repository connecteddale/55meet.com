---
phase: 21-combined-qr-status
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - the55/app/routers/sessions.py
  - the55/app/templates/admin/sessions/capture.html
  - the55/app/static/css/main.css
  - the55/app/templates/admin/sessions/view.html
autonomous: true

must_haves:
  truths:
    - "Facilitator sees QR code and participant status on single projectable screen"
    - "QR code is 400px+ and scannable from back of room"
    - "Status shows submitted/not-submitted with green checkmark vs dimmed waiting indicator"
    - "Status updates in real-time without screen flicker (2.5s polling)"
  artifacts:
    - path: "the55/app/templates/admin/sessions/capture.html"
      provides: "Dual-panel capture view template"
      min_lines: 40
    - path: "the55/app/routers/sessions.py"
      provides: "Capture view endpoint"
      contains: "capture"
    - path: "the55/app/static/css/main.css"
      provides: "Capture mode styles"
      contains: ".capture-mode"
  key_links:
    - from: "the55/app/templates/admin/sessions/capture.html"
      to: "/admin/sessions/{session_id}/status"
      via: "polling.js"
      pattern: "polling\\.js"
    - from: "the55/app/templates/admin/sessions/view.html"
      to: "/admin/sessions/{session_id}/capture"
      via: "navigation link"
      pattern: "/capture"
---

<objective>
Create a combined QR + status projectable screen for the session capture phase.

Purpose: Facilitators need a single screen to project during response collection that shows both the QR code for participants to join AND the real-time submission status. Currently these are separate views.

Output: New `/admin/sessions/{session_id}/capture` endpoint with projector-optimized dual-panel template showing QR code (left) and participant status list (right) with real-time polling updates.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-combined-qr-status/21-RESEARCH.md

# Source files to reference
@the55/app/routers/sessions.py
@the55/app/templates/admin/sessions/present.html
@the55/app/templates/admin/sessions/view.html
@the55/static/js/polling.js
@the55/app/static/css/main.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create capture endpoint and template</name>
  <files>
    the55/app/routers/sessions.py
    the55/app/templates/admin/sessions/capture.html
  </files>
  <action>
Add new endpoint to sessions.py:
```python
@router.get("/{session_id}/capture")
async def capture_session(request: Request, session_id: int, auth: AuthDep, db: DbDep):
    """Projector-friendly capture view with QR code and status."""
    session = db.query(Session).filter(Session.id == session_id).first()
    if not session:
        raise HTTPException(status_code=404, detail="Session not found")

    # Only show in CAPTURING state (redirect otherwise)
    if session.state != SessionState.CAPTURING:
        return RedirectResponse(url=f"/admin/sessions/{session_id}", status_code=303)

    team = session.team
    members = db.query(Member).filter(Member.team_id == team.id).order_by(Member.name).all()

    # Get response status for each member
    responses = db.query(Response).filter(Response.session_id == session_id).all()
    responded_member_ids = {r.member_id for r in responses}

    member_status = []
    for member in members:
        member_status.append({
            "id": member.id,
            "name": member.name,
            "submitted": member.id in responded_member_ids
        })

    return templates.TemplateResponse(
        "admin/sessions/capture.html",
        {
            "request": request,
            "session": session,
            "team": team,
            "member_status": member_status,
            "total_members": len(members),
            "submitted_count": len(responded_member_ids)
        }
    )
```

Create capture.html template with dual-panel layout:
- Extends base.html with presentation-mode body class
- Left panel: Large QR code (400px), team code text, join URL
- Right panel: Progress counter (X/Y), member list with status indicators
- Include polling.js for real-time updates
- Use `data-session-id` attribute for polling and `.capture-control` class (similar to view.html's `.session-control`)
- Add subtle footer exit link back to session view (matches present.html pattern)

Template structure:
```html
{% extends "base.html" %}
{% block body_class %} class="capture-mode"{% endblock %}
{% block header %}{% endblock %}
{% block content %}
<div class="capture-control" data-session-id="{{ session.id }}">
  <div class="capture-container">
    <!-- QR Panel (left) -->
    <div class="capture-qr-panel">
      <img src="/admin/qr/team/{{ team.id }}" alt="Scan to join" class="capture-qr-code">
      <div class="capture-join-code">{{ team.code }}</div>
      <div class="capture-join-url">Scan QR or visit /join</div>
    </div>
    <!-- Status Panel (right) -->
    <div class="capture-status-panel">
      <div class="capture-progress">
        <span id="submitted-count">{{ submitted_count }}</span>/<span id="total-members">{{ total_members }}</span>
      </div>
      <div class="capture-member-list" id="member-status-list">
        {% for member in member_status %}
        <div class="capture-member" data-member-id="{{ member.id }}">
          <span class="member-name">{{ member.name }}</span>
          <span class="status-indicator {% if member.submitted %}submitted{% else %}waiting{% endif %}">
            {% if member.submitted %}&#10003;{% else %}...{% endif %}
          </span>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  <div class="capture-footer">
    <a href="/admin/sessions/{{ session.id }}" class="exit-capture">Exit to Control Panel</a>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script src="/static/js/polling.js"></script>
{% endblock %}
```
  </action>
  <verify>
Visit http://localhost:8055/admin/sessions/{id}/capture while session is in CAPTURING state - should show dual-panel layout. Non-CAPTURING state should redirect to session view.
  </verify>
  <done>
Capture view endpoint exists and renders dual-panel template with QR code and participant status list.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add capture mode CSS styles</name>
  <files>
    the55/app/static/css/main.css
  </files>
  <action>
Add capture mode styles after the existing presentation mode section (around line 1640). These are projector-optimized styles with high contrast colors.

```css
/* ========================================
   Capture Mode (QR + Status Projectable)
   ======================================== */

.capture-mode {
    background: #1a1a2e;
    color: #eaeaea;
    min-height: 100vh;
}

.capture-control {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

.capture-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-8);
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--space-8);
    flex: 1;
    align-items: center;
}

/* QR Panel (left side) */
.capture-qr-panel {
    text-align: center;
}

.capture-qr-code {
    width: 400px;
    height: 400px;
    background: white;
    padding: 16px;
    border-radius: 8px;
}

.capture-join-code {
    font-size: 3rem;
    font-weight: 700;
    letter-spacing: 0.2em;
    margin-top: var(--space-6);
    text-transform: uppercase;
}

.capture-join-url {
    color: rgba(255, 255, 255, 0.5);
    margin-top: var(--space-2);
    font-size: 1.125rem;
}

/* Status Panel (right side) */
.capture-status-panel {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: var(--space-6);
    max-height: 80vh;
    display: flex;
    flex-direction: column;
}

.capture-progress {
    font-size: 4rem;
    font-weight: 700;
    text-align: center;
    margin-bottom: var(--space-6);
    padding-bottom: var(--space-4);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.capture-member-list {
    overflow-y: auto;
    flex: 1;
}

.capture-member {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3) var(--space-4);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    font-size: 1.25rem;
}

.capture-member:last-child {
    border-bottom: none;
}

.capture-member .member-name {
    color: #eaeaea;
}

.capture-member .status-indicator.submitted {
    color: #22c55e;  /* Bright green - visible on projector */
    font-weight: bold;
    font-size: 1.5rem;
}

.capture-member .status-indicator.waiting {
    color: rgba(255, 255, 255, 0.3);
    font-size: 1rem;
}

/* Footer exit link */
.capture-footer {
    text-align: center;
    padding: var(--space-4);
}

.exit-capture {
    color: rgba(255, 255, 255, 0.4);
    font-size: var(--font-size-sm);
}

.exit-capture:hover {
    color: rgba(255, 255, 255, 0.7);
}

/* Responsive: Stack on narrower screens */
@media (max-width: 900px) {
    .capture-container {
        grid-template-columns: 1fr;
        gap: var(--space-6);
    }

    .capture-qr-code {
        width: 300px;
        height: 300px;
    }

    .capture-progress {
        font-size: 3rem;
    }
}
```

Key design decisions:
- 400px QR code for scannability from back of room (FAC-10)
- Bright green (#22c55e) checkmark for submitted - high contrast for projectors
- Dim waiting indicator to draw attention to incomplete participants
- Large progress counter (4rem) visible from distance
- Dark background (#1a1a2e) matches existing presentation mode
  </action>
  <verify>
With browser DevTools, apply `.capture-mode` class to body and verify styles load. Check QR code shows at 400px, status indicators are high contrast.
  </verify>
  <done>
Capture mode CSS styles added with 400px+ QR, high-contrast status indicators, and projector-optimized dark theme.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add capture view link and verify polling</name>
  <files>
    the55/app/templates/admin/sessions/view.html
    the55/static/js/polling.js
  </files>
  <action>
1. Update view.html to add "Capture View" button during CAPTURING state.

In the session-controls section, after the "Close Capture" button for capturing state, add:
```html
{% elif session.state.value == 'capturing' %}
<form method="post" action="/admin/sessions/{{ session.id }}/close"
      onsubmit="return confirm('Close capture? Participants will no longer be able to submit.');">
    <button type="submit" class="btn btn-warning btn-large">
        Close Capture
    </button>
</form>
<p class="control-hint">Close when all participants have submitted.</p>

<!-- ADD THIS: Capture view for projection -->
<div class="session-actions" style="margin-top: var(--space-4);">
    <a href="/admin/sessions/{{ session.id }}/capture" class="btn btn-primary">
        Capture View (Project)
    </a>
</div>
```

2. Update polling.js to support the capture view by looking for EITHER `.session-control` OR `.capture-control`:

Change line ~12 from:
```javascript
const container = document.querySelector('.session-control');
```
To:
```javascript
const container = document.querySelector('.session-control') || document.querySelector('.capture-control');
```

This allows polling.js to work on both the control panel (view.html) and the capture view (capture.html).

3. Also update the updateMemberStatus function to handle both text content formats:
- view.html shows "Submitted" / "Waiting..."
- capture.html shows checkmark / "..."

Update the function to detect which format is needed:
```javascript
function updateMemberStatus(members) {
    const list = document.getElementById('member-status-list');
    if (!list) return;

    // Detect if we're in capture mode (checkmark style) or control mode (text style)
    const isCaptureMode = document.body.classList.contains('capture-mode');

    members.forEach(member => {
        const item = list.querySelector(`[data-member-id="${member.id}"]`);
        if (!item) return;

        const indicator = item.querySelector('.status-indicator');
        if (!indicator) return;

        if (member.submitted) {
            indicator.classList.remove('waiting');
            indicator.classList.add('submitted');
            indicator.textContent = isCaptureMode ? '\u2713' : 'Submitted';
        } else {
            indicator.classList.remove('submitted');
            indicator.classList.add('waiting');
            indicator.textContent = isCaptureMode ? '...' : 'Waiting...';
        }
    });
}
```
  </action>
  <verify>
1. Visit session view in CAPTURING state - "Capture View (Project)" button appears
2. Click button - navigates to /capture view with dual-panel layout
3. Have a participant submit - status updates in real-time without page flicker on BOTH views
4. QR code scans successfully from capture view
  </verify>
  <done>
Capture view accessible from session control panel, polling works on both views with appropriate indicator formatting.
  </done>
</task>

</tasks>

<verification>
1. Create or use existing test session in CAPTURING state
2. From session view page, click "Capture View (Project)" button
3. Verify dual-panel layout: QR code (left), status list (right)
4. Verify QR code is 400px (measure with DevTools)
5. Scan QR code with phone - should navigate to join page with team code prefilled
6. Have participant submit response
7. Watch capture view - status should update to green checkmark within 2.5 seconds (no page reload)
8. Click "Exit to Control Panel" - returns to session view
9. Session in non-CAPTURING state should redirect from /capture back to /view
</verification>

<success_criteria>
- FAC-09: QR code and participant status display on single screen - VERIFIED
- FAC-10: QR code is 400px+ and scannable from back of room - VERIFIED by DevTools measurement
- FAC-11: Status shows submitted/not-submitted with visual indicators (green checkmark vs dim "...") - VERIFIED
- Real-time updates without flicker (2.5s polling) - VERIFIED by watching status change
</success_criteria>

<output>
After completion, create `.planning/phases/21-combined-qr-status/21-01-SUMMARY.md`
</output>
