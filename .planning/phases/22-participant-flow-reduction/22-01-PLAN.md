---
phase: 35-participant-flow-reduction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sites/55meet.com/app/routers/participant.py
autonomous: true

must_haves:
  truths:
    - "Visiting /join/TEAMCODE auto-validates and redirects to session/name without showing join form"
    - "If team has exactly one CAPTURING session, month selection is skipped entirely"
    - "Old /join/{code}/session/{id}/member/{mid}/strategy URL redirects to respond page"
  artifacts:
    - path: "sites/55meet.com/app/routers/participant.py"
      provides: "Auto-join route, auto-skip logic, strategy redirect"
      contains: "router.get.*/{code}"
  key_links:
    - from: "GET /join/{code}"
      to: "/join/{code}/session/{id}/name"
      via: "auto-skip when single CAPTURING session"
      pattern: "len.*sessions.*== 1"
    - from: "GET /join/{code}/session/{id}/member/{mid}/strategy"
      to: "/join/{code}/session/{id}/member/{mid}/respond"
      via: "RedirectResponse"
      pattern: "RedirectResponse.*respond"
---

<objective>
Optimize participant route logic to eliminate unnecessary screens.

Purpose: Reduce participant flow from 5+ taps to 2-3 by auto-joining from URL, skipping month when only one session is active, and redirecting the strategy screen to the respond page.
Output: Updated participant.py with auto-join, auto-skip, and strategy redirect logic.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@sites/55meet.com/app/routers/participant.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Auto-join and auto-skip route logic</name>
  <files>sites/55meet.com/app/routers/participant.py</files>
  <action>
  Modify the participant router with these three changes:

  1. **Auto-join (FLOW-01):** Change `GET /join/{code}` route behavior. Currently `GET /join` shows a form and `GET /join` with `code` query param pre-fills it. Add a NEW route `GET /join/{code}` that:
     - Validates the code (uppercase, strip whitespace)
     - Queries Team by code
     - If team not found, redirects to `/join` with no error (let user try manually)
     - If team found, queries CAPTURING sessions
     - If no active sessions, redirects to `/join` (let user see error via form)
     - If sessions found, proceeds to auto-skip logic (step 2)

  2. **Auto-skip month (FLOW-02):** In the new `GET /join/{code}` route AND in the existing `select_session_form` handler:
     - After getting CAPTURING sessions, check `len(sessions) == 1`
     - If exactly one session: redirect directly to `/join/{code}/session/{sessions[0].id}/name` (skip month picker)
     - If multiple sessions: redirect to `/join/{code}/session` (show month picker as before)
     - The existing `select_session_form` should ALSO apply this logic — if user lands on session page but only 1 session exists, redirect to name.

  3. **Strategy redirect (FLOW-03):** Change the `show_strategy` handler (`GET /{code}/session/{session_id}/member/{member_id}/strategy`):
     - Instead of rendering strategy.html template, issue a `RedirectResponse` to the respond URL: `/join/{code}/session/{session_id}/member/{member_id}/respond`
     - Keep the route registered (old bookmarks/links still work)
     - Status code 303 (same as other redirects in this file)

  Also update the `select_name` POST handler: currently it redirects to `.../strategy`. Change to redirect to `.../respond` instead, since strategy is now merged into the respond page.

  Important: Keep all validation logic (team exists, session in CAPTURING, member belongs to team) in the new route. Do NOT remove any existing routes — just modify behavior.
  </action>
  <verify>
  Run the app and test:
  - `curl -s -o /dev/null -w "%{http_code} %{redirect_url}" http://localhost:8000/join/TESTCODE` should return 303 with redirect to session or name URL
  - `curl -s -o /dev/null -w "%{http_code} %{redirect_url}" http://localhost:8000/join/INVALID` should return 303 redirect to /join
  - Strategy URL should return 303 redirect to respond URL
  - Python syntax check: `python -c "import sites.55meet_com.app.routers.participant"` or just check with `python -m py_compile sites/55meet.com/app/routers/participant.py`
  </verify>
  <done>
  - GET /join/{code} validates team and redirects: single session -> name page, multiple sessions -> session picker
  - GET /join/{code}/session shows month picker only if 2+ CAPTURING sessions, otherwise auto-redirects to name
  - GET .../strategy redirects to .../respond (303)
  - POST .../name redirects to .../respond (not .../strategy)
  - All existing validation preserved (invalid codes, missing teams, closed sessions)
  </done>
</task>

</tasks>

<verification>
- Python compiles without errors: `python -m py_compile sites/55meet.com/app/routers/participant.py`
- Auto-join route exists and handles valid/invalid codes
- Single-session teams skip month picker
- Strategy route issues redirect, not template render
- Name POST redirects to respond, not strategy
</verification>

<success_criteria>
- Participant with team code in URL goes from scan to name selection in one redirect (single session) or to month picker (multiple sessions)
- Strategy screen is bypassed entirely — old URLs redirect to respond page
- No broken routes, all validation intact
</success_criteria>

<output>
After completion, create `.planning/phases/35-participant-flow-reduction/35-01-SUMMARY.md`
</output>
