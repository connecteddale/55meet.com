---
phase: 19-participant-image-browser
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - the55/app/templates/participant/respond.html
  - the55/app/static/css/main.css
autonomous: true

must_haves:
  truths:
    - "Participant can see page indicator (e.g., 'Page 3 of 12') at all times while scrolling"
    - "Participant can tap Next/Previous at any scroll position without scrolling back up"
    - "Participant sees instruction text ('Select an image...') while browsing images"
    - "Images load via AJAX without full page reload when changing pages"
    - "Sticky header works on iOS Safari (no content hidden behind header)"
  artifacts:
    - path: "the55/app/templates/participant/respond.html"
      provides: "Updated image browser with sticky header and AJAX pagination"
      contains: "sticky-header"
    - path: "the55/app/static/css/main.css"
      provides: "Sticky positioning CSS with iOS Safari compatibility"
      contains: "-webkit-sticky"
  key_links:
    - from: "respond.html JavaScript"
      to: "/api/images?page=N&seed=SESSION_ID"
      via: "fetch in loadPage()"
      pattern: "fetch.*api/images"
    - from: "sticky-header"
      to: "body"
      via: "CSS sticky positioning"
      pattern: "position:\\s*sticky|position:\\s*-webkit-sticky"
---

<objective>
Update the participant image browser to use sticky navigation with always-visible pagination controls and instruction header.

Purpose: With 200+ images across 10+ pages, participants need persistent navigation. Currently they must scroll back to top to change pages. This creates friction during the 55-minute session.

Output:
- Sticky header containing instruction text + pagination controls
- AJAX-based page loading (no full reload on page change)
- Page state persistence in sessionStorage (survives refresh)
- iOS Safari compatible sticky positioning
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-image-library-foundation/18-01-SUMMARY.md
@.planning/research/PITFALLS.md

Key pitfalls to address (from PITFALLS.md):
- IG-1: iOS Safari sticky requires -webkit-sticky prefix AND no overflow:hidden on ancestors
- IG-2: Pagination state lost on refresh - persist to sessionStorage
- IG-4: Avoid swipe gestures - use explicit Previous/Next buttons

API from Phase 18:
- GET /api/images?page=1&per_page=20&seed=SESSION_ID
- Returns: {images: [{id, filename, url}], total, page, per_page, total_pages}
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sticky header CSS with iOS Safari compatibility</name>
  <files>the55/app/static/css/main.css</files>
  <action>
Add CSS for sticky image browser header with iOS Safari compatibility.

Add these styles to main.css after the existing `.image-browser` section:

```css
/* ========================================
   Image Browser - Sticky Header (Phase 19)
   ======================================== */

/* Sticky header container - instructions + pagination */
.image-browser-sticky {
  position: -webkit-sticky;  /* iOS Safari (IG-1) */
  position: sticky;
  top: 0;
  z-index: 100;
  background: var(--color-bg);
  padding: var(--space-3) var(--space-4);
  margin: 0 calc(-1 * var(--space-4));  /* Extend to edges */
  border-bottom: 1px solid var(--color-border);
  /* Force GPU layer to reduce iOS flickering (IG-1) */
  transform: translate3d(0, 0, 0);
  -webkit-transform: translate3d(0, 0, 0);
}

.browser-instruction {
  text-align: center;
  margin-bottom: var(--space-3);
}

.browser-instruction p {
  color: var(--color-text-muted);
  font-size: var(--font-size-sm);
  margin: 0;
}

/* Pagination in sticky header */
.pagination-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: var(--space-2);
}

.pagination-header .pagination-btn {
  flex-shrink: 0;
}

.page-indicator {
  text-align: center;
  flex: 1;
  font-weight: 600;
  color: var(--color-text);
  font-size: var(--font-size-base);
}

/* Jump to selection button */
.jump-to-selection {
  display: none;
  margin-top: var(--space-2);
  text-align: center;
}

.jump-to-selection.visible {
  display: block;
}

.jump-to-selection button {
  font-size: var(--font-size-sm);
  color: var(--color-primary);
  background: transparent;
  border: 1px solid var(--color-primary);
  padding: var(--space-1) var(--space-2);
  border-radius: 4px;
  cursor: pointer;
}

.jump-to-selection button:hover {
  background: var(--color-primary);
  color: white;
}

/* Image grid adjustments for sticky header */
.image-grid-container {
  padding-top: var(--space-4);
}

/* Loading state for AJAX */
.image-page-loading {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 200px;
}

.image-page-loading .spinner {
  width: 32px;
  height: 32px;
  border: 3px solid var(--color-border);
  border-top-color: var(--color-primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

/* Ensure no overflow:hidden on image-browser (IG-1) */
.image-browser {
  overflow: visible;  /* Required for sticky to work */
}
```

CRITICAL for iOS Safari (IG-1):
- Use both -webkit-sticky and sticky
- Use transform: translate3d(0, 0, 0) for GPU acceleration
- Ensure .image-browser has overflow: visible (not hidden)
  </action>
  <verify>
1. grep -n "webkit-sticky" the55/app/static/css/main.css
2. grep -n "translate3d" the55/app/static/css/main.css
3. grep -n "overflow: visible" the55/app/static/css/main.css
All three should return matches.
  </verify>
  <done>CSS includes -webkit-sticky, translate3d GPU hack, and overflow:visible for iOS compatibility</done>
</task>

<task type="auto">
  <name>Task 2: Update respond.html with sticky header and AJAX pagination</name>
  <files>the55/app/templates/participant/respond.html</files>
  <action>
Rewrite respond.html to use:
1. Sticky header with instruction + pagination controls
2. AJAX-based page loading via /api/images endpoint
3. sessionStorage for page state persistence (IG-2)
4. Explicit Previous/Next buttons (avoiding swipe - IG-4)

Replace the entire file with this updated version:

```html
{% extends "base.html" %}

{% block title %}Select an Image - The 55{% endblock %}

{% block header %}
<header class="participant-header">
    <div class="container">
        <h1>The 55</h1>
        <span class="team-badge">{{ team.team_name }}</span>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="image-browser">
    <!-- Sticky Header: Instructions + Pagination -->
    <div class="image-browser-sticky">
        <div class="browser-instruction">
            <h2>Select an Image, {{ member.name }}</h2>
            <p>Choose the image that best represents how you feel about where your team is in executing the strategy.</p>
        </div>
        <div class="pagination-header">
            <button type="button" id="prev-btn" class="pagination-btn" disabled aria-label="Previous page">
                <span class="pagination-arrow">&larr;</span> Prev
            </button>
            <span class="page-indicator" id="page-indicator">Page 1 of 1</span>
            <button type="button" id="next-btn" class="pagination-btn" aria-label="Next page">
                Next <span class="pagination-arrow">&rarr;</span>
            </button>
        </div>
        <div class="jump-to-selection" id="jump-to-selection">
            <button type="button" onclick="jumpToSelection()">Jump to your selection</button>
        </div>
    </div>

    <form id="respond-form" method="POST" action="/join/{{ team.code }}/session/{{ session.id }}/member/{{ member.id }}/respond">
        <!-- Hidden inputs for form submission -->
        <input type="hidden" name="image_number" id="selected-image" value="{% if existing_response %}{{ existing_response.image_number }}{% endif %}">
        <input type="hidden" name="bullets" id="bullets-json" value="{% if existing_response %}{{ existing_response.bullets }}{% else %}[]{% endif %}">

        <!-- Image Grid Container (loaded via AJAX) -->
        <div class="image-grid-container" id="image-grid-container">
            <div class="image-page active" id="image-page">
                <!-- Images loaded via JavaScript -->
            </div>
        </div>

        <!-- Bullet Point Section (shown after image selection) -->
        <div class="bullet-section" id="bullet-section" style="display: none;">
            <h3>Why does this image represent where you are?</h3>
            <p>Enter 1-5 bullet points explaining your choice.</p>

            {% if error %}
            <div class="form-error">{{ error }}</div>
            {% endif %}

            <div class="bullet-inputs">
                <input type="text"
                       class="bullet-input"
                       id="bullet-1"
                       placeholder="Bullet point 1 (required)"
                       maxlength="500"
                       required>
                <input type="text"
                       class="bullet-input"
                       id="bullet-2"
                       placeholder="Bullet point 2 (optional)"
                       maxlength="500">
                <input type="text"
                       class="bullet-input"
                       id="bullet-3"
                       placeholder="Bullet point 3 (optional)"
                       maxlength="500">
                <input type="text"
                       class="bullet-input"
                       id="bullet-4"
                       placeholder="Bullet point 4 (optional)"
                       maxlength="500">
                <input type="text"
                       class="bullet-input"
                       id="bullet-5"
                       placeholder="Bullet point 5 (optional)"
                       maxlength="500">
            </div>
        </div>

        <!-- Submit Button -->
        <div class="submit-section" id="submit-section">
            <button type="submit" id="submit-btn" class="btn-submit" disabled>
                Submit Response
            </button>
            <p class="selection-hint" id="selection-hint">Select an image to continue</p>
        </div>
    </form>
</div>

<script>
(function() {
    'use strict';

    // Configuration from server
    const sessionId = {{ session.id }};
    const memberId = {{ member.id }};
    const teamCode = "{{ team.code }}";
    const perPage = {{ per_page }};

    // State
    let currentPage = 1;
    let totalPages = 1;
    let selectedImageId = null;
    let selectedImagePage = null;
    let loadedPages = new Map();  // page -> images array
    const storageKey = `image-browser-${sessionId}-${memberId}`;
    const draftKey = `draft-${sessionId}-${memberId}`;

    // DOM Elements
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const pageIndicator = document.getElementById('page-indicator');
    const imagePage = document.getElementById('image-page');
    const jumpSection = document.getElementById('jump-to-selection');
    const selectedImageInput = document.getElementById('selected-image');
    const bulletsJsonInput = document.getElementById('bullets-json');
    const submitBtn = document.getElementById('submit-btn');
    const selectionHint = document.getElementById('selection-hint');
    const bulletSection = document.getElementById('bullet-section');
    const bulletInputs = [
        document.getElementById('bullet-1'),
        document.getElementById('bullet-2'),
        document.getElementById('bullet-3'),
        document.getElementById('bullet-4'),
        document.getElementById('bullet-5')
    ];
    const respondForm = document.getElementById('respond-form');

    // ========================================
    // Page Loading (AJAX)
    // ========================================

    async function loadPage(pageNum) {
        // Show loading state
        imagePage.innerHTML = '<div class="image-page-loading"><div class="spinner"></div></div>';

        try {
            const url = `/api/images?page=${pageNum}&per_page=${perPage}&seed=${sessionId}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to load images');

            const data = await response.json();
            totalPages = data.total_pages;

            // Cache the page
            loadedPages.set(pageNum, data.images);

            // Render images
            renderPage(data.images);

            // Update pagination
            updatePagination(pageNum);

            // Save state to sessionStorage (IG-2)
            savePageState(pageNum);

        } catch (error) {
            console.error('Error loading images:', error);
            imagePage.innerHTML = '<p class="error">Failed to load images. Please refresh the page.</p>';
        }
    }

    function renderPage(images) {
        // Build grid HTML
        const html = images.map((img, idx) => {
            const isSelected = img.id === selectedImageId;
            const imgNum = img.id;  // Use image ID for backward compatibility
            return `
                <div class="image-card ${isSelected ? 'selected' : ''}"
                     data-image="${imgNum}"
                     role="button"
                     tabindex="0"
                     aria-label="Image ${imgNum}">
                    <img src="${img.url}"
                         alt="Image ${imgNum}"
                         loading="${idx < 6 ? 'eager' : 'lazy'}">
                    <span class="image-number">${imgNum}</span>
                </div>
            `;
        }).join('');

        imagePage.innerHTML = html;
        imagePage.classList.add('active');

        // Attach event handlers to new cards
        attachCardHandlers();
    }

    function attachCardHandlers() {
        const cards = imagePage.querySelectorAll('.image-card');
        cards.forEach(card => {
            card.addEventListener('click', function() {
                const imageId = this.dataset.image;
                selectImage(imageId);
            });
            card.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    const imageId = this.dataset.image;
                    selectImage(imageId);
                }
            });
        });
    }

    function updatePagination(pageNum) {
        currentPage = pageNum;
        pageIndicator.textContent = `Page ${pageNum} of ${totalPages}`;
        prevBtn.disabled = pageNum <= 1;
        nextBtn.disabled = pageNum >= totalPages;

        // Show "jump to selection" if selection is on different page
        if (selectedImagePage && selectedImagePage !== pageNum) {
            jumpSection.classList.add('visible');
        } else {
            jumpSection.classList.remove('visible');
        }
    }

    // ========================================
    // State Persistence (IG-2)
    // ========================================

    function savePageState(pageNum) {
        try {
            sessionStorage.setItem(storageKey, JSON.stringify({
                page: pageNum,
                selectedId: selectedImageId,
                selectedPage: selectedImagePage
            }));
        } catch (e) {
            // Ignore storage errors
        }
    }

    function loadPageState() {
        try {
            const saved = sessionStorage.getItem(storageKey);
            if (saved) {
                const state = JSON.parse(saved);
                if (state.selectedId) {
                    selectedImageId = state.selectedId;
                    selectedImagePage = state.selectedPage;
                }
                return state.page || 1;
            }
        } catch (e) {
            // Ignore
        }
        return 1;
    }

    // ========================================
    // Draft Persistence
    // ========================================

    function loadDraft() {
        try {
            const draft = JSON.parse(localStorage.getItem(draftKey));
            if (draft) {
                if (draft.image && !selectedImageInput.value) {
                    selectedImageId = draft.image;
                    selectedImageInput.value = draft.image;
                    // We'll find the page when we load
                }
                if (draft.bullets && draft.bullets.length > 0) {
                    draft.bullets.forEach((bullet, idx) => {
                        if (bulletInputs[idx]) {
                            bulletInputs[idx].value = bullet;
                        }
                    });
                    updateBulletsJson();
                }
            }
        } catch (e) {
            // Ignore
        }
    }

    function saveDraft() {
        try {
            const bullets = bulletInputs.map(input => input.value.trim()).filter(b => b);
            localStorage.setItem(draftKey, JSON.stringify({
                image: selectedImageId,
                bullets: bullets
            }));
        } catch (e) {
            // Ignore
        }
    }

    function clearDraft() {
        try {
            localStorage.removeItem(draftKey);
            sessionStorage.removeItem(storageKey);
        } catch (e) {
            // Ignore
        }
    }

    // ========================================
    // Image Selection
    // ========================================

    function selectImage(imageId) {
        selectedImageId = imageId;
        selectedImageInput.value = imageId;
        selectedImagePage = currentPage;

        // Update visual selection
        const cards = imagePage.querySelectorAll('.image-card');
        cards.forEach(card => {
            card.classList.toggle('selected', card.dataset.image === imageId);
        });

        // Show bullet section
        bulletSection.style.display = 'block';
        setTimeout(() => {
            bulletSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);

        updateSubmitButton();
        saveDraft();
        savePageState(currentPage);

        // Hide jump button since we're on selection page
        jumpSection.classList.remove('visible');
    }

    function jumpToSelection() {
        if (selectedImagePage && selectedImagePage !== currentPage) {
            loadPage(selectedImagePage);
        }
    }
    // Expose to global for onclick
    window.jumpToSelection = jumpToSelection;

    // ========================================
    // Bullet Points
    // ========================================

    function updateBulletsJson() {
        const bullets = bulletInputs.map(input => input.value.trim()).filter(b => b);
        bulletsJsonInput.value = JSON.stringify(bullets);
    }

    function updateSubmitButton() {
        const hasImage = selectedImageId !== null;
        const hasBullet = bulletInputs[0].value.trim().length > 0;
        submitBtn.disabled = !(hasImage && hasBullet);

        if (hasImage && hasBullet) {
            selectionHint.textContent = 'Ready to submit';
        } else if (hasImage) {
            selectionHint.textContent = 'Enter at least one bullet point';
        } else {
            selectionHint.textContent = 'Select an image to continue';
        }
    }

    // ========================================
    // Event Handlers
    // ========================================

    prevBtn.addEventListener('click', function() {
        if (currentPage > 1) {
            loadPage(currentPage - 1);
        }
    });

    nextBtn.addEventListener('click', function() {
        if (currentPage < totalPages) {
            loadPage(currentPage + 1);
        }
    });

    bulletInputs.forEach(input => {
        input.addEventListener('input', function() {
            updateBulletsJson();
            updateSubmitButton();
            saveDraft();
        });
    });

    respondForm.addEventListener('submit', function(e) {
        updateBulletsJson();

        const bullets = bulletInputs.map(input => input.value.trim()).filter(b => b);
        if (bullets.length === 0) {
            e.preventDefault();
            alert('Please enter at least one bullet point.');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        submitBtn.classList.add('loading');

        clearDraft();
    });

    // ========================================
    // Initialization
    // ========================================

    function init() {
        // Load from existing response first
        const existingValue = selectedImageInput.value;
        const existingBullets = bulletsJsonInput.value;

        if (existingValue) {
            selectedImageId = existingValue;
            // Pre-fill bullets if editing
            if (existingBullets && existingBullets !== '[]') {
                try {
                    const bullets = JSON.parse(existingBullets);
                    bullets.forEach((bullet, idx) => {
                        if (bulletInputs[idx]) {
                            bulletInputs[idx].value = bullet;
                        }
                    });
                } catch (e) {}
            }
            bulletSection.style.display = 'block';
            updateSubmitButton();
        } else {
            // Try to restore from draft
            loadDraft();
            if (selectedImageId) {
                bulletSection.style.display = 'block';
                updateSubmitButton();
            }
        }

        // Restore page position
        const savedPage = loadPageState();

        // Load the page (either saved position or page 1)
        loadPage(savedPage);
    }

    init();
})();
</script>
{% endblock %}
```

Key changes from original:
1. Sticky header with instruction + pagination in `.image-browser-sticky`
2. Page indicator shows "Page X of Y" instead of "1-6 of 55"
3. AJAX loading via fetch() to /api/images endpoint
4. sessionStorage persistence for page state (survives refresh - IG-2)
5. "Jump to selection" button when selection is on different page (IG-3)
6. Explicit Next/Prev buttons only, no swipe gestures (IG-4)
  </action>
  <verify>
1. grep -n "image-browser-sticky" the55/app/templates/participant/respond.html
2. grep -n "api/images" the55/app/templates/participant/respond.html
3. grep -n "sessionStorage" the55/app/templates/participant/respond.html
All three should return matches.
  </verify>
  <done>Template uses sticky header, AJAX pagination via /api/images, and sessionStorage for state persistence</done>
</task>

<task type="auto">
  <name>Task 3: Verify integration and test</name>
  <files></files>
  <action>
Verify the implementation works end-to-end:

1. Start the dev server (if not running):
   ```bash
   cd /var/www/the55 && source venv/bin/activate && python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8055
   ```

2. Test API endpoint returns correct pagination format:
   ```bash
   curl -s "http://localhost:8055/api/images?page=1&per_page=20&seed=123" | python3 -m json.tool | head -30
   ```
   Expected: JSON with images array, total, page, per_page, total_pages

3. Verify CSS file contains sticky header styles:
   ```bash
   grep -c "webkit-sticky" /var/www/the55/app/static/css/main.css
   ```
   Expected: At least 1 match

4. Verify template contains AJAX loading:
   ```bash
   grep -c "api/images" /var/www/the55/app/templates/participant/respond.html
   ```
   Expected: At least 1 match

5. Check there are no syntax errors in template:
   ```bash
   cd /var/www/the55 && source venv/bin/activate && python -c "from jinja2 import Environment, FileSystemLoader; env = Environment(loader=FileSystemLoader('app/templates')); env.get_template('participant/respond.html')"
   ```
   Expected: No error output
  </action>
  <verify>
All test commands should pass without errors:
- API returns paginated JSON
- CSS contains -webkit-sticky
- Template contains api/images fetch
- Template parses without Jinja errors
  </verify>
  <done>Integration verified: API pagination works, CSS has iOS compatibility, template loads without errors</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Visual test in browser:**
   - Navigate to a respond page as a participant
   - Scroll down - header should stay visible at top
   - Page indicator should show "Page 1 of X"
   - Click Next - images should load via AJAX (no full page reload)
   - Select an image on page 3, navigate to page 5
   - "Jump to selection" button should appear

2. **iOS Safari simulation:**
   - The CSS uses -webkit-sticky prefix
   - The transform: translate3d(0,0,0) forces GPU layer
   - overflow:visible on .image-browser allows sticky to work

3. **Persistence test:**
   - Navigate to page 5, refresh browser
   - Should return to page 5 (sessionStorage)
</verification>

<success_criteria>
1. IMG-01: Sticky Next/Previous navigation at top of image browser - always visible
2. IMG-02: Fixed progress indicator at top showing "Page X of Y"
3. IMG-03: Fixed instruction header remains visible during browsing
4. IMG-04: ~20 images per page with pagination controls
5. IMG-05: Sticky header works on iOS Safari (with -webkit-sticky prefix)
</success_criteria>

<output>
After completion, create `.planning/phases/19-participant-image-browser/19-01-SUMMARY.md`
</output>
