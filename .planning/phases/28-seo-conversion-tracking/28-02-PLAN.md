---
phase: 28-seo-conversion-tracking
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/db/models.py
  - app/routers/demo.py
  - app/main.py
  - templates/landing.html
  - templates/demo/synthesis.html
autonomous: true

must_haves:
  truths:
    - "ConversionEvent model exists with event_type enum and created_at timestamp"
    - "Demo click events logged when visitor navigates to /demo"
    - "Demo completion events logged when visitor reaches synthesis page"
    - "Email CTA clicks tracked via JavaScript before mailto opens"
  artifacts:
    - path: "app/db/models.py"
      provides: "ConversionEvent SQLAlchemy model"
      contains: "class ConversionEvent"
    - path: "app/routers/demo.py"
      provides: "Event logging in demo routes"
      contains: "ConversionEvent"
  key_links:
    - from: "app/routers/demo.py"
      to: "app/db/models.py"
      via: "import ConversionEvent"
      pattern: "from app.db.models import.*ConversionEvent"
    - from: "templates/demo/synthesis.html"
      to: "/api/track-email"
      via: "onclick fetch"
      pattern: "fetch.*track-email"
---

<objective>
Add ConversionEvent model and implement conversion tracking across demo funnel.

Purpose: TRACK-01 through TRACK-04 require logging all CTA interactions for funnel analysis. Privacy-first approach uses SQLite event logging without external analytics or cookies.
Output: ConversionEvent model, server-side event logging in routes, client-side email click tracking.
</objective>

<execution_context>
@/home/DrPloy/.claude/get-shit-done/workflows/execute-plan.md
@/home/DrPloy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/28-seo-conversion-tracking/28-RESEARCH.md

@app/db/models.py
@app/db/database.py
@app/routers/demo.py
@app/main.py
@templates/landing.html
@templates/demo/synthesis.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConversionEvent SQLAlchemy model</name>
  <files>app/db/models.py</files>
  <action>
Add EventType enum and ConversionEvent model to app/db/models.py:

1. Add EventType enum class with values:
   - DEMO_CLICK = "demo_click" (user clicks "Try the Demo" CTA)
   - DEMO_COMPLETION = "demo_completion" (user reaches synthesis page)
   - EMAIL_CLICK = "email_click" (user clicks email CTA)

2. Add ConversionEvent model with columns:
   - id: Integer, primary key, indexed
   - event_type: Enum(EventType), nullable=False, indexed
   - event_data: Text, nullable=True (JSON object for context like referrer, page)
   - created_at: DateTime, default=datetime.utcnow, nullable=False, indexed

Do NOT add:
- session_hash field (deferred per research - unclear value for mobile networks)
- user_id or any PII fields (privacy-first design)

Place the new code after the existing Response class, keeping the file organized.
  </action>
  <verify>
1. Check model exists: grep -n "class ConversionEvent" app/db/models.py
2. Check enum exists: grep -n "class EventType" app/db/models.py
3. Syntax check: python3 -c "from app.db.models import ConversionEvent, EventType; print('OK')"
  </verify>
  <done>
- ConversionEvent model defined with id, event_type, event_data, created_at
- EventType enum has DEMO_CLICK, DEMO_COMPLETION, EMAIL_CLICK values
- Model imports work without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add event logging to demo routes and main landing</name>
  <files>app/routers/demo.py, app/main.py</files>
  <action>
1. In app/routers/demo.py:
   - Add imports: from sqlalchemy.orm import Session, from app.db.database import get_db, from app.db.models import ConversionEvent, EventType
   - Import json if not already imported
   - Import Depends from fastapi if not already imported

   - Modify demo_intro() route (the /demo entry point):
     - Add db: Session = Depends(get_db) parameter
     - Log DEMO_CLICK event with event_data containing referrer header
     - Commit the event before returning response

   - Modify demo_synthesis() route:
     - Add db: Session = Depends(get_db) parameter
     - Log DEMO_COMPLETION event with event_data containing seed
     - Commit before returning response

2. In app/main.py:
   - Add POST endpoint /api/track-email for client-side email click tracking:
     ```python
     @app.post("/api/track-email")
     async def track_email_click(request: Request, db: Session = Depends(get_db)):
         """Track email CTA click before mailto opens."""
         from app.db.models import ConversionEvent, EventType
         event = ConversionEvent(
             event_type=EventType.EMAIL_CLICK,
             event_data=json.dumps({"source": "synthesis"})
         )
         db.add(event)
         db.commit()
         return {"status": "tracked"}
     ```
   - Add necessary imports: from fastapi import Depends, from sqlalchemy.orm import Session, from app.db.database import get_db, import json

Note: Do NOT log landing page views (LANDING_VIEW) - this would create excessive events. Only log intentional actions.
  </action>
  <verify>
1. Start server and test demo click: curl -s http://localhost:8000/demo | head -20
2. Check DB for events: sqlite3 db/the55.db "SELECT * FROM conversion_events LIMIT 5;"
3. Test email tracking endpoint: curl -X POST http://localhost:8000/api/track-email
4. Syntax check: python3 -c "from app.main import app; from app.routers.demo import router; print('OK')"
  </verify>
  <done>
- DEMO_CLICK logged when visitor hits /demo
- DEMO_COMPLETION logged when visitor reaches /demo/synthesis
- /api/track-email endpoint returns 200 and logs EMAIL_CLICK
  </done>
</task>

<task type="auto">
  <name>Task 3: Add client-side email click tracking to synthesis page</name>
  <files>templates/demo/synthesis.html</files>
  <action>
Modify the email CTA link in templates/demo/synthesis.html to track clicks:

1. Find the conversion-cta-primary mailto link (around line 138)
2. Add an onclick handler that:
   - Sends POST to /api/track-email (fire-and-forget, don't await)
   - Does NOT prevent the mailto from opening
   - Uses navigator.sendBeacon() for reliability (fires even if page unloads)

Replace the link with:
```html
<a href="mailto:connectedworld@gmail.com?subject=About%20The%2055%20-%20{{ synthesis_gap_type }}%20Gap%20Demo"
   class="conversion-cta-primary"
   onclick="navigator.sendBeacon('/api/track-email', JSON.stringify({source:'synthesis',gap:'{{ synthesis_gap_type }}'}))"
>
```

Also add tracking to the landing page mailto link:
- In templates/landing.html, find the "email Dale" link (around line 215)
- Add same onclick pattern but with source: 'landing'

Note: sendBeacon is preferred over fetch for this use case because:
- It fires reliably even if the user navigates away immediately
- It's specifically designed for analytics/logging use cases
- No need for async/await handling
  </action>
  <verify>
1. Check synthesis template has onclick: grep -n "sendBeacon" templates/demo/synthesis.html
2. Check landing template has onclick: grep -n "sendBeacon" templates/landing.html
3. Manual test: Open synthesis page, click email link, check DB for EMAIL_CLICK event
  </verify>
  <done>
- Synthesis page email CTA has sendBeacon tracking
- Landing page email link has sendBeacon tracking
- Clicks fire tracking before mailto opens
  </done>
</task>

</tasks>

<verification>
1. Server starts without errors after model changes
2. Database table created: sqlite3 db/the55.db ".schema conversion_events"
3. Event logging works end-to-end:
   - Visit /demo -> DEMO_CLICK event logged
   - Complete demo to /demo/synthesis -> DEMO_COMPLETION event logged
   - Click email CTA -> EMAIL_CLICK event logged
4. Query events: sqlite3 db/the55.db "SELECT event_type, event_data, created_at FROM conversion_events ORDER BY created_at DESC LIMIT 10;"
</verification>

<success_criteria>
- TRACK-01: ConversionEvent SQLite model logs CTA interactions
- TRACK-02: Demo completion events logged (reached synthesis page)
- TRACK-03: Email CTA click events logged
- TRACK-04: Landing page to demo click events logged
</success_criteria>

<output>
After completion, create `.planning/phases/28-seo-conversion-tracking/28-02-SUMMARY.md`
</output>
