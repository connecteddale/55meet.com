---
phase: 28-seo-conversion-tracking
plan: 03
type: execute
wave: 2
depends_on: ["28-02"]
files_modified:
  - app/routers/analytics.py
  - app/routers/__init__.py
  - app/main.py
autonomous: true

must_haves:
  truths:
    - "Admin can query conversion funnel metrics via /admin/analytics/funnel endpoint"
    - "Funnel shows counts for demo_click, demo_completion, email_click"
    - "Conversion rates calculated between funnel stages"
  artifacts:
    - path: "app/routers/analytics.py"
      provides: "Admin analytics endpoint"
      exports: ["router"]
    - path: "app/main.py"
      provides: "Analytics router included"
      contains: "analytics_router"
  key_links:
    - from: "app/routers/analytics.py"
      to: "app/db/models.py"
      via: "ConversionEvent query"
      pattern: "ConversionEvent"
    - from: "app/main.py"
      to: "app/routers/analytics.py"
      via: "include_router"
      pattern: "app.include_router.*analytics"
---

<objective>
Create admin analytics endpoint for querying conversion funnel metrics.

Purpose: TRACK-05 requires admin access to conversion metrics. Simple JSON endpoint returns funnel counts and rates for the specified time period.
Output: New analytics router with /admin/analytics/funnel endpoint.
</objective>

<execution_context>
@/home/DrPloy/.claude/get-shit-done/workflows/execute-plan.md
@/home/DrPloy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/28-seo-conversion-tracking/28-RESEARCH.md
@.planning/phases/28-seo-conversion-tracking/28-02-SUMMARY.md

@app/db/models.py
@app/routers/__init__.py
@app/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analytics router with funnel endpoint</name>
  <files>app/routers/analytics.py</files>
  <action>
Create new file app/routers/analytics.py:

```python
"""
The 55 App - Analytics Router

Admin endpoints for conversion funnel metrics.
Privacy-first: No PII, just aggregate counts.
"""

from datetime import datetime, timedelta

from fastapi import APIRouter, Depends, Query
from sqlalchemy.orm import Session
from sqlalchemy import func

from app.db.database import get_db
from app.db.models import ConversionEvent, EventType

router = APIRouter(prefix="/admin/analytics", tags=["analytics"])


@router.get("/funnel")
def get_conversion_funnel(
    days: int = Query(default=30, ge=1, le=365, description="Number of days to query"),
    db: Session = Depends(get_db)
):
    """
    Query conversion funnel metrics for last N days.

    Returns counts for each funnel stage and conversion rates between stages.
    Funnel: demo_click -> demo_completion -> email_click
    """
    start_date = datetime.utcnow() - timedelta(days=days)

    # Query event counts grouped by type
    results = db.query(
        ConversionEvent.event_type,
        func.count(ConversionEvent.id).label('count')
    ).filter(
        ConversionEvent.created_at >= start_date
    ).group_by(
        ConversionEvent.event_type
    ).all()

    # Build funnel dict
    funnel = {event_type.value: count for event_type, count in results}

    # Get counts with defaults
    demo_clicks = funnel.get('demo_click', 0)
    completions = funnel.get('demo_completion', 0)
    email_clicks = funnel.get('email_click', 0)

    # Calculate conversion rates
    demo_to_completion = round(completions / demo_clicks * 100, 1) if demo_clicks > 0 else 0
    completion_to_inquiry = round(email_clicks / completions * 100, 1) if completions > 0 else 0
    overall = round(email_clicks / demo_clicks * 100, 1) if demo_clicks > 0 else 0

    return {
        "period_days": days,
        "start_date": start_date.isoformat(),
        "end_date": datetime.utcnow().isoformat(),
        "funnel": {
            "demo_click": demo_clicks,
            "demo_completion": completions,
            "email_click": email_clicks
        },
        "rates": {
            "demo_to_completion_pct": demo_to_completion,
            "completion_to_inquiry_pct": completion_to_inquiry,
            "overall_conversion_pct": overall
        }
    }


@router.get("/events/recent")
def get_recent_events(
    limit: int = Query(default=20, ge=1, le=100, description="Number of events to return"),
    db: Session = Depends(get_db)
):
    """
    Get most recent conversion events for debugging/monitoring.

    Returns raw event data (no PII - just event types and timestamps).
    """
    events = db.query(ConversionEvent).order_by(
        ConversionEvent.created_at.desc()
    ).limit(limit).all()

    return {
        "count": len(events),
        "events": [
            {
                "id": e.id,
                "event_type": e.event_type.value,
                "event_data": e.event_data,
                "created_at": e.created_at.isoformat()
            }
            for e in events
        ]
    }
```

Note: These endpoints are under /admin/ path but do not require authentication. For this POC, admin endpoints are unprotected (consistent with existing /admin/login pattern where auth happens at the login page, not the API).
  </action>
  <verify>
1. File exists: ls -la app/routers/analytics.py
2. Syntax check: python3 -c "from app.routers.analytics import router; print('OK')"
  </verify>
  <done>
- analytics.py created with /admin/analytics/funnel and /admin/analytics/events/recent endpoints
- Endpoints query ConversionEvent model
- Conversion rates calculated
  </done>
</task>

<task type="auto">
  <name>Task 2: Register analytics router in app</name>
  <files>app/routers/__init__.py, app/main.py</files>
  <action>
1. In app/routers/__init__.py:
   - Add import: from app.routers.analytics import router as analytics_router
   - Add to __all__ list if one exists

2. In app/main.py:
   - Add analytics_router to the imports from app.routers
   - Add: app.include_router(analytics_router) after the other router includes

Follow the existing pattern in the file for consistency.
  </action>
  <verify>
1. Check __init__.py exports: grep -n "analytics" app/routers/__init__.py
2. Check main.py includes router: grep -n "analytics" app/main.py
3. Full syntax check: python3 -c "from app.main import app; print('OK')"
4. Test endpoint: curl -s http://localhost:8000/admin/analytics/funnel | python3 -m json.tool
  </verify>
  <done>
- analytics_router exported from routers package
- Router included in main FastAPI app
- /admin/analytics/funnel endpoint accessible
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify full funnel tracking end-to-end</name>
  <files></files>
  <action>
Manual verification steps (no files to modify):

1. Restart the server to pick up all changes
2. Clear existing test events if any: sqlite3 db/the55.db "DELETE FROM conversion_events;"
3. Simulate funnel:
   - Visit /demo (should log DEMO_CLICK)
   - Navigate through demo to /demo/synthesis (should log DEMO_COMPLETION)
   - Click email link on synthesis page (should log EMAIL_CLICK)
4. Query funnel: curl http://localhost:8000/admin/analytics/funnel
5. Verify counts: should show 1 for each event type
6. Query recent events: curl http://localhost:8000/admin/analytics/events/recent

Also verify direct SQLite access works:
sqlite3 db/the55.db "SELECT event_type, COUNT(*) FROM conversion_events GROUP BY event_type;"
  </action>
  <verify>
1. Funnel endpoint returns JSON with all three event types
2. Rates calculate correctly (100% with 1 of each event)
3. Recent events endpoint shows timestamped event list
4. Direct SQLite query works for admin terminal access
  </verify>
  <done>
- Full funnel tracking verified: demo_click -> demo_completion -> email_click
- Admin can query via HTTP endpoint
- Admin can query via direct SQLite
- Conversion rates calculate correctly
  </done>
</task>

</tasks>

<verification>
1. Analytics router accessible: curl -s http://localhost:8000/admin/analytics/funnel
2. Response includes funnel counts and rates
3. Events endpoint works: curl -s http://localhost:8000/admin/analytics/events/recent
4. SQLite direct query works: sqlite3 db/the55.db "SELECT event_type, COUNT(*) as count FROM conversion_events GROUP BY event_type;"
</verification>

<success_criteria>
- TRACK-05: Admin can query conversion metrics via /admin/analytics/funnel endpoint
- Funnel shows landing -> demo -> completion -> inquiry counts
- Conversion rates calculated between stages
- Both HTTP endpoint and direct SQLite access available
</success_criteria>

<output>
After completion, create `.planning/phases/28-seo-conversion-tracking/28-03-SUMMARY.md`
</output>
