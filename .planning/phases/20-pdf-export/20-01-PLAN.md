---
phase: 29-pdf-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sites/55meet.com/requirements.txt
  - sites/55meet.com/static/fonts/Inter-Regular.ttf
  - sites/55meet.com/static/fonts/Inter-Bold.ttf
  - sites/55meet.com/static/fonts/Inter-Italic.ttf
  - sites/55meet.com/app/services/pdf_export.py
  - sites/55meet.com/app/routers/sessions.py
  - sites/55meet.com/templates/admin/sessions/view.html
autonomous: true

must_haves:
  truths:
    - "User can click PDF button on results view and download a PDF file"
    - "PDF contains team name and session date"
    - "PDF contains strategy statement"
    - "PDF contains synthesis themes (What We Heard)"
    - "PDF contains key insights with participant attribution"
    - "PDF is clean with simple typography on white background"
    - "Downloaded filename follows TeamName-YYYY-MM.pdf pattern"
  artifacts:
    - path: "sites/55meet.com/static/fonts/Inter-Regular.ttf"
      provides: "Inter font regular weight for PDF rendering"
    - path: "sites/55meet.com/static/fonts/Inter-Bold.ttf"
      provides: "Inter font bold weight for PDF rendering"
    - path: "sites/55meet.com/app/services/pdf_export.py"
      provides: "SessionReportPDF class for PDF generation"
      exports: ["SessionReportPDF"]
      min_lines: 80
    - path: "sites/55meet.com/app/routers/sessions.py"
      provides: "PDF export endpoint"
      contains: "export_pdf"
  key_links:
    - from: "sites/55meet.com/app/routers/sessions.py"
      to: "sites/55meet.com/app/services/pdf_export.py"
      via: "import SessionReportPDF"
      pattern: "from app\\.services\\.pdf_export import"
    - from: "sites/55meet.com/templates/admin/sessions/view.html"
      to: "/admin/sessions/{id}/export/pdf"
      via: "href to PDF endpoint"
      pattern: "export/pdf"
---

<objective>
Add PDF export functionality to The 55 App that generates presentation-ready session reports.

Purpose: Dale needs to hand clients a professional PDF report after each session - something clean he can print or email that captures the team's alignment status without requiring tech access.

Output: Working PDF export button alongside existing JSON/Markdown exports, generating a well-formatted PDF with team info, strategy statement, synthesis themes, and attributed insights.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/29-pdf-export/29-RESEARCH.md
@sites/55meet.com/app/routers/sessions.py
@sites/55meet.com/templates/admin/sessions/view.html
@sites/55meet.com/app/services/synthesis.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install fpdf2 and Setup Fonts</name>
  <files>
    sites/55meet.com/requirements.txt
    sites/55meet.com/static/fonts/Inter-Regular.ttf
    sites/55meet.com/static/fonts/Inter-Bold.ttf
    sites/55meet.com/static/fonts/Inter-Italic.ttf
  </files>
  <action>
    1. Add `fpdf2>=2.8.0` to requirements.txt
    2. Run `pip install fpdf2` in the virtual environment
    3. Create `sites/55meet.com/static/fonts/` directory
    4. Download Inter font files from Google Fonts:
       - Use curl to download from: https://fonts.google.com/download?family=Inter
       - Extract Inter-Regular.ttf, Inter-Bold.ttf, Inter-Italic.ttf (or Inter-Medium.ttf if Italic unavailable)
       - Alternative: Download from https://github.com/rsms/inter/releases
    5. Place font files in static/fonts/ directory

    Note: Inter is SIL Open Font License - free to embed in PDFs.
  </action>
  <verify>
    - `pip show fpdf2` shows version 2.8+
    - `ls sites/55meet.com/static/fonts/*.ttf` shows at least Inter-Regular.ttf and Inter-Bold.ttf
  </verify>
  <done>fpdf2 installed, Inter font files present in static/fonts/</done>
</task>

<task type="auto">
  <name>Task 2: Create PDF Export Service</name>
  <files>sites/55meet.com/app/services/pdf_export.py</files>
  <action>
    Create `pdf_export.py` with a `SessionReportPDF` class following the pattern from RESEARCH.md:

    1. Define color constants matching the design system:
       - TEXT_PRIMARY: (29, 29, 31) - #1d1d1f
       - TEXT_SECONDARY: (110, 110, 115) - #6e6e73
       - TEXT_TERTIARY: (134, 134, 139) - #86868b
       - DIVIDER: (210, 210, 215) - #d2d2d7

    2. Create `SessionReportPDF(FPDF)` class:
       - `__init__(self, team_name: str, session_date: str)` - store metadata, setup fonts, set auto page break
       - `_setup_fonts(self)` - register Inter font family (regular, bold, italic) using absolute path from `Path(__file__).parent.parent.parent / "static" / "fonts"`
       - `header(self)` - "The 55 | {team_name}" in top left, subtle divider line
       - `footer(self)` - "{session_date} | Page {page_no}" centered at bottom
       - `add_title(self, text)` - 24pt bold, primary color
       - `add_section_header(self, text)` - 14pt bold, primary color
       - `add_body_text(self, text)` - 11pt regular, using multi_cell for wrapping
       - `add_attributed_insight(self, statement, participants)` - bullet + statement + italic attribution in secondary color

    3. Create `generate_session_pdf(session, team) -> bytes` function:
       - Instantiate SessionReportPDF with team.team_name and session.month
       - Add page
       - Add title "Session Report"
       - If team.strategy_statement: add "Strategy Statement" section
       - If session.synthesis_themes: add "What We Heard" section
       - If session.synthesis_statements (parse JSON): add "Key Insights" section with attributed bullets
       - Return bytes(pdf.output())

    Important: Create new FPDF instance per request (instances are not reusable after output()).
  </action>
  <verify>
    - File exists at sites/55meet.com/app/services/pdf_export.py
    - Contains SessionReportPDF class
    - Contains generate_session_pdf function
    - Python syntax check: `python -m py_compile sites/55meet.com/app/services/pdf_export.py`
  </verify>
  <done>PDF service module with SessionReportPDF class and generate_session_pdf function</done>
</task>

<task type="auto">
  <name>Task 3: Add PDF Endpoint and UI Button</name>
  <files>
    sites/55meet.com/app/routers/sessions.py
    sites/55meet.com/templates/admin/sessions/view.html
  </files>
  <action>
    In sessions.py:

    1. Add import at top:
       ```python
       from fastapi import Response
       from app.services.pdf_export import generate_session_pdf
       ```

    2. Add new endpoint after export_markdown (around line 898):
       ```python
       @router.get("/{session_id}/export/pdf")
       async def export_pdf(session_id: int, auth: AuthDep, db: DbDep):
           """Export session data as presentation-ready PDF."""
           session = db.query(Session).filter(Session.id == session_id).first()
           if not session:
               raise HTTPException(status_code=404, detail="Session not found")

           team = session.team

           # Generate PDF bytes
           pdf_bytes = generate_session_pdf(session, team)

           # Clean filename: TeamName-YYYY-MM.pdf
           safe_team = team.team_name.replace(" ", "-").replace("/", "-")
           filename = f"{safe_team}-{session.month}.pdf"

           return Response(
               content=pdf_bytes,
               media_type="application/pdf",
               headers={"Content-Disposition": f"attachment; filename={filename}"}
           )
       ```

    In view.html (around line 82-83 where export buttons are):

    3. Add PDF button BEFORE the JSON export button:
       ```html
       <a href="/admin/sessions/{{ session.id }}/export/pdf" class="btn btn-primary btn-block">Export PDF</a>
       ```

       This makes PDF the primary action (btn-primary), with JSON and Markdown as secondary (btn-secondary).
  </action>
  <verify>
    - Grep shows export_pdf endpoint in sessions.py
    - Grep shows export/pdf href in view.html
    - Start server and test: `curl -I http://localhost:8000/admin/sessions/1/export/pdf` returns Content-Type: application/pdf (requires valid session)
  </verify>
  <done>PDF export endpoint responds with application/pdf, button visible on session view</done>
</task>

</tasks>

<verification>
1. Navigate to any session with synthesis completed (closed or revealed state)
2. Verify "Export PDF" button appears alongside "Export JSON" and "Export Markdown"
3. Click "Export PDF" button
4. Browser downloads a PDF file with name like "TeamName-2026-01.pdf"
5. Open PDF and verify contents:
   - Header shows "The 55 | {Team Name}"
   - Title shows "Session Report"
   - Strategy statement section (if team has one)
   - "What We Heard" section with synthesis themes
   - "Key Insights" section with bulleted statements and participant attribution
   - Footer shows session date and page number
   - Typography is clean Inter font on white background
</verification>

<success_criteria>
- PDF-01: PDF button visible alongside JSON/MD exports - SATISFIED by Task 3
- PDF-02: PDF contains team name and date - SATISFIED by Task 2 (header/footer)
- PDF-03: PDF contains strategy statement - SATISFIED by Task 2 (generate_session_pdf)
- PDF-04: PDF contains synthesis themes - SATISFIED by Task 2 (generate_session_pdf)
- PDF-05: PDF contains insights with attribution - SATISFIED by Task 2 (add_attributed_insight)
- PDF-06: Clean minimal design - SATISFIED by Task 2 (color constants, Inter font)
- PDF-07: Descriptive filename - SATISFIED by Task 3 (TeamName-YYYY-MM.pdf pattern)
</success_criteria>

<output>
After completion, create `.planning/phases/29-pdf-export/29-01-SUMMARY.md`
</output>
