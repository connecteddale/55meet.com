---
phase: 22-synthesis-presentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - the55/app/routers/sessions.py
autonomous: true

must_haves:
  truths:
    - "Level 1 export returns themes and gap_type only"
    - "Level 2 export returns statements array with attribution"
    - "Level 3 export returns raw responses by participant"
    - "Retry endpoint allows re-triggering failed synthesis"
  artifacts:
    - path: "the55/app/routers/sessions.py"
      provides: "Level-specific export endpoints and retry endpoint"
      exports: ["export_level1", "export_level2", "export_level3"]
  key_links:
    - from: "the55/app/routers/sessions.py"
      to: "Session model"
      via: "Database queries for synthesis data"
      pattern: "session\\.synthesis_"
---

<objective>
Add level-specific export endpoints and synthesis retry capability to the sessions router.

Purpose: Enable per-level JSON export for presentation (PRES-05) and provide explicit retry mechanism for failed synthesis (SYNTH-04).

Output: Four new endpoints in sessions.py supporting the three-level presentation model.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-synthesis-presentation/22-RESEARCH.md

@the55/app/routers/sessions.py
@the55/app/db/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add level-specific export endpoints</name>
  <files>the55/app/routers/sessions.py</files>
  <action>
Add three new export endpoints after the existing `/export` endpoint:

1. `GET /{session_id}/export/level1` - Returns JSON with:
   - themes (string)
   - gap_type (string)
   - gap_reasoning (if available in schema, else omit)

2. `GET /{session_id}/export/level2` - Returns JSON with:
   - statements array (parsed from synthesis_statements)
   - Each statement has: statement (string), participants (array of names)

3. `GET /{session_id}/export/level3` - Returns JSON with:
   - responses array, each containing:
     - participant (name string)
     - image_number (int)
     - bullets (array of strings)
     - submitted_at (ISO timestamp)

All endpoints:
- Require auth (AuthDep)
- Return 404 if session not found
- Use JSONResponse with Content-Disposition for download
- Filename pattern: `session-{month}-{team_name}-level{N}.json`
  </action>
  <verify>
Manual curl test:
- `curl -b cookies.txt http://localhost:8055/admin/sessions/1/export/level1` returns JSON with themes/gap_type
- `curl -b cookies.txt http://localhost:8055/admin/sessions/1/export/level2` returns JSON with statements array
- `curl -b cookies.txt http://localhost:8055/admin/sessions/1/export/level3` returns JSON with raw responses
  </verify>
  <done>Three export endpoints return appropriate level-specific JSON data</done>
</task>

<task type="auto">
  <name>Task 2: Add synthesis retry endpoint</name>
  <files>the55/app/routers/sessions.py</files>
  <action>
Add a POST endpoint for explicit synthesis retry:

`POST /{session_id}/synthesize/retry`

Behavior:
- Requires auth (AuthDep)
- Only works when session is CLOSED state
- Clears existing synthesis data (themes, statements, gap_type) to force regeneration
- Calls existing `run_synthesis_task` via BackgroundTasks
- Redirects back to session view

This differs from existing `/synthesize` which skips regeneration if valid synthesis exists.
The retry endpoint ALWAYS regenerates, even if current synthesis appears valid.

Add a status check endpoint for polling synthesis progress:

`GET /{session_id}/synthesis-status`

Returns JSON:
- status: "pending" | "complete" | "failed"
- has_error: boolean (true if themes contains "failed" or "insufficient")
- error_message: string (themes content if failed)
  </action>
  <verify>
Manual test:
- Trigger synthesis, wait for completion
- Call retry endpoint
- Verify synthesis_themes is cleared and regeneration starts
- Call synthesis-status to check progress
  </verify>
  <done>Retry endpoint clears and regenerates synthesis; status endpoint enables polling</done>
</task>

</tasks>

<verification>
Run the development server and test all new endpoints:
```bash
cd /var/www/the55 && source venv/bin/activate && python -m uvicorn app.main:app --reload --port 8055
```

Test with existing session data (requires valid session in database).
</verification>

<success_criteria>
- [ ] Level 1 export returns only themes and gap_type
- [ ] Level 2 export returns attributed statements array
- [ ] Level 3 export returns raw participant responses
- [ ] Retry endpoint forces synthesis regeneration
- [ ] Synthesis status endpoint returns proper status values
</success_criteria>

<output>
After completion, create `.planning/phases/22-synthesis-presentation/22-01-SUMMARY.md`
</output>
