---
phase: 22-synthesis-presentation
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - the55/app/templates/admin/sessions/present.html
  - the55/app/static/css/main.css
  - the55/app/static/js/presentation.js
  - the55/app/routers/sessions.py
autonomous: true

must_haves:
  truths:
    - "Level 1 shows high-level themes and gap type"
    - "Level 2 shows attributed grouped insights"
    - "Level 3 shows raw statements organized by participant"
    - "Pressing 1, 2, or 3 keys switches between levels"
    - "Each level has its own export button linking to level-specific endpoint"
    - "Synthesis failure shows clear error message with retry button"
  artifacts:
    - path: "the55/app/templates/admin/sessions/present.html"
      provides: "Three-level tabbed presentation view"
      contains: "data-level"
    - path: "the55/app/static/js/presentation.js"
      provides: "Keyboard navigation for levels"
      contains: "keydown"
    - path: "the55/app/static/css/main.css"
      provides: "Level tab and content styling"
      contains: "level-tab"
  key_links:
    - from: "present.html"
      to: "presentation.js"
      via: "script include"
      pattern: "presentation\\.js"
    - from: "presentation.js"
      to: "DOM elements"
      via: "data-level attribute"
      pattern: "data-level"
---

<objective>
Enhance the presentation page with three switchable levels, keyboard navigation, per-level export buttons, and synthesis retry UI.

Purpose: Fulfill PRES-01 through PRES-05 requirements with a professional presentation experience that supports facilitator flow using keyboard shortcuts.

Output: Updated present.html with tabbed three-level view, new presentation.js for keyboard handling, enhanced CSS for level styling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-synthesis-presentation/22-RESEARCH.md
@.planning/phases/22-synthesis-presentation/22-01-SUMMARY.md

@the55/app/templates/admin/sessions/present.html
@the55/app/static/css/main.css
@the55/app/routers/sessions.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update sessions router to pass raw responses to template</name>
  <files>the55/app/routers/sessions.py</files>
  <action>
Modify the `present_session` endpoint to query raw responses for Level 3:

1. Query all Response records for the session
2. For each response, get the member name and build response data:
   - participant: member.name
   - image_number: response.image_number
   - bullets: parsed JSON from response.bullets
3. Pass `raw_responses` list to the template context

Also pass a boolean `synthesis_failed` to indicate if themes contains "failed" or "insufficient" for retry UI.
  </action>
  <verify>Check that raw_responses appears in template context by adding a debug print</verify>
  <done>Template receives raw_responses list and synthesis_failed boolean</done>
</task>

<task type="auto">
  <name>Task 2: Create three-level presentation template</name>
  <files>the55/app/templates/admin/sessions/present.html</files>
  <action>
Restructure present.html to support three switchable levels:

**Tab Navigation Bar:**
```html
<div class="level-tabs">
    <button class="level-tab active" data-level="1">1. Themes</button>
    <button class="level-tab" data-level="2">2. Insights</button>
    <button class="level-tab" data-level="3">3. Raw</button>
</div>
```

**Level 1 Content (Themes):** (default visible)
- Existing themes display
- Gap type with description
- Export button linking to /export/level1

**Level 2 Content (Insights):**
- Attributed statements list (existing synthesis_statements)
- Export button linking to /export/level2

**Level 3 Content (Raw Statements):**
- Group by participant (loop over raw_responses)
- Show participant name as heading
- List their bullet points
- Show image number reference
- Export button linking to /export/level3

**Synthesis Failure State:**
If synthesis_failed is true:
- Show error message prominently
- Show "Retry Synthesis" button that POSTs to /synthesize/retry
- Hide level tabs (no content to show)

**Keyboard Hint:**
Small hint in footer: "Press 1, 2, or 3 to switch levels"

Add script include for presentation.js at end of content block.
  </action>
  <verify>Load present.html in browser, verify three tabs visible, content switches on click</verify>
  <done>Template shows three-level tabbed interface with level-specific content and export buttons</done>
</task>

<task type="auto">
  <name>Task 3: Create keyboard navigation JavaScript</name>
  <files>the55/app/static/js/presentation.js</files>
  <action>
Create new file `the55/app/static/js/presentation.js`:

```javascript
/**
 * Presentation Mode - Keyboard Navigation
 * Press 1, 2, or 3 to switch between presentation levels
 */

(function() {
    'use strict';

    function showLevel(level) {
        // Hide all level content
        document.querySelectorAll('.level-content').forEach(function(el) {
            el.classList.remove('active');
        });

        // Show selected level
        var target = document.querySelector('[data-level="' + level + '"].level-content');
        if (target) {
            target.classList.add('active');
        }

        // Update tab active states
        document.querySelectorAll('.level-tab').forEach(function(tab) {
            tab.classList.remove('active');
            tab.setAttribute('aria-selected', 'false');
        });
        var activeTab = document.querySelector('.level-tab[data-level="' + level + '"]');
        if (activeTab) {
            activeTab.classList.add('active');
            activeTab.setAttribute('aria-selected', 'true');
        }
    }

    // Keyboard listener
    document.addEventListener('keydown', function(e) {
        // Only respond to 1, 2, 3 keys when not in an input field
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            return;
        }

        if (e.key === '1' || e.key === '2' || e.key === '3') {
            e.preventDefault();
            showLevel(parseInt(e.key, 10));
        }
    });

    // Tab click handler
    document.querySelectorAll('.level-tab').forEach(function(tab) {
        tab.addEventListener('click', function() {
            var level = this.getAttribute('data-level');
            showLevel(parseInt(level, 10));
        });
    });
})();
```

Use IIFE pattern to avoid global namespace pollution. Use ES5 syntax for maximum compatibility (no arrow functions).
  </action>
  <verify>Open presentation page, press 1/2/3 keys, verify levels switch correctly</verify>
  <done>Keyboard shortcuts 1/2/3 switch between presentation levels</done>
</task>

<task type="auto">
  <name>Task 4: Add presentation level CSS</name>
  <files>the55/app/static/css/main.css</files>
  <action>
Add CSS at end of Presentation Mode section for level tabs and content:

```css
/* Level Tab Navigation */
.level-tabs {
    display: flex;
    gap: var(--space-2);
    margin-bottom: var(--space-6);
    padding-bottom: var(--space-4);
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.level-tab {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    color: rgba(255,255,255,0.6);
    padding: var(--space-3) var(--space-5);
    font-size: var(--font-size-base);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.level-tab:hover {
    background: rgba(255,255,255,0.1);
    color: rgba(255,255,255,0.8);
}

.level-tab.active {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: white;
}

/* Level Content Visibility */
.level-content {
    display: none;
}

.level-content.active {
    display: block;
}

/* Level 3: Raw Responses */
.raw-participant {
    margin-bottom: var(--space-6);
    padding: var(--space-4);
    background: rgba(255,255,255,0.03);
    border-radius: 8px;
}

.raw-participant-name {
    font-size: var(--font-size-lg);
    font-weight: 600;
    margin-bottom: var(--space-2);
    color: rgba(255,255,255,0.9);
}

.raw-participant-image {
    font-size: var(--font-size-sm);
    color: rgba(255,255,255,0.5);
    margin-bottom: var(--space-3);
}

.raw-bullets {
    list-style: disc;
    padding-left: var(--space-5);
}

.raw-bullets li {
    margin-bottom: var(--space-2);
    color: rgba(255,255,255,0.8);
}

/* Export Button in Presentation */
.level-export {
    display: inline-block;
    margin-top: var(--space-4);
    padding: var(--space-2) var(--space-4);
    background: rgba(255,255,255,0.1);
    border-radius: 4px;
    color: rgba(255,255,255,0.7);
    text-decoration: none;
    font-size: var(--font-size-sm);
}

.level-export:hover {
    background: rgba(255,255,255,0.15);
    color: white;
}

/* Keyboard Hint */
.keyboard-hint {
    position: fixed;
    bottom: var(--space-4);
    right: var(--space-4);
    font-size: var(--font-size-sm);
    color: rgba(255,255,255,0.3);
}

.keyboard-hint kbd {
    display: inline-block;
    padding: 2px 6px;
    background: rgba(255,255,255,0.1);
    border-radius: 3px;
    font-family: monospace;
}

/* Synthesis Error State */
.synthesis-error {
    text-align: center;
    padding: var(--space-8);
}

.synthesis-error-message {
    font-size: var(--font-size-lg);
    color: #ef4444;
    margin-bottom: var(--space-6);
}

.retry-button {
    display: inline-block;
    padding: var(--space-3) var(--space-6);
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: var(--font-size-base);
    cursor: pointer;
}

.retry-button:hover {
    opacity: 0.9;
}
```
  </action>
  <verify>Check presentation page styling - tabs should be visually distinct, active tab highlighted</verify>
  <done>Level tabs and content styled appropriately for presentation mode</done>
</task>

</tasks>

<verification>
Full end-to-end test:
1. Navigate to a revealed session
2. Click "Present" to enter presentation mode
3. Verify Level 1 shows themes and gap type
4. Press "2" key - verify Level 2 shows attributed insights
5. Press "3" key - verify Level 3 shows raw participant responses
6. Click each level's export button - verify JSON downloads
7. Test with a failed synthesis session - verify retry button appears and works
</verification>

<success_criteria>
- [ ] Three tabs visible at top of presentation
- [ ] Clicking tabs switches content
- [ ] Pressing 1/2/3 keys switches content
- [ ] Level 1 shows themes, gap type, export button
- [ ] Level 2 shows attributed statements, export button
- [ ] Level 3 shows raw responses by participant, export button
- [ ] Failed synthesis shows error with retry button
- [ ] Keyboard hint visible in corner
</success_criteria>

<output>
After completion, create `.planning/phases/22-synthesis-presentation/22-02-SUMMARY.md`
</output>
