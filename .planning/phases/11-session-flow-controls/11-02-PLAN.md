---
phase: 20-session-flow-controls
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - /var/www/the55/app/templates/admin/sessions/view.html
autonomous: true

must_haves:
  truths:
    - "Facilitator sees 'Reopen Capture' button when session is CLOSED"
    - "Facilitator sees 'Clear' button per member when session is CAPTURING"
    - "Reopen button shows confirm dialog warning about synthesis loss"
    - "Clear button shows confirm dialog before deleting submission"
    - "State changes update UI via existing polling mechanism"
  artifacts:
    - path: "/var/www/the55/app/templates/admin/sessions/view.html"
      provides: "Reopen and Clear buttons with confirm dialogs"
      contains: "reopen"
  key_links:
    - from: "Reopen button form"
      to: "/admin/sessions/{id}/reopen"
      via: "form action POST"
      pattern: "action=.*reopen"
    - from: "Clear button form"
      to: "/admin/sessions/{id}/member/{mid}/clear"
      via: "form action POST"
      pattern: "action=.*member.*clear"
---

<objective>
Add facilitator UI controls for reopening capture and clearing individual submissions.

Purpose: Give facilitators visual controls for session flow management.
Output: Updated view.html with new buttons and confirm dialogs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-session-flow-controls/20-RESEARCH.md
@.planning/phases/20-session-flow-controls/20-01-SUMMARY.md

Existing UI patterns:
@/var/www/the55/app/templates/admin/sessions/view.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Reopen Capture button</name>
  <files>/var/www/the55/app/templates/admin/sessions/view.html</files>
  <action>
In the CLOSED state section (around line 53), add a secondary "Reopen Capture" button below the main controls.

After the synthesis generation/reveal controls in the `{% elif session.state.value == 'closed' %}` block, add:

```html
{# Reopen capture option for latecomers #}
<div class="secondary-controls" style="margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--border-color);">
    <form method="post" action="/admin/sessions/{{ session.id }}/reopen"
          onsubmit="return confirm('Reopen capture for latecomers?\n\nThis will clear any existing synthesis and allow new submissions.');">
        <button type="submit" class="btn btn-secondary">
            Reopen Capture
        </button>
    </form>
    <p class="control-hint">Allow latecomers to submit. Clears synthesis if generated.</p>
</div>
```

Place this BEFORE the `{% elif session.state.value == 'revealed' %}` line.

The confirm dialog warns about synthesis loss (per research pitfall #5).
  </action>
  <verify>
Template syntax valid: `cd /var/www/the55 && source venv/bin/activate && python -c "from jinja2 import Environment, FileSystemLoader; env = Environment(loader=FileSystemLoader('app/templates')); env.get_template('admin/sessions/view.html'); print('OK')"`
  </verify>
  <done>Reopen Capture button appears in CLOSED state with confirm dialog warning</done>
</task>

<task type="auto">
  <name>Task 2: Add Clear button to member status list</name>
  <files>/var/www/the55/app/templates/admin/sessions/view.html</files>
  <action>
In the member status list section (around line 94-102), add a Clear button for submitted members during CAPTURING state.

Update the member-status-item div to include a Clear form:

```html
<div class="member-status-list" id="member-status-list">
    {% for member in member_status %}
    <div class="member-status-item" data-member-id="{{ member.id }}">
        <span class="member-name">{{ member.name }}</span>
        <span class="status-indicator {% if member.submitted %}submitted{% else %}waiting{% endif %}">
            {% if member.submitted %}Submitted{% else %}Waiting...{% endif %}
        </span>
        {% if session.state.value == 'capturing' and member.submitted %}
        <form method="post" action="/admin/sessions/{{ session.id }}/member/{{ member.id }}/clear"
              onsubmit="return confirm('Clear {{ member.name }}\'s submission? They will need to resubmit.');"
              style="margin-left: auto;">
            <button type="submit" class="btn btn-small btn-danger">
                Clear
            </button>
        </form>
        {% endif %}
    </div>
    {% endfor %}
</div>
```

Key points:
- Only show Clear button during CAPTURING state AND when member has submitted
- Inline form with confirm dialog including member name
- btn-danger class for destructive action (red styling)
- margin-left: auto pushes button to right of flex row
  </action>
  <verify>
Template syntax valid and contains clear form:
```bash
grep -c "member.*clear" /var/www/the55/app/templates/admin/sessions/view.html
```
Expected output: 1 (or more)
  </verify>
  <done>Clear button appears per submitted member during CAPTURING state with confirm dialog</done>
</task>

<task type="auto">
  <name>Task 3: Add btn-danger CSS class</name>
  <files>/var/www/the55/app/static/css/style.css</files>
  <action>
Add a btn-danger class for destructive action buttons. Find the button styles section and add:

```css
.btn-danger {
    background: var(--error-color, #dc2626);
    color: white;
    border-color: var(--error-color, #dc2626);
}

.btn-danger:hover {
    background: #b91c1c;
    border-color: #b91c1c;
}
```

If --error-color CSS variable doesn't exist, use the fallback #dc2626 (Tailwind red-600).

Place after existing .btn-warning styles.
  </action>
  <verify>
CSS contains btn-danger:
```bash
grep -c "btn-danger" /var/www/the55/app/static/css/style.css
```
Expected output: 2 (or more)
  </verify>
  <done>btn-danger CSS class exists for red destructive action buttons</done>
</task>

</tasks>

<verification>
1. Visual verification - start dev server and navigate to a CLOSED session:
   - See "Reopen Capture" button with secondary styling
   - Click shows confirm dialog mentioning synthesis

2. Visual verification - navigate to a CAPTURING session with some submissions:
   - See "Clear" button on submitted member rows
   - Click shows confirm dialog with member name

3. Grep checks:
   ```bash
   grep "reopen" /var/www/the55/app/templates/admin/sessions/view.html
   grep "member.*clear" /var/www/the55/app/templates/admin/sessions/view.html
   grep "btn-danger" /var/www/the55/app/static/css/style.css
   ```
</verification>

<success_criteria>
- Reopen Capture button visible in CLOSED state
- Clear button visible per submitted member in CAPTURING state
- Both buttons have confirm() dialogs with descriptive warnings
- btn-danger CSS class provides red styling for Clear button
- Existing polling.js handles UI updates (no changes needed)
</success_criteria>

<output>
After completion, create `.planning/phases/20-session-flow-controls/20-02-SUMMARY.md`
</output>
