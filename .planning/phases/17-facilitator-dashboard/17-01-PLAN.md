---
phase: 26-facilitator-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - the55/app/routers/admin.py
  - the55/app/services/auth.py
autonomous: true

must_haves:
  truths:
    - "Dashboard endpoint returns active sessions, recent sessions, and all teams"
    - "Settings endpoint renders password change form"
    - "Password change validates current password before allowing update"
    - "Invalid current password shows error message"
    - "Password mismatch shows error message"
    - "Successful password change shows confirmation"
  artifacts:
    - path: "the55/app/routers/admin.py"
      provides: "Dashboard and settings endpoints"
      exports: ["admin_dashboard", "settings_page", "change_password"]
    - path: "the55/app/services/auth.py"
      provides: "Password update function"
      exports: ["update_password_hash"]
  key_links:
    - from: "the55/app/routers/admin.py"
      to: "the55/app/services/auth.py"
      via: "update_password_hash call"
      pattern: "update_password_hash"
    - from: "the55/app/routers/admin.py"
      to: "the55/app/db/models.py"
      via: "Session query with joinedload"
      pattern: "joinedload.*Session"
---

<objective>
Create dashboard backend endpoints with sessions-first data and self-service password change.

Purpose: The facilitator's mental model is session-oriented (today's meeting, recent history). The current teams-first dashboard doesn't match that workflow. This plan adds the backend queries and password management endpoints.

Output: Updated admin.py router with dashboard data and settings endpoints, updated auth.py with password update function.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-facilitator-dashboard/26-RESEARCH.md
@the55/app/routers/admin.py
@the55/app/routers/sessions.py
@the55/app/services/auth.py
@the55/app/config.py
@the55/app/db/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update admin.py with sessions-first dashboard endpoint</name>
  <files>the55/app/routers/admin.py</files>
  <action>
Update the admin_dashboard endpoint to query and return sessions-first data:

1. Import required modules:
   - `from datetime import datetime`
   - `from sqlalchemy.orm import joinedload`
   - Add Session, SessionState to models import

2. Add helper function `get_current_month()` (copy from sessions.py):
   ```python
   def get_current_month() -> str:
       return datetime.utcnow().strftime("%Y-%m")
   ```

3. Update admin_dashboard to query:
   - `active_sessions`: Current month sessions NOT in REVEALED state, with team data via joinedload, ordered by created_at desc
   - `recent_sessions`: Last 5 REVEALED sessions, with team data, ordered by revealed_at desc
   - `teams`: All teams ordered by company_name, team_name (existing query)

4. Pass to template:
   - active_sessions
   - recent_sessions
   - teams
   - current_month (for one-click session creation links)

Pattern from research:
```python
@router.get("")
async def admin_dashboard(request: Request, auth: AuthDep, db: DbDep):
    """Admin dashboard - sessions-first command center."""
    current_month = get_current_month()

    active_sessions = db.query(Session).options(
        joinedload(Session.team)
    ).filter(
        Session.month == current_month,
        Session.state != SessionState.REVEALED
    ).order_by(Session.created_at.desc()).all()

    recent_sessions = db.query(Session).options(
        joinedload(Session.team)
    ).filter(
        Session.state == SessionState.REVEALED
    ).order_by(Session.revealed_at.desc()).limit(5).all()

    teams = db.query(Team).order_by(Team.company_name, Team.team_name).all()

    return templates.TemplateResponse(
        "admin/dashboard.html",
        {
            "request": request,
            "active_sessions": active_sessions,
            "recent_sessions": recent_sessions,
            "teams": teams,
            "current_month": current_month
        }
    )
```
  </action>
  <verify>Start the app and hit /admin - endpoint should return without error (even if template not updated yet, it will have extra variables)</verify>
  <done>Dashboard endpoint queries active sessions, recent sessions, and teams. Data passed to template context.</done>
</task>

<task type="auto">
  <name>Task 2: Add settings endpoints with password change</name>
  <files>the55/app/routers/admin.py, the55/app/services/auth.py</files>
  <action>
**Part A: Add update_password_hash to auth.py**

Add function to update password hash in .env file:
```python
from pathlib import Path
import re

def update_password_hash(new_hash: str, env_path: str = ".env") -> bool:
    """Update password hash in .env file."""
    path = Path(env_path)
    if not path.exists():
        return False

    content = path.read_text()
    new_content = re.sub(
        r'FACILITATOR_PASSWORD_HASH=.*',
        f'FACILITATOR_PASSWORD_HASH={new_hash}',
        content
    )
    path.write_text(new_content)
    return True
```

**Part B: Add settings routes to admin.py**

1. Add imports:
   - `from fastapi import Form`
   - `from app.services.auth import verify_password, hash_password, update_password_hash`
   - Add SettingsDep to dependencies import

2. Add GET /admin/settings endpoint:
```python
@router.get("/settings")
async def settings_page(request: Request, auth: AuthDep):
    """Facilitator settings page."""
    return templates.TemplateResponse(
        "admin/settings.html",
        {"request": request, "success": None, "error": None}
    )
```

3. Add POST /admin/settings/password endpoint:
```python
@router.post("/settings/password")
async def change_password(
    request: Request,
    auth: AuthDep,
    settings: SettingsDep,
    current_password: str = Form(...),
    new_password: str = Form(...),
    confirm_password: str = Form(...)
):
    """Process password change."""
    # Verify current password
    if not verify_password(current_password, settings.facilitator_password_hash):
        return templates.TemplateResponse(
            "admin/settings.html",
            {"request": request, "error": "Current password is incorrect", "success": None}
        )

    # Validate new password length
    if len(new_password) < 8:
        return templates.TemplateResponse(
            "admin/settings.html",
            {"request": request, "error": "Password must be at least 8 characters", "success": None}
        )

    # Validate passwords match
    if new_password != confirm_password:
        return templates.TemplateResponse(
            "admin/settings.html",
            {"request": request, "error": "Passwords do not match", "success": None}
        )

    # Generate and store new hash
    new_hash = hash_password(new_password)
    if not update_password_hash(new_hash):
        return templates.TemplateResponse(
            "admin/settings.html",
            {"request": request, "error": "Failed to update password file", "success": None}
        )

    return templates.TemplateResponse(
        "admin/settings.html",
        {"request": request, "success": "Password updated successfully. Changes take effect on next restart.", "error": None}
    )
```

Note: Message clarifies restart is needed since Settings are cached with @lru_cache.
  </action>
  <verify>
1. `grep -n "settings" the55/app/routers/admin.py` shows settings routes
2. `grep -n "update_password_hash" the55/app/services/auth.py` shows function exists
  </verify>
  <done>Settings page GET endpoint renders form, POST endpoint validates and updates password hash in .env file.</done>
</task>

</tasks>

<verification>
1. Start the app: `cd /var/www/the55 && source venv/bin/activate && python -m uvicorn app.main:app --reload --port 8055`
2. Login at /admin/login
3. Navigate to /admin - should not error (template variables just won't display yet)
4. Navigate to /admin/settings - should error with template not found (expected - Plan 02 creates template)
</verification>

<success_criteria>
- admin.py has updated dashboard endpoint with active_sessions, recent_sessions, teams
- admin.py has GET /admin/settings and POST /admin/settings/password endpoints
- auth.py has update_password_hash function
- No import errors or syntax errors
</success_criteria>

<output>
After completion, create `.planning/phases/26-facilitator-dashboard/26-01-SUMMARY.md`
</output>
