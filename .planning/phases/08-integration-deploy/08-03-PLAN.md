---
phase: 17-integration-deploy
plan: 03
type: execute
wave: 3
depends_on: ["17-02"]
files_modified:
  - the55/scripts/e2e_test.sh
  - .planning/phases/17-integration-deploy/17-E2E-RESULTS.md
autonomous: false

must_haves:
  truths:
    - "Full flow works: join -> respond -> close -> synthesize -> reveal"
    - "Facilitator login works on production"
    - "Participant can join via team code"
    - "Response submission persists to database"
    - "Synthesis generates correctly with Claude API"
  artifacts:
    - path: "the55/scripts/e2e_test.sh"
      provides: "Automated E2E test script"
      contains: "curl.*55.connecteddale.com"
    - path: ".planning/phases/17-integration-deploy/17-E2E-RESULTS.md"
      provides: "Documentation of test results"
      contains: "Full Flow Test"
  key_links:
    - from: "e2e_test.sh"
      to: "https://55.connecteddale.com"
      via: "curl requests"
      pattern: "https://55\\.connecteddale\\.com"
---

<objective>
Verify end-to-end flow works on production and conduct mobile testing.

Purpose: This is the final verification that all components work together in production. Tests the complete user journey: facilitator creates session, participants join and respond, facilitator closes capture and triggers synthesis, synthesis is revealed to participants.

Output:
- E2E test script for automated verification
- Documented test results
- Mobile testing confirmation on iOS Safari, Chrome, Samsung Internet
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

# API endpoints for reference
@the55/app/routers/auth.py
@the55/app/routers/sessions.py
@the55/app/routers/participant.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create E2E test script</name>
  <files>the55/scripts/e2e_test.sh</files>
  <action>
Create an E2E test script that verifies the full flow via curl:

```bash
#!/bin/bash
# e2e_test.sh - End-to-end production test for The 55
# Tests the complete flow: login -> session -> join -> respond -> close -> synthesize -> reveal

set -e

BASE_URL="https://55.connecteddale.com"
COOKIE_FILE="/tmp/the55_test_cookies.txt"

echo "=== The 55 E2E Production Test ==="
echo "Base URL: $BASE_URL"
echo ""

# Cleanup
rm -f "$COOKIE_FILE"

# 1. Health check
echo "1. Health Check:"
HEALTH=$(curl -s "$BASE_URL/health")
echo "$HEALTH" | grep -q "ok" && echo "   PASS: Health endpoint OK" || { echo "   FAIL: Health check failed"; exit 1; }

# 2. Login page loads
echo ""
echo "2. Login Page:"
curl -s "$BASE_URL/login" | grep -q "Login" && echo "   PASS: Login page loads" || { echo "   FAIL: Login page failed"; exit 1; }

# 3. Participant join page loads
echo ""
echo "3. Participant Join Page:"
curl -s "$BASE_URL/join" | grep -q "Team Code" && echo "   PASS: Join page loads" || { echo "   FAIL: Join page failed"; exit 1; }

# 4. Static files served
echo ""
echo "4. Static Files:"
CSS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/static/css/main.css")
[ "$CSS_STATUS" = "200" ] && echo "   PASS: CSS file served (HTTP $CSS_STATUS)" || { echo "   FAIL: CSS not served (HTTP $CSS_STATUS)"; exit 1; }

# 5. Image endpoint
echo ""
echo "5. Image Endpoint:"
IMG_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/images/01")
[ "$IMG_STATUS" = "200" ] && echo "   PASS: Image endpoint works (HTTP $IMG_STATUS)" || { echo "   FAIL: Image endpoint failed (HTTP $IMG_STATUS)"; exit 1; }

# 6. Test SSL certificate
echo ""
echo "6. SSL Certificate:"
CERT_ISSUER=$(echo | openssl s_client -connect 55.connecteddale.com:443 2>/dev/null | openssl x509 -noout -issuer 2>/dev/null | grep -o "Let's Encrypt" || echo "Unknown")
[ "$CERT_ISSUER" = "Let's Encrypt" ] && echo "   PASS: Valid Let's Encrypt certificate" || echo "   WARN: Certificate issuer: $CERT_ISSUER"

# 7. HTTP redirects to HTTPS
echo ""
echo "7. HTTP->HTTPS Redirect:"
REDIRECT=$(curl -s -o /dev/null -w "%{http_code}" -L "http://55.connecteddale.com/health")
[ "$REDIRECT" = "200" ] && echo "   PASS: HTTP redirects to HTTPS correctly" || { echo "   FAIL: Redirect not working"; exit 1; }

echo ""
echo "=== Automated Tests Complete ==="
echo ""
echo "Manual verification required:"
echo "  - Full session flow (create session, participant join, respond, close, synthesize, reveal)"
echo "  - Mobile testing on iOS Safari, Chrome, Samsung Internet"
echo ""

# Cleanup
rm -f "$COOKIE_FILE"
```

Make executable:
```bash
chmod +x /var/www/the55/scripts/e2e_test.sh
```
  </action>
  <verify>
```bash
/var/www/the55/scripts/e2e_test.sh
```
Expected: All automated tests pass (7/7)
  </verify>
  <done>E2E test script exists and all automated tests pass</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Full flow manual verification</name>
  <what-built>
Complete production deployment with systemd service, nginx reverse proxy, SSL certificate.
All automated E2E tests pass. Now need human verification of full user flow.
  </what-built>
  <how-to-verify>
**Full Flow Test (do this on desktop first):**

1. **Facilitator Login** - https://55.connecteddale.com/login
   - Log in with facilitator credentials
   - Verify dashboard loads with team list

2. **Create Test Session**
   - Select or create a test team with 2-3 members
   - Create new session for current month
   - Verify session appears in DRAFT state

3. **Start Capture**
   - Click "Start Capture" button
   - Verify state changes to CAPTURING
   - Copy the team code shown

4. **Participant Join** (open in incognito/different browser)
   - Go to https://55.connecteddale.com/join
   - Enter team code
   - Select month (current)
   - Select a name from member list
   - Verify strategy statement displays
   - Click "Begin" to proceed

5. **Submit Response**
   - Browse images (verify swipe/pagination works)
   - Select an image
   - Enter 1-3 bullet points
   - Click "Submit Response"
   - Verify "Response Submitted" confirmation

6. **Close Capture** (back to facilitator browser)
   - Verify participant status shows as submitted
   - Click "Close Capture"
   - Verify state changes to CLOSED

7. **Trigger Synthesis**
   - Click "Generate Synthesis" button
   - Wait for synthesis to complete (10-30 seconds)
   - Verify themes, attributed statements, and gap type appear

8. **Reveal to Participants**
   - Click "Reveal to Participants"
   - Verify state changes to REVEALED

9. **Participant Views Synthesis** (back to participant browser)
   - Page should auto-refresh to show synthesis
   - Verify themes, statements, and gap type visible
   - Verify selected images shown

**Mobile Testing (after desktop flow passes):**

10. **iOS Safari** (iPhone/iPad)
    - Complete join -> respond flow
    - Verify: Image browser swipes correctly, bullets input works, zoom doesn't occur

11. **Chrome Mobile** (Android)
    - Complete join -> respond flow
    - Verify: All interactions work, no layout issues

12. **Samsung Internet** (if available)
    - Complete join -> respond flow
    - Verify: Flex gap displays correctly, images load
  </how-to-verify>
  <resume-signal>
Type "verified" if all tests pass, or describe any issues found.
Example: "verified" or "issue: synthesis not appearing after 60 seconds"
  </resume-signal>
</task>

<task type="auto">
  <name>Task 3: Document E2E test results</name>
  <files>.planning/phases/17-integration-deploy/17-E2E-RESULTS.md</files>
  <action>
Create documentation of E2E test results after human verification:

```markdown
# The 55 - End-to-End Test Results

**Tested:** [Current date]
**Environment:** Production (55.connecteddale.com)
**Tester:** [User]

## Automated Tests

| Test | Status |
|------|--------|
| Health endpoint | PASS |
| Login page loads | PASS |
| Join page loads | PASS |
| Static files served | PASS |
| Image endpoint | PASS |
| SSL certificate | PASS |
| HTTP->HTTPS redirect | PASS |

## Full Flow Test

| Step | Status | Notes |
|------|--------|-------|
| Facilitator login | PASS | |
| Create session | PASS | |
| Start capture | PASS | |
| Participant join | PASS | |
| Submit response | PASS | |
| Close capture | PASS | |
| Generate synthesis | PASS | |
| Reveal synthesis | PASS | |
| Participant view | PASS | |

## Mobile Testing

| Device/Browser | Status | Notes |
|----------------|--------|-------|
| iOS Safari | PASS | |
| Chrome Mobile | PASS | |
| Samsung Internet | PASS | |

## Requirements Verification

All v2.0 requirements verified in production:

### Facilitator (FAC-01 to FAC-08)
- [x] FAC-01: Login works
- [x] FAC-02: Real-time submission status visible
- [x] FAC-03: Close capture works
- [x] FAC-04: Reveal synthesis works
- [x] FAC-05: Presentation mode works
- [x] FAC-06: Session history accessible
- [x] FAC-07: Notes and recalibration saved
- [x] FAC-08: Export works

### Team Management (TEAM-01 to TEAM-04)
- [x] All team management features work

### Participant Flow (PART-01 to PART-11)
- [x] All participant features work

### Synthesis (SYNTH-01 to SYNTH-03)
- [x] Themes extracted
- [x] Attributed statements generated
- [x] Gap type diagnosed

### Technical (TECH-01 to TECH-04)
- [x] Mobile responsive
- [x] State machine enforced
- [x] Polling works
- [x] Images display

---

*v2.0 deployment verified and complete*
```

Update placeholders with actual test results from human verification.
  </action>
  <verify>
```bash
test -f /var/www/.planning/phases/17-integration-deploy/17-E2E-RESULTS.md && echo "Results documented"
```
  </verify>
  <done>E2E test results documented with all tests passing</done>
</task>

</tasks>

<verification>
1. All 7 automated tests pass
2. Full flow test completed successfully (9 steps)
3. Mobile testing passed on iOS Safari, Chrome, Samsung Internet
4. All 30 v2.0 requirements verified in production
5. E2E results documented
</verification>

<success_criteria>
- Full flow works: join -> respond -> close -> synthesize -> reveal
- All requirements verified end-to-end
- Mobile testing passed on iOS Safari, Chrome, Samsung Internet
- Results documented for future reference
</success_criteria>

<output>
After completion, create `.planning/phases/17-integration-deploy/17-03-SUMMARY.md`
</output>
