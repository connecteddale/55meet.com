---
phase: 17-integration-deploy
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - /etc/nginx/sites-available/55.connecteddale.com
autonomous: true

must_haves:
  truths:
    - "55.connecteddale.com resolves and serves the app over HTTPS"
    - "HTTP requests redirect to HTTPS"
    - "Static files served directly by nginx for performance"
    - "All app routes proxied to gunicorn backend"
  artifacts:
    - path: "/etc/nginx/sites-available/55.connecteddale.com"
      provides: "nginx virtual host configuration"
      contains: "proxy_pass http://127.0.0.1:8055"
    - path: "/etc/nginx/sites-enabled/55.connecteddale.com"
      provides: "symlink enabling the site"
  key_links:
    - from: "/etc/nginx/sites-available/55.connecteddale.com"
      to: "127.0.0.1:8055"
      via: "proxy_pass upstream"
      pattern: "proxy_pass.*8055"
    - from: "nginx"
      to: "the55.service"
      via: "reverse proxy"
      pattern: "upstream.*the55"
---

<objective>
Configure nginx reverse proxy for 55.connecteddale.com with SSL via Let's Encrypt.

Purpose: nginx handles SSL termination, static file serving, and reverse proxy to the gunicorn backend. The existing server has similar configs for connecteddale.com and gg.connecteddale.com. The 55 app needs its own subdomain configuration.

Output:
- nginx config at /etc/nginx/sites-available/55.connecteddale.com
- Site enabled via symlink
- SSL certificate obtained via certbot
- App accessible at https://55.connecteddale.com
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

# Existing nginx patterns
@/etc/nginx/sites-available/connecteddale.com
@/etc/nginx/sites-available/gg.connecteddale.com

# App structure
@the55/app/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create nginx site configuration</name>
  <files>/etc/nginx/sites-available/55.connecteddale.com</files>
  <action>
Create nginx configuration for 55.connecteddale.com:

```nginx
# /etc/nginx/sites-available/55.connecteddale.com
# The 55 - Leadership Alignment Diagnostics

upstream the55_backend {
    server 127.0.0.1:8055;
}

server {
    server_name 55.connecteddale.com;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Logging
    access_log /var/www/the55/logs/nginx_access.log;
    error_log /var/www/the55/logs/nginx_error.log;

    # Static files - served directly by nginx
    location /static/ {
        alias /var/www/the55/app/static/;
        expires 7d;
        add_header Cache-Control "public, immutable";
    }

    # Health check - direct to backend
    location = /health {
        proxy_pass http://the55_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # All other routes - proxy to FastAPI
    location / {
        proxy_pass http://the55_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeout settings for synthesis (Claude API can take 10-30s)
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # ACME challenge for Let's Encrypt
    location /.well-known/acme-challenge/ {
        root /var/www/the55;
    }

    # HTTP only initially - certbot will add SSL
    listen 80;
}
```

After creating the file:
```bash
# Create symlink to enable site
sudo ln -sf /etc/nginx/sites-available/55.connecteddale.com /etc/nginx/sites-enabled/

# Test nginx config
sudo nginx -t

# Reload nginx
sudo systemctl reload nginx
```
  </action>
  <verify>
```bash
sudo nginx -t && curl -s -o /dev/null -w "%{http_code}" http://55.connecteddale.com/health
```
Expected: nginx config valid, HTTP 200 from health endpoint
  </verify>
  <done>nginx configuration exists, enabled, and proxying to backend on port 8055</done>
</task>

<task type="auto">
  <name>Task 2: Obtain SSL certificate with certbot</name>
  <files>/etc/nginx/sites-available/55.connecteddale.com</files>
  <action>
Obtain Let's Encrypt SSL certificate using certbot:

```bash
sudo certbot --nginx -d 55.connecteddale.com
```

Certbot will:
1. Verify domain ownership via ACME challenge
2. Obtain SSL certificate
3. Modify nginx config to add SSL listeners (443) and redirect (80->443)
4. Set up auto-renewal

After certbot completes, verify the modified config includes:
- `listen 443 ssl;`
- `ssl_certificate /etc/letsencrypt/live/55.connecteddale.com/fullchain.pem;`
- `ssl_certificate_key /etc/letsencrypt/live/55.connecteddale.com/privkey.pem;`
- HTTP to HTTPS redirect block

If certbot prompts for redirect, select option 2 (Redirect).
  </action>
  <verify>
```bash
curl -s -o /dev/null -w "%{http_code}" https://55.connecteddale.com/health
```
Expected: HTTP 200 over HTTPS
  </verify>
  <done>SSL certificate installed, HTTPS working, HTTP redirects to HTTPS</done>
</task>

</tasks>

<verification>
1. `curl -I http://55.connecteddale.com/` returns 301 redirect to https://
2. `curl https://55.connecteddale.com/health` returns `{"status":"ok"}`
3. `curl https://55.connecteddale.com/login` returns login page HTML
4. Static files load: `curl -I https://55.connecteddale.com/static/css/main.css` returns 200 with Cache-Control header
5. SSL certificate valid: `echo | openssl s_client -connect 55.connecteddale.com:443 2>/dev/null | openssl x509 -noout -dates`
</verification>

<success_criteria>
- https://55.connecteddale.com loads the app
- HTTP automatically redirects to HTTPS
- SSL certificate is valid Let's Encrypt cert
- Static files served with caching headers
- All routes accessible through nginx proxy
</success_criteria>

<output>
After completion, create `.planning/phases/17-integration-deploy/17-02-SUMMARY.md`
</output>
