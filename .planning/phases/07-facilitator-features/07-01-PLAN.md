---
phase: 16-facilitator-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - the55/app/routers/sessions.py
  - the55/app/templates/admin/sessions/view.html
autonomous: true

must_haves:
  truths:
    - "Facilitator can enter and save notes during a revealed session"
    - "Facilitator can enter and save recalibration action during a revealed session"
    - "Notes and recalibration persist across page reloads"
    - "Session view shows existing notes and action for editing"
  artifacts:
    - path: "the55/app/routers/sessions.py"
      provides: "POST endpoint for saving notes and recalibration"
      exports: ["update_notes"]
    - path: "the55/app/templates/admin/sessions/view.html"
      provides: "Forms for entering notes and recalibration action"
      contains: "facilitator_notes"
  key_links:
    - from: "the55/app/templates/admin/sessions/view.html"
      to: "/admin/sessions/{id}/notes"
      via: "form action POST"
      pattern: "action=\"/admin/sessions/.*?/notes\""
    - from: "the55/app/routers/sessions.py"
      to: "the55/app/db/models.py"
      via: "Session model update"
      pattern: "session\\.facilitator_notes"
---

<objective>
Enable facilitator to record session notes and recalibration action after synthesis reveal.

Purpose: The 55 process concludes with the team agreeing on ONE recalibration action. The facilitator needs to record this action along with any session notes. These persist for history/reference.

Output:
- Notes save endpoint in sessions router
- Updated session view template with editable forms
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

# Existing patterns
@the55/app/routers/sessions.py
@the55/app/templates/admin/sessions/view.html
@the55/app/db/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add notes and recalibration endpoint</name>
  <files>the55/app/routers/sessions.py</files>
  <action>
Add a new POST endpoint to save facilitator notes and recalibration action:

1. Add new endpoint `@router.post("/{session_id}/notes")`:
   - Function: `update_session_notes(session_id: int, auth: AuthDep, db: DbDep, facilitator_notes: str = Form(None), recalibration_action: str = Form(None))`
   - Fetch session by ID, 404 if not found
   - Session must be in REVEALED state (400 error otherwise - notes are recorded after synthesis)
   - Update session.facilitator_notes if provided (strip whitespace, set to None if empty)
   - Update session.recalibration_action if provided (strip whitespace, set to None if empty)
   - Commit changes
   - Redirect to session view (303)

Note: The existing `mark_recalibration_complete` endpoint at `/{session_id}/recalibration` handles the completion toggle - keep it unchanged.
  </action>
  <verify>
```bash
cd /var/www/the55 && source venv/bin/activate && python -c "
from app.routers.sessions import router
routes = [r.path for r in router.routes]
print('Routes:', routes)
assert '/{session_id}/notes' in routes, 'Notes route missing'
print('Notes endpoint exists')
"
```
  </verify>
  <done>POST endpoint at /{session_id}/notes saves facilitator_notes and recalibration_action</done>
</task>

<task type="auto">
  <name>Task 2: Update session view with notes forms</name>
  <files>the55/app/templates/admin/sessions/view.html</files>
  <action>
Update the session view template to show editable forms for notes and recalibration action in REVEALED state:

1. Replace the existing recalibration card content (lines ~123-141) with a more comprehensive section:

In the `{% if session.state.value == 'revealed' %}` block, create two cards:

**Facilitator Notes Card:**
- Show existing notes (if any) in a display paragraph
- Collapsible form to edit notes
- Textarea for facilitator_notes
- Save button

**Recalibration Action Card:**
- Show existing recalibration_action text
- If no action recorded, show input form
- If action exists, show text with edit toggle
- Textarea for recalibration_action
- "Mark Complete" toggle (keep existing functionality)

Structure the forms:
```html
<div class="card">
    <h3>Facilitator Notes</h3>
    <form method="post" action="/admin/sessions/{{ session.id }}/notes">
        <div class="form-group">
            <textarea name="facilitator_notes" rows="4" placeholder="Session observations, context, follow-up items...">{{ session.facilitator_notes or '' }}</textarea>
        </div>
        <button type="submit" class="btn btn-primary btn-small">Save Notes</button>
    </form>
</div>

<div class="card">
    <h3>Recalibration Action</h3>
    {% if session.recalibration_action %}
    <p class="recalibration-text">{{ session.recalibration_action }}</p>
    {% endif %}
    <form method="post" action="/admin/sessions/{{ session.id }}/notes">
        <div class="form-group">
            <textarea name="recalibration_action" rows="2" placeholder="ONE action the team commits to...">{{ session.recalibration_action or '' }}</textarea>
        </div>
        <button type="submit" class="btn btn-primary btn-small">Save Action</button>
    </form>
    {% if session.recalibration_action %}
    <form method="post" action="/admin/sessions/{{ session.id }}/recalibration" style="margin-top: var(--space-3);">
        <input type="hidden" name="completed" value="{{ 'false' if session.recalibration_completed else 'true' }}">
        <button type="submit" class="btn {% if session.recalibration_completed %}btn-secondary{% else %}btn-primary{% endif %} btn-small">
            {% if session.recalibration_completed %}Mark Incomplete{% else %}Mark Complete{% endif %}
        </button>
    </form>
    {% endif %}
</div>
```

Note: Using separate form submissions for clarity. Each form only submits its own field.
  </action>
  <verify>
```bash
grep -q "facilitator_notes" /var/www/the55/app/templates/admin/sessions/view.html && \
grep -q 'action="/admin/sessions/{{ session.id }}/notes"' /var/www/the55/app/templates/admin/sessions/view.html && \
echo "Template updated with notes forms"
```
  </verify>
  <done>Session view shows editable forms for notes and recalibration action in REVEALED state</done>
</task>

</tasks>

<verification>
1. Notes endpoint accepts POST with facilitator_notes and recalibration_action
2. Session view displays forms in REVEALED state
3. Existing values pre-populate textarea fields
4. Save redirects back to session view
5. Existing recalibration completion toggle still works
</verification>

<success_criteria>
- Facilitator can save notes on a revealed session
- Facilitator can record recalibration action text
- Notes persist on page reload
- Mark complete toggle still functions for recalibration tracking
</success_criteria>

<output>
After completion, create `.planning/phases/16-facilitator-features/16-01-SUMMARY.md`
</output>
