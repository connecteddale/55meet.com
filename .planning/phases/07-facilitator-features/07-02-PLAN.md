---
phase: 16-facilitator-features
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - the55/app/routers/sessions.py
  - the55/app/templates/admin/sessions/history.html
  - the55/app/templates/admin/dashboard.html
  - the55/app/static/css/main.css
autonomous: true

must_haves:
  truths:
    - "Facilitator can view a list of all sessions across all teams"
    - "History shows session month, team, state, and completion status"
    - "Facilitator can click through to any session detail"
    - "Sessions are sorted by date (most recent first)"
    - "Facilitator can navigate to history from dashboard"
  artifacts:
    - path: "the55/app/routers/sessions.py"
      provides: "GET endpoint for session history"
      exports: ["session_history"]
    - path: "the55/app/templates/admin/sessions/history.html"
      provides: "History page listing all sessions"
      contains: "session-history"
    - path: "the55/app/templates/admin/dashboard.html"
      provides: "Dashboard with history navigation"
      contains: "Session History"
  key_links:
    - from: "the55/app/templates/admin/sessions/history.html"
      to: "/admin/sessions/{id}"
      via: "session link"
      pattern: "href=\"/admin/sessions/\\{\\{ session.id \\}\\}\""
    - from: "the55/app/routers/sessions.py"
      to: "the55/app/db/models.py"
      via: "Session query with Team join"
      pattern: "db\\.query\\(Session\\)"
    - from: "the55/app/templates/admin/dashboard.html"
      to: "/admin/sessions/history"
      via: "navigation link"
      pattern: "href=\"/admin/sessions/history\""
---

<objective>
Create a session history view showing all sessions across all teams.

Purpose: The facilitator needs to access any team's past sessions for review, follow-up, or reference during coaching conversations. This provides a single view of all session activity.

Output:
- History endpoint in sessions router
- New history template page
- Dashboard navigation link to history
- Minor CSS for history list styling
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

# Existing patterns
@the55/app/routers/sessions.py
@the55/app/templates/admin/sessions/list.html
@the55/app/templates/admin/dashboard.html
@the55/app/static/css/main.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add session history endpoint</name>
  <files>the55/app/routers/sessions.py</files>
  <action>
Add a GET endpoint for viewing all sessions across teams:

1. Add new endpoint `@router.get("/history")` BEFORE the `/{session_id}` routes (order matters in FastAPI):
   - Function: `session_history(request: Request, auth: AuthDep, db: DbDep)`
   - Query all sessions ordered by month DESC (most recent first)
   - Use joinedload to eagerly load team relationship for each session
   - Return template response with sessions list

Add import at top if not present:
```python
from sqlalchemy.orm import joinedload
```

Endpoint implementation:
```python
@router.get("/history")
async def session_history(request: Request, auth: AuthDep, db: DbDep):
    """View all sessions across all teams."""
    sessions = db.query(Session).options(
        joinedload(Session.team)
    ).order_by(Session.month.desc()).all()

    return templates.TemplateResponse(
        "admin/sessions/history.html",
        {"request": request, "sessions": sessions}
    )
```

IMPORTANT: This route MUST be defined before `@router.get("/{session_id}")` otherwise FastAPI will try to match "history" as a session_id integer and fail.
  </action>
  <verify>
```bash
cd /var/www/the55 && source venv/bin/activate && python -c "
from app.routers.sessions import router
routes = [r.path for r in router.routes if hasattr(r, 'path')]
print('Routes:', routes)
# Check /history exists
assert '/history' in routes, 'History route missing'
print('History endpoint exists')
"
```
  </verify>
  <done>GET endpoint at /admin/sessions/history returns all sessions with team data</done>
</task>

<task type="auto">
  <name>Task 2: Create history template</name>
  <files>the55/app/templates/admin/sessions/history.html</files>
  <action>
Create a new template for the session history view:

```html
{% extends "base.html" %}

{% block title %}Session History - The 55{% endblock %}

{% block nav %}
<nav>
    <a href="/admin" class="btn btn-secondary">Dashboard</a>
</nav>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Session History</h2>
    </div>

    {% if sessions %}
    <div class="history-list">
        {% for session in sessions %}
        <a href="/admin/sessions/{{ session.id }}" class="history-item">
            <div class="history-main">
                <div class="history-month">{{ session.month }}</div>
                <div class="history-team">{{ session.team.company_name }} - {{ session.team.team_name }}</div>
            </div>
            <div class="history-meta">
                <span class="session-state state-{{ session.state.value }}">{{ session.state.value }}</span>
                {% if session.recalibration_action %}
                <span class="history-badge {% if session.recalibration_completed %}completed{% endif %}">
                    {% if session.recalibration_completed %}Action Done{% else %}Action Set{% endif %}
                </span>
                {% endif %}
            </div>
        </a>
        {% endfor %}
    </div>
    {% else %}
    <p class="empty-state">No sessions yet. Create a session from a team page to get started.</p>
    {% endif %}
</div>
{% endblock %}
```

This follows the existing pattern from `admin/sessions/list.html` but shows all teams.
  </action>
  <verify>
```bash
test -f /var/www/the55/app/templates/admin/sessions/history.html && \
grep -q "Session History" /var/www/the55/app/templates/admin/sessions/history.html && \
grep -q "history-list" /var/www/the55/app/templates/admin/sessions/history.html && \
echo "History template created"
```
  </verify>
  <done>History template shows all sessions grouped by date with team info</done>
</task>

<task type="auto">
  <name>Task 3: Add history list styles</name>
  <files>the55/app/static/css/main.css</files>
  <action>
Add CSS styles for the history list at the end of main.css:

```css
/* ========================================
   Session History
   ======================================== */

.history-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.history-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-4);
    background: var(--color-bg);
    border-radius: 4px;
    border: 1px solid var(--color-border);
    text-decoration: none;
    color: inherit;
    transition: border-color var(--transition-fast);
}

.history-item:hover {
    border-color: var(--color-primary);
    text-decoration: none;
}

.history-main {
    flex: 1;
}

.history-month {
    font-weight: 600;
    font-size: var(--font-size-lg);
}

.history-team {
    font-size: var(--font-size-sm);
    color: var(--color-text-muted);
    margin-top: var(--space-1);
}

.history-meta {
    display: flex;
    gap: var(--space-2);
    align-items: center;
}

.history-badge {
    font-size: var(--font-size-xs);
    padding: var(--space-1) var(--space-2);
    border-radius: 4px;
    background: #fef3c7;
    color: #92400e;
}

.history-badge.completed {
    background: #dcfce7;
    color: var(--color-success);
}
```

These styles follow existing patterns from .session-list and .team-list.
  </action>
  <verify>
```bash
grep -q "history-list" /var/www/the55/app/static/css/main.css && \
grep -q "history-item" /var/www/the55/app/static/css/main.css && \
echo "History styles added"
```
  </verify>
  <done>CSS styles for history list match existing design patterns</done>
</task>

<task type="auto">
  <name>Task 4: Add history link to dashboard</name>
  <files>the55/app/templates/admin/dashboard.html</files>
  <action>
Update the dashboard template to include a navigation link to the session history page.

Add a new dashboard section after the Teams section (before the closing `</div>` of `.dashboard`):

```html
    <div class="dashboard-section">
        <div class="section-header">
            <h3>Sessions</h3>
            <a href="/admin/sessions/history" class="btn btn-secondary">View All History</a>
        </div>
        <p class="section-description">Access all sessions across all teams for review and follow-up.</p>
    </div>
```

This provides a clear navigation path from the main dashboard to the session history view.
  </action>
  <verify>
```bash
grep -q '/admin/sessions/history' /var/www/the55/app/templates/admin/dashboard.html && \
grep -q 'Session' /var/www/the55/app/templates/admin/dashboard.html && \
echo "Dashboard history link added"
```
  </verify>
  <done>Dashboard includes navigation link to /admin/sessions/history</done>
</task>

</tasks>

<verification>
1. /admin/sessions/history route returns 200
2. History page shows all sessions from all teams
3. Sessions sorted by month descending
4. Each session links to its detail page
5. State badges display correctly
6. Dashboard has visible link to session history
</verification>

<success_criteria>
- Facilitator sees all sessions across teams on one page
- Most recent sessions appear first
- Session state visible at a glance
- Click navigates to session detail
- Recalibration status visible (set/done)
- History is accessible from dashboard navigation
</success_criteria>

<output>
After completion, create `.planning/phases/16-facilitator-features/16-02-SUMMARY.md`
</output>
