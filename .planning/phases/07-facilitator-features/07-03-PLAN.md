---
phase: 16-facilitator-features
plan: 03
type: execute
wave: 2
depends_on: ["16-01", "16-02"]
files_modified:
  - the55/app/routers/sessions.py
  - the55/app/templates/admin/sessions/present.html
  - the55/app/static/css/main.css
autonomous: true

must_haves:
  truths:
    - "Facilitator can view presentation mode (projector-friendly)"
    - "Presentation shows synthesis themes, gap type, and attributed statements"
    - "Facilitator can export session results as JSON"
    - "Presentation mode has clean, large-text layout suitable for screen sharing"
  artifacts:
    - path: "the55/app/routers/sessions.py"
      provides: "Present and export endpoints"
      exports: ["present_session", "export_session"]
    - path: "the55/app/templates/admin/sessions/present.html"
      provides: "Projector-friendly presentation view"
      contains: "presentation-mode"
  key_links:
    - from: "the55/app/templates/admin/sessions/view.html"
      to: "/admin/sessions/{id}/present"
      via: "presentation link"
      pattern: "href=\"/admin/sessions/.*?/present\""
    - from: "the55/app/routers/sessions.py"
      to: "the55/app/db/models.py"
      via: "Session and Response query for export"
      pattern: "db\\.query\\(Response\\)"
---

<objective>
Create presentation mode and export functionality for completed sessions.

Purpose: During The 55 facilitation, Dale projects synthesis results to the team for discussion. Presentation mode provides a clean, large-text view optimized for this. Export allows saving session data for records or follow-up.

Output:
- Present endpoint returning projector-friendly template
- Export endpoint returning JSON data
- Presentation template with large, readable layout
- Link from session view to presentation mode
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

# Existing patterns
@the55/app/routers/sessions.py
@the55/app/templates/admin/sessions/view.html
@the55/app/templates/participant/synthesis.html
@the55/app/static/css/main.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add presentation and export endpoints</name>
  <files>the55/app/routers/sessions.py</files>
  <action>
Add two new endpoints for presentation mode and export:

1. Add presentation endpoint `@router.get("/{session_id}/present")`:
```python
@router.get("/{session_id}/present")
async def present_session(request: Request, session_id: int, auth: AuthDep, db: DbDep):
    """Projector-friendly presentation view of synthesis."""
    session = db.query(Session).filter(Session.id == session_id).first()
    if not session:
        raise HTTPException(status_code=404, detail="Session not found")

    if session.state != SessionState.REVEALED:
        return RedirectResponse(url=f"/admin/sessions/{session_id}", status_code=303)

    # Parse synthesis statements
    synthesis_statements = None
    if session.synthesis_statements:
        try:
            synthesis_statements = json.loads(session.synthesis_statements)
        except (json.JSONDecodeError, TypeError):
            synthesis_statements = []

    return templates.TemplateResponse(
        "admin/sessions/present.html",
        {
            "request": request,
            "session": session,
            "team": session.team,
            "synthesis_themes": session.synthesis_themes,
            "synthesis_statements": synthesis_statements,
            "synthesis_gap_type": session.synthesis_gap_type
        }
    )
```

2. Add export endpoint `@router.get("/{session_id}/export")`:
```python
@router.get("/{session_id}/export")
async def export_session(session_id: int, auth: AuthDep, db: DbDep):
    """Export session data as JSON."""
    session = db.query(Session).filter(Session.id == session_id).first()
    if not session:
        raise HTTPException(status_code=404, detail="Session not found")

    team = session.team
    responses = db.query(Response).filter(Response.session_id == session_id).all()

    # Build response data
    response_data = []
    for r in responses:
        member = db.query(Member).filter(Member.id == r.member_id).first()
        response_data.append({
            "participant": member.name if member else "Unknown",
            "image_number": r.image_number,
            "bullets": json.loads(r.bullets) if r.bullets else [],
            "submitted_at": r.submitted_at.isoformat() if r.submitted_at else None
        })

    # Parse synthesis statements
    synthesis_statements = None
    if session.synthesis_statements:
        try:
            synthesis_statements = json.loads(session.synthesis_statements)
        except (json.JSONDecodeError, TypeError):
            synthesis_statements = []

    export_data = {
        "session": {
            "id": session.id,
            "month": session.month,
            "state": session.state.value,
            "created_at": session.created_at.isoformat() if session.created_at else None,
            "closed_at": session.closed_at.isoformat() if session.closed_at else None,
            "revealed_at": session.revealed_at.isoformat() if session.revealed_at else None
        },
        "team": {
            "company_name": team.company_name,
            "team_name": team.team_name,
            "strategy_statement": team.strategy_statement
        },
        "responses": response_data,
        "synthesis": {
            "themes": session.synthesis_themes,
            "statements": synthesis_statements,
            "gap_type": session.synthesis_gap_type
        },
        "facilitator": {
            "notes": session.facilitator_notes,
            "recalibration_action": session.recalibration_action,
            "recalibration_completed": session.recalibration_completed
        }
    }

    return JSONResponse(
        content=export_data,
        headers={"Content-Disposition": f"attachment; filename=session-{session.month}-{team.team_name}.json"}
    )
```

Add Member import at top if not present:
```python
from app.db.models import Team, Member, Session, Response, SessionState
```
  </action>
  <verify>
```bash
cd /var/www/the55 && source venv/bin/activate && python -c "
from app.routers.sessions import router
routes = [r.path for r in router.routes if hasattr(r, 'path')]
print('Routes:', routes)
assert '/{session_id}/present' in routes, 'Present route missing'
assert '/{session_id}/export' in routes, 'Export route missing'
print('Present and Export endpoints exist')
"
```
  </verify>
  <done>Present and export endpoints available at /{session_id}/present and /{session_id}/export</done>
</task>

<task type="auto">
  <name>Task 2: Create presentation template</name>
  <files>the55/app/templates/admin/sessions/present.html</files>
  <action>
Create a projector-friendly presentation template:

```html
{% extends "base.html" %}

{% block title %}{{ team.team_name }} - {{ session.month }} | The 55{% endblock %}

{% block head %}
<style>
    /* Presentation-specific overrides for projector mode */
    body { background: #000; color: #fff; }
    header { display: none; }
    main { padding: 0; }
    .container { max-width: 1200px; }
</style>
{% endblock %}

{% block body_class %} class="presentation-mode"{% endblock %}

{% block header %}{% endblock %}

{% block content %}
<div class="presentation-container">
    <div class="presentation-header">
        <div class="presentation-team">{{ team.company_name }} &middot; {{ team.team_name }}</div>
        <div class="presentation-month">{{ session.month }}</div>
    </div>

    {% if synthesis_themes %}
    <div class="presentation-section">
        <h2 class="presentation-label">What We Heard</h2>
        <p class="presentation-themes">{{ synthesis_themes }}</p>
    </div>
    {% endif %}

    {% if synthesis_gap_type %}
    <div class="presentation-section">
        <h2 class="presentation-label">Primary Gap</h2>
        <div class="presentation-gap gap-{{ synthesis_gap_type|lower }}">
            {{ synthesis_gap_type }}
        </div>
        <p class="presentation-gap-desc">
            {% if synthesis_gap_type == "Direction" %}
            Team members see different destinations. Where are we going?
            {% elif synthesis_gap_type == "Alignment" %}
            Team members are pulling in different directions. How do our efforts connect?
            {% elif synthesis_gap_type == "Commitment" %}
            Individual priorities outweigh collective goals. What will we sacrifice?
            {% endif %}
        </p>
    </div>
    {% endif %}

    {% if synthesis_statements %}
    <div class="presentation-section">
        <h2 class="presentation-label">Key Insights</h2>
        <ul class="presentation-insights">
            {% for stmt in synthesis_statements %}
            <li>
                <span class="insight-statement">{{ stmt.statement }}</span>
                <span class="insight-names">({{ stmt.participants|join(', ') }})</span>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {% if session.recalibration_action %}
    <div class="presentation-section presentation-action">
        <h2 class="presentation-label">Recalibration Action</h2>
        <p class="presentation-action-text">{{ session.recalibration_action }}</p>
    </div>
    {% endif %}

    <div class="presentation-footer">
        <a href="/admin/sessions/{{ session.id }}" class="exit-presentation">Exit Presentation</a>
    </div>
</div>
{% endblock %}
```

This template:
- Hides header for clean projection
- Uses dark background with white text (easier on eyes in meeting rooms)
- Large, readable text sizes
- Clear section separation
- Exit link to return to admin view
  </action>
  <verify>
```bash
test -f /var/www/the55/app/templates/admin/sessions/present.html && \
grep -q "presentation-mode" /var/www/the55/app/templates/admin/sessions/present.html && \
grep -q "What We Heard" /var/www/the55/app/templates/admin/sessions/present.html && \
echo "Presentation template created"
```
  </verify>
  <done>Presentation template provides clean, projector-friendly synthesis view</done>
</task>

<task type="auto">
  <name>Task 3: Add presentation styles and session view links</name>
  <files>the55/app/static/css/main.css</files>
  <action>
Add CSS styles for presentation mode at the end of main.css:

```css
/* ========================================
   Presentation Mode
   ======================================== */

.presentation-mode {
    background: #1a1a2e;
    color: #eaeaea;
    min-height: 100vh;
}

.presentation-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: var(--space-8);
}

.presentation-header {
    text-align: center;
    margin-bottom: var(--space-8);
    padding-bottom: var(--space-6);
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.presentation-team {
    font-size: var(--font-size-lg);
    color: rgba(255,255,255,0.6);
    margin-bottom: var(--space-2);
}

.presentation-month {
    font-size: var(--font-size-3xl);
    font-weight: 700;
}

.presentation-section {
    margin-bottom: var(--space-8);
}

.presentation-label {
    font-size: var(--font-size-sm);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: rgba(255,255,255,0.5);
    margin-bottom: var(--space-4);
}

.presentation-themes {
    font-size: 1.5rem;
    line-height: 1.6;
}

.presentation-gap {
    display: inline-block;
    font-size: 2rem;
    font-weight: 700;
    padding: var(--space-3) var(--space-6);
    border-radius: 8px;
    margin-bottom: var(--space-3);
}

.presentation-gap.gap-direction {
    background: #3B82F6;
    color: white;
}

.presentation-gap.gap-alignment {
    background: #F59E0B;
    color: white;
}

.presentation-gap.gap-commitment {
    background: #10B981;
    color: white;
}

.presentation-gap-desc {
    font-size: 1.125rem;
    color: rgba(255,255,255,0.7);
}

.presentation-insights {
    list-style: none;
    padding: 0;
    margin: 0;
}

.presentation-insights li {
    padding: var(--space-4) 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    font-size: 1.25rem;
}

.presentation-insights li:last-child {
    border-bottom: none;
}

.insight-statement {
    display: block;
    margin-bottom: var(--space-2);
}

.insight-names {
    font-size: var(--font-size-sm);
    color: rgba(255,255,255,0.5);
}

.presentation-action {
    background: rgba(255,255,255,0.05);
    padding: var(--space-6);
    border-radius: 8px;
    border-left: 4px solid #10B981;
}

.presentation-action-text {
    font-size: 1.5rem;
    font-weight: 600;
}

.presentation-footer {
    margin-top: var(--space-12);
    text-align: center;
}

.exit-presentation {
    color: rgba(255,255,255,0.4);
    font-size: var(--font-size-sm);
}

.exit-presentation:hover {
    color: rgba(255,255,255,0.7);
}
```
  </action>
  <verify>
```bash
grep -q "presentation-mode" /var/www/the55/app/static/css/main.css && \
grep -q "presentation-container" /var/www/the55/app/static/css/main.css && \
grep -q "presentation-gap" /var/www/the55/app/static/css/main.css && \
echo "Presentation styles added"
```
  </verify>
  <done>CSS styles for presentation mode provide dark, readable projector layout</done>
</task>

<task type="auto">
  <name>Task 4: Add presentation and export links to session view</name>
  <files>the55/app/templates/admin/sessions/view.html</files>
  <action>
Update the session view template to include links to presentation mode and export for revealed sessions.

Find the `{% if session.state.value == 'revealed' %}` block that shows "Session complete" message (~line 75-79) and add action links:

Replace the session-complete div content:
```html
{% elif session.state.value == 'revealed' %}
<div class="session-complete">
    <p>Session complete. Synthesis revealed to participants.</p>
    <div class="session-actions" style="margin-top: var(--space-4);">
        <a href="/admin/sessions/{{ session.id }}/present" class="btn btn-primary">
            Presentation Mode
        </a>
        <a href="/admin/sessions/{{ session.id }}/export" class="btn btn-secondary">
            Export JSON
        </a>
    </div>
</div>
{% endif %}
```

This adds clear action buttons for the facilitator to access presentation mode or download session data.
  </action>
  <verify>
```bash
grep -q 'href="/admin/sessions/{{ session.id }}/present"' /var/www/the55/app/templates/admin/sessions/view.html && \
grep -q 'href="/admin/sessions/{{ session.id }}/export"' /var/www/the55/app/templates/admin/sessions/view.html && \
echo "Presentation and export links added to session view"
```
  </verify>
  <done>Session view shows presentation mode and export buttons in REVEALED state</done>
</task>

</tasks>

<verification>
1. /admin/sessions/{id}/present returns presentation view for revealed sessions
2. /admin/sessions/{id}/present redirects for non-revealed sessions
3. /admin/sessions/{id}/export returns JSON with session data
4. Presentation mode displays synthesis clearly with large text
5. Export includes all session data (team, responses, synthesis, facilitator notes)
6. Session view shows buttons to access both features
</verification>

<success_criteria>
- Facilitator can enter presentation mode from session view
- Presentation is clean and readable on projector (dark background, large text)
- Gap type displayed prominently with color coding
- Export downloads JSON file with complete session data
- Exit link returns to admin session view
</success_criteria>

<output>
After completion, create `.planning/phases/16-facilitator-features/16-03-SUMMARY.md`
</output>
