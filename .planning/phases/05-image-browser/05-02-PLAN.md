---
phase: 14-image-browser
plan: 02
type: execute
wave: 1
depends_on: ["14-01"]
files_modified:
  - the55/app/templates/participant/respond.html
  - the55/app/routers/participant.py
  - the55/app/static/css/main.css
autonomous: true

must_haves:
  truths:
    - "Participant can enter 1-5 bullet points"
    - "Bullets are validated (non-empty, max 5)"
    - "Response is saved to database"
    - "Participant is redirected to waiting page after submit"
  artifacts:
    - path: "the55/app/templates/participant/respond.html"
      provides: "Bullet input form section"
      contains: "bullet"
    - path: "the55/app/routers/participant.py"
      provides: "Response submission handling"
      contains: "bullets"
  key_links:
    - from: "respond.html form"
      to: "POST /respond"
      via: "form submission"
    - from: "POST /respond"
      to: "Response model insert"
      via: "db.add(response)"
---

<objective>
Implement bullet point input form with validation and submission.

Purpose: Enable participants to explain their image selection with 1-5 bullet points.
Output: Bullet input UI, form validation, response persistence.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/research/PITFALLS.md

# Prior plan
@.planning/phases/14-image-browser/14-01-PLAN.md

# Source files
@the55/app/routers/participant.py
@the55/app/db/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add bullet point input section to respond template</name>
  <files>the55/app/templates/participant/respond.html</files>
  <action>
Extend respond.html with bullet point input section (after image selection):

1. Section container (initially hidden until image selected):
   - Header: "Why does this image represent where you are?"
   - Instruction: "Enter 1-5 bullet points"

2. Bullet input fields:
   - 5 text inputs, each with:
     - Placeholder: "Bullet point 1", "Bullet point 2 (optional)", etc.
     - 16px font-size minimum (BC-4: prevents iOS zoom)
     - min-height: 44px (Apple touch target)
   - First bullet required, bullets 2-5 optional
   - Each input stores to hidden JSON field on change

3. Form structure:
   - Hidden input: image_number (populated by selection)
   - Hidden input: bullets (JSON array, updated by JS)
   - Submit button: "Submit Response"
   - Button disabled until image selected AND at least 1 bullet

4. Draft persistence (UX-3):
   - On input change: save to localStorage with key `draft-{session_id}-{member_id}`
   - On page load: restore from localStorage if exists
   - On successful submit: clear localStorage

5. Submit button feedback (UX-1):
   - On click: disable button, change text to "Submitting..."
   - On error: re-enable, show error message
   - Form action: POST to current URL

6. Pre-populate for edit:
   - If existing_response, parse bullets JSON and fill inputs
   - Set image selection from existing_response.image_number
  </action>
  <verify>Template shows bullet inputs after image selection</verify>
  <done>Bullet input form with validation and draft saving</done>
</task>

<task type="auto">
  <name>Task 2: Implement response submission in router</name>
  <files>the55/app/routers/participant.py</files>
  <action>
Update POST handler for respond endpoint:

1. Parse form data:
   - image_number: int, validate 1-55
   - bullets: string (JSON array), parse and validate

2. Validation:
   - Session must be in CAPTURING state (else HTTPException 400)
   - image_number between 1-55
   - bullets must be valid JSON array
   - At least 1 bullet, max 5 bullets
   - Each bullet: strip whitespace, reject if empty after strip
   - Each bullet max 500 chars

3. Check for existing response:
   ```python
   existing = db.query(Response).filter(
       Response.session_id == session_id,
       Response.member_id == member_id
   ).first()
   ```

4. If existing: UPDATE
   ```python
   existing.image_number = image_number
   existing.bullets = bullets_json
   existing.updated_at = datetime.utcnow()
   ```

5. If new: INSERT
   ```python
   response = Response(
       session_id=session_id,
       member_id=member_id,
       image_number=image_number,
       bullets=bullets_json
   )
   db.add(response)
   ```

6. Commit and redirect to waiting page

7. Error handling:
   - If validation fails: re-render form with error message
   - If session state changed: redirect with flash message
  </action>
  <verify>
curl -X POST with valid data returns redirect to waiting
curl -X POST with invalid data returns error
  </verify>
  <done>Response submission creates/updates Response record</done>
</task>

<task type="auto">
  <name>Task 3: Add bullet input CSS</name>
  <files>the55/app/static/css/main.css</files>
  <action>
Add CSS for bullet point inputs:

```css
/* Bullet Input Section */
.bullet-section {
  margin-top: 1.5rem;
  padding: 1rem;
  background: var(--gray-50);
  border-radius: 8px;
}

.bullet-section h3 {
  font-size: 1rem;
  margin-bottom: 0.5rem;
}

.bullet-section p {
  font-size: 0.875rem;
  color: var(--gray-600);
  margin-bottom: 1rem;
}

.bullet-input {
  width: 100%;
  font-size: 16px;  /* BC-4: Prevents iOS zoom */
  min-height: 44px; /* Apple touch target */
  padding: 0.75rem;
  border: 1px solid var(--gray-300);
  border-radius: 4px;
  margin-bottom: 0.5rem;
}

.bullet-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);
}

.bullet-input::placeholder {
  color: var(--gray-400);
}

/* Submit button */
.submit-section {
  margin-top: 1.5rem;
  padding: 1rem;
}

.btn-submit {
  width: 100%;
  padding: 1rem;
  font-size: 1rem;
  font-weight: 600;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

.btn-submit:disabled {
  background: var(--gray-300);
  cursor: not-allowed;
}

.btn-submit.loading {
  opacity: 0.7;
}

/* Error messages */
.form-error {
  background: #fee2e2;
  color: #dc2626;
  padding: 0.75rem;
  border-radius: 4px;
  margin-bottom: 1rem;
  font-size: 0.875rem;
}
```
  </action>
  <verify>Bullet inputs styled, touch-friendly on mobile</verify>
  <done>Bullet input CSS complete with iOS-safe styling</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Bullet inputs appear after image selection
- [ ] At least 1 bullet required for submission
- [ ] Draft saves to localStorage on typing
- [ ] Draft restores on page reload
- [ ] Submit button shows loading state
- [ ] Valid submission redirects to waiting page
- [ ] Response record created in database
- [ ] Input font-size is 16px (no iOS zoom)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Response persists to database
- Draft persistence works
</success_criteria>

<output>
After completion, create `.planning/phases/14-image-browser/14-02-SUMMARY.md`
</output>
