---
phase: 14-image-browser
plan: 03
type: execute
wave: 2
depends_on: ["14-02"]
files_modified:
  - the55/app/routers/participant.py
  - the55/app/templates/participant/waiting.html
  - the55/app/templates/participant/strategy.html
autonomous: true

must_haves:
  truths:
    - "Participant can edit response until capture closes"
    - "Waiting page shows edit option if already submitted"
    - "Strategy page redirects to respond if session still open"
    - "Editing preserves existing response data"
  artifacts:
    - path: "the55/app/templates/participant/waiting.html"
      provides: "Edit button for existing response"
      contains: "edit"
    - path: "the55/app/routers/participant.py"
      provides: "Edit flow logic"
  key_links:
    - from: "waiting.html Edit button"
      to: "GET /respond"
      via: "link href"
    - from: "GET /respond"
      to: "existing response query"
      via: "db.query(Response)"
---

<objective>
Implement edit flow allowing participants to modify responses until capture closes.

Purpose: Enable participants to refine their response while session is still in CAPTURING state.
Output: Edit button on waiting page, response pre-population, graceful state handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/research/PITFALLS.md

# Prior plans
@.planning/phases/14-image-browser/14-01-PLAN.md
@.planning/phases/14-image-browser/14-02-PLAN.md

# Source files
@the55/app/routers/participant.py
@the55/app/templates/participant/waiting.html
@the55/app/templates/participant/strategy.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add edit link to waiting page</name>
  <files>the55/app/templates/participant/waiting.html</files>
  <action>
Update waiting.html to show edit option:

1. Check session state in template:
   - If session.state == CAPTURING: show "Edit Response" link
   - If session.state == CLOSED: show "Capture closed - responses locked"
   - If session.state == REVEALED: redirect to synthesis (already handled in router)

2. Edit button:
   - Link to: `/join/{{ team.code }}/session/{{ session.id }}/member/{{ member.id }}/respond`
   - Style as secondary button
   - Only visible while state == CAPTURING

3. Status message based on state:
   - CAPTURING: "Your response has been saved. You can edit until the facilitator closes capture."
   - CLOSED: "Capture is closed. Waiting for facilitator to reveal synthesis."

4. Keep existing polling for state changes:
   - When state changes to CLOSED, hide edit button
   - When state changes to REVEALED, redirect to synthesis
  </action>
  <verify>Waiting page shows Edit button when session is CAPTURING</verify>
  <done>Edit link visible on waiting page during capture phase</done>
</task>

<task type="auto">
  <name>Task 2: Update strategy page to handle re-entry</name>
  <files>the55/app/templates/participant/strategy.html</files>
  <action>
Update strategy.html to handle participants who already responded:

1. Check if member already has response in router, pass to template

2. In template:
   - If has_response: Change button text to "Edit Response"
   - If has_response: Add note "You've already submitted. Click to edit."
   - Form still POSTs to same endpoint (which redirects to respond)

3. Add server-side redirect in router (strategy endpoint):
   ```python
   # If member already responded, offer direct link to edit
   existing_response = db.query(Response).filter(
       Response.session_id == session_id,
       Response.member_id == member_id
   ).first()

   # Pass to template
   return templates.TemplateResponse(
       "participant/strategy.html",
       {
           ...existing context...,
           "has_response": existing_response is not None
       }
   )
   ```

4. The "I'm Ready" button POST redirects to /respond (which loads existing data)
  </action>
  <verify>Strategy page shows "Edit Response" if member already submitted</verify>
  <done>Strategy page handles re-entry gracefully</done>
</task>

<task type="auto">
  <name>Task 3: Add state validation to all participant endpoints</name>
  <files>the55/app/routers/participant.py</files>
  <action>
Ensure all endpoints properly handle session state transitions:

1. GET /respond:
   - If session.state != CAPTURING: redirect to appropriate page
     - CLOSED/REVEALED with existing response: redirect to waiting
     - CLOSED/REVEALED without response: show "Session closed" message
     - DRAFT: redirect to join (session not active)

2. POST /respond:
   - Before processing: verify session.state == CAPTURING
   - If state changed during submission: return friendly error
   - Don't just HTTPException - render template with error

3. Waiting page status endpoint:
   - Return has_response flag in JSON
   - Return can_edit flag (true if CAPTURING)

4. Add helper function for session state checks:
   ```python
   def check_session_state(session, required_states, redirect_url):
       if session.state not in required_states:
           return RedirectResponse(url=redirect_url, status_code=303)
       return None
   ```

5. Update status endpoint response:
   ```python
   return JSONResponse({
       "session_id": session_id,
       "state": session.state.value,
       "total_members": len(members),
       "submitted_count": len(responses),
       "can_edit": session.state == SessionState.CAPTURING
   })
   ```
  </action>
  <verify>
Accessing /respond when session is CLOSED returns redirect
Status endpoint returns can_edit flag
  </verify>
  <done>All endpoints handle state transitions gracefully</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Waiting page shows Edit button when CAPTURING
- [ ] Edit button hidden when CLOSED
- [ ] Clicking Edit loads respond page with existing data
- [ ] Strategy page shows "Edit Response" if already submitted
- [ ] Accessing /respond when CLOSED redirects to waiting
- [ ] Status endpoint returns can_edit flag
- [ ] No errors when state changes during user interaction
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Edit flow works end-to-end
- Graceful state transition handling
</success_criteria>

<output>
After completion, create `.planning/phases/14-image-browser/14-03-SUMMARY.md`
</output>
