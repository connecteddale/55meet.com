---
phase: 13-participant-entry
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - the55/app/routers/participant.py
  - the55/app/routers/__init__.py
  - the55/app/main.py
autonomous: true

must_haves:
  truths:
    - "Participant can enter team code on /join page"
    - "Valid team code loads team with sessions"
    - "Invalid team code shows error message"
    - "Participant can select month from available sessions"
    - "Participant can select their name from member list"
    - "Session must be in CAPTURING state to allow entry"
  artifacts:
    - path: "the55/app/routers/participant.py"
      provides: "Public participant entry endpoints"
      contains: "join_team"
    - path: "the55/app/routers/participant.py"
      provides: "Session selection endpoint"
      contains: "select_session"
  key_links:
    - from: "participant router"
      to: "Team model"
      via: "code lookup"
      pattern: "Team.code"
    - from: "participant router"
      to: "Session model"
      via: "state check"
      pattern: "SessionState.CAPTURING"
---

<objective>
Create participant entry API endpoints for joining sessions.

Purpose: Enable participants to join a session by entering team code, selecting month, and picking their name - all without authentication.
Output: Participant router with public endpoints for join flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@the55/app/db/models.py
@the55/app/routers/sessions.py
@the55/app/dependencies.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create participant router with join endpoints</name>
  <files>the55/app/routers/participant.py</files>
  <action>
    Create participant.py router with public (no auth) endpoints:
    ```python
    """
    The 55 App - Participant Router

    Public endpoints for participant session entry flow.
    No authentication required - participants join via team code.
    """

    from fastapi import APIRouter, Request, Form, HTTPException
    from fastapi.responses import RedirectResponse
    from fastapi.templating import Jinja2Templates
    from sqlalchemy.orm import Session

    from app.db.database import get_db
    from app.db.models import Team, Member, Session as SessionModel, SessionState

    router = APIRouter(prefix="/join", tags=["participant"])
    templates = Jinja2Templates(directory="app/templates")

    # Dependency for database without auth
    from fastapi import Depends
    DbDep = Depends(get_db)


    @router.get("")
    async def join_form(request: Request):
        """Show team code entry form."""
        return templates.TemplateResponse(
            "participant/join.html",
            {"request": request, "error": None}
        )


    @router.post("")
    async def join_team(
        request: Request,
        db: Session = DbDep,
        code: str = Form(...)
    ):
        """Process team code and redirect to session selection."""
        # Normalize code (uppercase, strip whitespace)
        code = code.strip().upper()

        team = db.query(Team).filter(Team.code == code).first()
        if not team:
            return templates.TemplateResponse(
                "participant/join.html",
                {"request": request, "error": "Team code not found. Please check and try again."}
            )

        # Get sessions in CAPTURING state
        active_sessions = db.query(SessionModel).filter(
            SessionModel.team_id == team.id,
            SessionModel.state == SessionState.CAPTURING
        ).order_by(SessionModel.month.desc()).all()

        if not active_sessions:
            return templates.TemplateResponse(
                "participant/join.html",
                {"request": request, "error": "No active sessions for this team. Please wait for your facilitator."}
            )

        # Redirect to session selection
        return RedirectResponse(
            url=f"/join/{team.code}/session",
            status_code=303
        )


    @router.get("/{code}/session")
    async def select_session_form(
        request: Request,
        code: str,
        db: Session = DbDep
    ):
        """Show session selection (month stepper)."""
        code = code.strip().upper()
        team = db.query(Team).filter(Team.code == code).first()
        if not team:
            return RedirectResponse(url="/join", status_code=303)

        # Get CAPTURING sessions
        sessions = db.query(SessionModel).filter(
            SessionModel.team_id == team.id,
            SessionModel.state == SessionState.CAPTURING
        ).order_by(SessionModel.month.desc()).all()

        if not sessions:
            return RedirectResponse(url="/join", status_code=303)

        return templates.TemplateResponse(
            "participant/select_session.html",
            {
                "request": request,
                "team": team,
                "sessions": sessions,
                "current_session": sessions[0]  # Default to most recent
            }
        )


    @router.post("/{code}/session")
    async def select_session(
        request: Request,
        code: str,
        db: Session = DbDep,
        session_id: int = Form(...)
    ):
        """Process session selection and redirect to name selection."""
        code = code.strip().upper()
        team = db.query(Team).filter(Team.code == code).first()
        if not team:
            return RedirectResponse(url="/join", status_code=303)

        session = db.query(SessionModel).filter(
            SessionModel.id == session_id,
            SessionModel.team_id == team.id,
            SessionModel.state == SessionState.CAPTURING
        ).first()

        if not session:
            return RedirectResponse(url=f"/join/{code}/session", status_code=303)

        return RedirectResponse(
            url=f"/join/{code}/session/{session.id}/name",
            status_code=303
        )


    @router.get("/{code}/session/{session_id}/name")
    async def select_name_form(
        request: Request,
        code: str,
        session_id: int,
        db: Session = DbDep
    ):
        """Show name selection from team members."""
        code = code.strip().upper()
        team = db.query(Team).filter(Team.code == code).first()
        if not team:
            return RedirectResponse(url="/join", status_code=303)

        session = db.query(SessionModel).filter(
            SessionModel.id == session_id,
            SessionModel.team_id == team.id,
            SessionModel.state == SessionState.CAPTURING
        ).first()

        if not session:
            return RedirectResponse(url=f"/join/{code}/session", status_code=303)

        # Get team members sorted by name
        members = db.query(Member).filter(
            Member.team_id == team.id
        ).order_by(Member.name).all()

        # Get members who already responded
        from app.db.models import Response
        responded_ids = {
            r.member_id for r in
            db.query(Response.member_id).filter(Response.session_id == session_id).all()
        }

        return templates.TemplateResponse(
            "participant/select_name.html",
            {
                "request": request,
                "team": team,
                "session": session,
                "members": members,
                "responded_ids": responded_ids
            }
        )


    @router.post("/{code}/session/{session_id}/name")
    async def select_name(
        request: Request,
        code: str,
        session_id: int,
        db: Session = DbDep,
        member_id: int = Form(...)
    ):
        """Process name selection and redirect to strategy/response."""
        code = code.strip().upper()
        team = db.query(Team).filter(Team.code == code).first()
        if not team:
            return RedirectResponse(url="/join", status_code=303)

        session = db.query(SessionModel).filter(
            SessionModel.id == session_id,
            SessionModel.team_id == team.id,
            SessionModel.state == SessionState.CAPTURING
        ).first()

        if not session:
            return RedirectResponse(url=f"/join/{code}/session", status_code=303)

        member = db.query(Member).filter(
            Member.id == member_id,
            Member.team_id == team.id
        ).first()

        if not member:
            return RedirectResponse(
                url=f"/join/{code}/session/{session_id}/name",
                status_code=303
            )

        # Redirect to strategy confirmation page
        return RedirectResponse(
            url=f"/join/{code}/session/{session_id}/member/{member_id}/strategy",
            status_code=303
        )


    @router.get("/{code}/session/{session_id}/member/{member_id}/strategy")
    async def show_strategy(
        request: Request,
        code: str,
        session_id: int,
        member_id: int,
        db: Session = DbDep
    ):
        """Show strategy statement before proceeding to response."""
        code = code.strip().upper()
        team = db.query(Team).filter(Team.code == code).first()
        if not team:
            return RedirectResponse(url="/join", status_code=303)

        session = db.query(SessionModel).filter(
            SessionModel.id == session_id,
            SessionModel.team_id == team.id,
            SessionModel.state == SessionState.CAPTURING
        ).first()

        if not session:
            return RedirectResponse(url=f"/join/{code}/session", status_code=303)

        member = db.query(Member).filter(
            Member.id == member_id,
            Member.team_id == team.id
        ).first()

        if not member:
            return RedirectResponse(
                url=f"/join/{code}/session/{session_id}/name",
                status_code=303
            )

        return templates.TemplateResponse(
            "participant/strategy.html",
            {
                "request": request,
                "team": team,
                "session": session,
                "member": member
            }
        )


    @router.get("/{code}/session/{session_id}/member/{member_id}/waiting")
    async def waiting_state(
        request: Request,
        code: str,
        session_id: int,
        member_id: int,
        db: Session = DbDep
    ):
        """Show waiting state while session is being processed."""
        code = code.strip().upper()
        team = db.query(Team).filter(Team.code == code).first()
        if not team:
            return RedirectResponse(url="/join", status_code=303)

        session = db.query(SessionModel).filter(
            SessionModel.id == session_id,
            SessionModel.team_id == team.id
        ).first()

        if not session:
            return RedirectResponse(url=f"/join/{code}/session", status_code=303)

        member = db.query(Member).filter(
            Member.id == member_id,
            Member.team_id == team.id
        ).first()

        if not member:
            return RedirectResponse(url="/join", status_code=303)

        # Check if session is revealed - redirect to synthesis view
        if session.state == SessionState.REVEALED:
            return RedirectResponse(
                url=f"/join/{code}/session/{session_id}/synthesis",
                status_code=303
            )

        return templates.TemplateResponse(
            "participant/waiting.html",
            {
                "request": request,
                "team": team,
                "session": session,
                "member": member
            }
        )
    ```
  </action>
  <verify>python -c "from app.routers.participant import router; print('OK')"</verify>
  <done>Participant router with join flow endpoints created</done>
</task>

<task type="auto">
  <name>Task 2: Register participant router in main app</name>
  <files>the55/app/routers/__init__.py, the55/app/main.py</files>
  <action>
    Update routers/__init__.py to export participant_router:
    ```python
    from app.routers.participant import router as participant_router
    ```

    Update main.py to include participant router:
    ```python
    from app.routers import ..., participant_router

    # Add after other routers:
    app.include_router(participant_router)
    ```
  </action>
  <verify>grep "participant_router" /var/www/the55/app/main.py</verify>
  <done>Participant router registered in main app</done>
</task>

<task type="auto">
  <name>Task 3: Test participant endpoints</name>
  <files>None (testing only)</files>
  <action>
    Verify endpoints are accessible:
    ```bash
    cd /var/www/the55
    source venv/bin/activate
    uvicorn app.main:app --host 0.0.0.0 --port 8055 &
    sleep 2

    # Test join page loads (no auth required)
    curl -s -o /dev/null -w "%{http_code}" http://localhost:8055/join
    # Should return 200

    pkill -f "uvicorn app.main:app"
    ```
  </action>
  <verify>/join endpoint returns 200</verify>
  <done>Participant endpoints accessible without authentication</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Participant router created with join endpoints
- [ ] Router registered in main app (no auth dependency)
- [ ] /join page loads without authentication
- [ ] Team code lookup works (case-insensitive)
- [ ] Only CAPTURING sessions shown
</verification>

<success_criteria>
- All tasks completed
- Public endpoints work without authentication
- Join flow navigates through all steps
</success_criteria>

<output>
After completion, create `.planning/phases/13-participant-entry/13-01-SUMMARY.md`
</output>
