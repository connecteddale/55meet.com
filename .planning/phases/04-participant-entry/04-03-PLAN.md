---
phase: 13-participant-entry
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - the55/app/routers/qr.py
  - the55/app/routers/__init__.py
  - the55/app/main.py
  - the55/app/templates/admin/teams/edit.html
autonomous: true

must_haves:
  truths:
    - "QR code endpoint generates PNG image"
    - "QR code encodes join URL with team code"
    - "Facilitator can view QR code for team"
    - "QR code scannable by mobile camera"
  artifacts:
    - path: "the55/app/routers/qr.py"
      provides: "QR code generation endpoint"
      contains: "generate_qr"
  key_links:
    - from: "QR code"
      to: "/join?code={code}"
      via: "URL encoding"
      pattern: "join.*code"
---

<objective>
Create QR code generation for team join URLs.

Purpose: Enable participants to join by scanning QR code displayed by facilitator.
Output: QR code generation endpoint and display in team management.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@the55/app/routers/teams.py
@the55/app/templates/admin/teams/edit.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install qrcode library</name>
  <files>the55/requirements.txt</files>
  <action>
    Add qrcode[pil] to requirements and install:
    ```bash
    cd /var/www/the55
    source venv/bin/activate
    pip install "qrcode[pil]"
    echo "qrcode[pil]" >> requirements.txt
    ```

    Note: qrcode[pil] includes Pillow for PNG generation.
  </action>
  <verify>python -c "import qrcode; print('OK')"</verify>
  <done>qrcode library installed</done>
</task>

<task type="auto">
  <name>Task 2: Create QR code router</name>
  <files>the55/app/routers/qr.py</files>
  <action>
    Create qr.py router for QR code generation:
    ```python
    """
    The 55 App - QR Code Router

    Generates QR codes for team join URLs.
    """

    import io
    import qrcode
    from qrcode.image.styledpil import StyledPilImage

    from fastapi import APIRouter, Request, HTTPException
    from fastapi.responses import StreamingResponse

    from app.dependencies import AuthDep, DbDep
    from app.db.models import Team

    router = APIRouter(prefix="/admin/qr", tags=["qr"])


    def get_base_url(request: Request) -> str:
        """Get base URL from request, handling proxies."""
        # Check for forwarded proto (behind nginx/proxy)
        proto = request.headers.get("x-forwarded-proto", request.url.scheme)
        host = request.headers.get("x-forwarded-host", request.url.netloc)
        return f"{proto}://{host}"


    @router.get("/team/{team_id}")
    async def generate_qr(
        request: Request,
        team_id: int,
        auth: AuthDep,
        db: DbDep
    ):
        """Generate QR code PNG for team join URL."""
        team = db.query(Team).filter(Team.id == team_id).first()
        if not team:
            raise HTTPException(status_code=404, detail="Team not found")

        # Build join URL
        base_url = get_base_url(request)
        join_url = f"{base_url}/join?code={team.code}"

        # Generate QR code
        qr = qrcode.QRCode(
            version=1,
            error_correction=qrcode.constants.ERROR_CORRECT_M,
            box_size=10,
            border=4,
        )
        qr.add_data(join_url)
        qr.make(fit=True)

        # Create image
        img = qr.make_image(fill_color="black", back_color="white")

        # Return as PNG
        buffer = io.BytesIO()
        img.save(buffer, format="PNG")
        buffer.seek(0)

        return StreamingResponse(
            buffer,
            media_type="image/png",
            headers={
                "Content-Disposition": f"inline; filename=qr-{team.code}.png",
                "Cache-Control": "max-age=3600"  # Cache for 1 hour
            }
        )


    @router.get("/team/{team_id}/download")
    async def download_qr(
        request: Request,
        team_id: int,
        auth: AuthDep,
        db: DbDep
    ):
        """Download QR code PNG for team join URL."""
        team = db.query(Team).filter(Team.id == team_id).first()
        if not team:
            raise HTTPException(status_code=404, detail="Team not found")

        # Build join URL
        base_url = get_base_url(request)
        join_url = f"{base_url}/join?code={team.code}"

        # Generate QR code - larger for printing
        qr = qrcode.QRCode(
            version=1,
            error_correction=qrcode.constants.ERROR_CORRECT_H,  # High error correction for printing
            box_size=15,  # Larger for print
            border=4,
        )
        qr.add_data(join_url)
        qr.make(fit=True)

        img = qr.make_image(fill_color="black", back_color="white")

        buffer = io.BytesIO()
        img.save(buffer, format="PNG")
        buffer.seek(0)

        return StreamingResponse(
            buffer,
            media_type="image/png",
            headers={
                "Content-Disposition": f"attachment; filename=the55-qr-{team.code}.png"
            }
        )
    ```
  </action>
  <verify>python -c "from app.routers.qr import router; print('OK')"</verify>
  <done>QR code router created</done>
</task>

<task type="auto">
  <name>Task 3: Register QR router and add to team edit page</name>
  <files>the55/app/routers/__init__.py, the55/app/main.py, the55/app/templates/admin/teams/edit.html</files>
  <action>
    Update routers/__init__.py:
    ```python
    from app.routers.qr import router as qr_router
    ```

    Update main.py:
    ```python
    from app.routers import ..., qr_router

    app.include_router(qr_router)
    ```

    Update teams/edit.html to show QR code. Add after the form or in a sidebar:
    ```html
    <div class="card qr-card">
        <h3>QR Code</h3>
        <p>Participants can scan to join:</p>
        <div class="qr-display">
            <img src="/admin/qr/team/{{ team.id }}" alt="QR Code for {{ team.code }}" class="qr-image">
        </div>
        <div class="qr-code-text">
            <code>{{ team.code }}</code>
        </div>
        <a href="/admin/qr/team/{{ team.id }}/download" class="btn btn-secondary btn-small">
            Download QR
        </a>
    </div>
    ```

    Add CSS for QR display in main.css:
    ```css
    /* QR Code */
    .qr-card {
        text-align: center;
    }

    .qr-display {
        margin: var(--spacing-md) 0;
    }

    .qr-image {
        max-width: 200px;
        height: auto;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
    }

    .qr-code-text {
        margin-bottom: var(--spacing-md);
    }

    .qr-code-text code {
        font-size: 1.5rem;
        letter-spacing: 0.1em;
        padding: var(--spacing-sm) var(--spacing-md);
        background: var(--color-surface);
        border-radius: var(--radius-sm);
    }

    .btn-small {
        font-size: 0.875rem;
        padding: var(--spacing-sm) var(--spacing-md);
    }
    ```
  </action>
  <verify>grep "qr_router" /var/www/the55/app/main.py</verify>
  <done>QR router registered and displayed in team edit</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] qrcode library installed
- [ ] QR code endpoint returns PNG image
- [ ] QR code encodes correct join URL
- [ ] Team edit page displays QR code
- [ ] Download endpoint provides printable QR
</verification>

<success_criteria>
- All tasks completed
- QR code scannable by mobile camera
- QR encodes /join?code={CODE} URL
</success_criteria>

<output>
After completion, create `.planning/phases/13-participant-entry/13-03-SUMMARY.md`
</output>
