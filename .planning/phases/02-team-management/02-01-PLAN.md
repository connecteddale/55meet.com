---
phase: 11-team-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - the55/app/routers/admin.py
  - the55/app/routers/teams.py
  - the55/app/templates/admin/dashboard.html
  - the55/app/templates/admin/teams/list.html
  - the55/app/templates/admin/teams/create.html
  - the55/app/templates/admin/teams/edit.html
autonomous: true

must_haves:
  truths:
    - "Facilitator can view list of teams at /admin"
    - "Facilitator can create team with company name, team name, unique code"
    - "Team codes are unique and case-insensitive"
    - "Facilitator can edit team details"
    - "Facilitator can delete team"
  artifacts:
    - path: "the55/app/routers/teams.py"
      provides: "Team CRUD endpoints"
      contains: "create_team"
    - path: "the55/app/templates/admin/teams/list.html"
      provides: "Team listing UI"
      contains: "teams"
  key_links:
    - from: "admin dashboard"
      to: "team list"
      via: "Jinja2 template"
      pattern: "/admin (dashboard shows teams)"
    - from: "teams router"
      to: "Team model"
      via: "SQLAlchemy ORM"
      pattern: "db.query(Team)"
---

<objective>
Build team CRUD functionality for the facilitator dashboard.

Purpose: Enable facilitator to create and manage teams for The 55 sessions.
Output: Team list view, create form, edit form, delete confirmation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@the55/app/db/models.py
@the55/app/routers/admin.py
@the55/app/dependencies.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create teams router with CRUD endpoints</name>
  <files>the55/app/routers/teams.py</files>
  <action>
    Create teams.py router with all team management endpoints:
    ```python
    """
    The 55 App - Teams Router

    Team management endpoints for facilitator.
    """

    import secrets
    import string
    from typing import Optional

    from fastapi import APIRouter, Request, Form
    from fastapi.responses import RedirectResponse
    from fastapi.templating import Jinja2Templates
    from sqlalchemy import func

    from app.dependencies import AuthDep, DbDep
    from app.db.models import Team

    router = APIRouter(prefix="/admin/teams", tags=["teams"])
    templates = Jinja2Templates(directory="app/templates")


    def generate_team_code() -> str:
        """Generate a unique 6-character team code."""
        chars = string.ascii_uppercase + string.digits
        # Exclude confusing characters: 0, O, I, 1, L
        chars = chars.replace('0', '').replace('O', '').replace('I', '').replace('1', '').replace('L', '')
        return ''.join(secrets.choice(chars) for _ in range(6))


    @router.get("")
    async def list_teams(request: Request, auth: AuthDep, db: DbDep):
        """List all teams."""
        teams = db.query(Team).order_by(Team.company_name, Team.team_name).all()
        return templates.TemplateResponse(
            "admin/teams/list.html",
            {"request": request, "teams": teams}
        )


    @router.get("/create")
    async def create_team_form(request: Request, auth: AuthDep):
        """Show create team form."""
        return templates.TemplateResponse(
            "admin/teams/create.html",
            {"request": request, "error": None}
        )


    @router.post("/create")
    async def create_team(
        request: Request,
        auth: AuthDep,
        db: DbDep,
        company_name: str = Form(...),
        team_name: str = Form(...),
        code: Optional[str] = Form(None),
        strategy_statement: Optional[str] = Form(None)
    ):
        """Create a new team."""
        # Generate code if not provided
        if not code:
            code = generate_team_code()

        # Normalize code to uppercase
        code = code.upper().strip()

        # Check for duplicate code (case-insensitive)
        existing = db.query(Team).filter(func.upper(Team.code) == code).first()
        if existing:
            return templates.TemplateResponse(
                "admin/teams/create.html",
                {"request": request, "error": f"Team code '{code}' already exists"}
            )

        # Create team
        team = Team(
            company_name=company_name.strip(),
            team_name=team_name.strip(),
            code=code,
            strategy_statement=strategy_statement.strip() if strategy_statement else None
        )
        db.add(team)
        db.commit()

        return RedirectResponse(url="/admin/teams", status_code=303)


    @router.get("/{team_id}")
    async def edit_team_form(request: Request, team_id: int, auth: AuthDep, db: DbDep):
        """Show edit team form."""
        team = db.query(Team).filter(Team.id == team_id).first()
        if not team:
            return RedirectResponse(url="/admin/teams", status_code=303)

        return templates.TemplateResponse(
            "admin/teams/edit.html",
            {"request": request, "team": team, "error": None}
        )


    @router.post("/{team_id}")
    async def update_team(
        request: Request,
        team_id: int,
        auth: AuthDep,
        db: DbDep,
        company_name: str = Form(...),
        team_name: str = Form(...),
        code: str = Form(...),
        strategy_statement: Optional[str] = Form(None)
    ):
        """Update team details."""
        team = db.query(Team).filter(Team.id == team_id).first()
        if not team:
            return RedirectResponse(url="/admin/teams", status_code=303)

        # Normalize code
        code = code.upper().strip()

        # Check for duplicate code (excluding current team)
        existing = db.query(Team).filter(
            func.upper(Team.code) == code,
            Team.id != team_id
        ).first()
        if existing:
            return templates.TemplateResponse(
                "admin/teams/edit.html",
                {"request": request, "team": team, "error": f"Team code '{code}' already exists"}
            )

        # Update team
        team.company_name = company_name.strip()
        team.team_name = team_name.strip()
        team.code = code
        team.strategy_statement = strategy_statement.strip() if strategy_statement else None
        db.commit()

        return RedirectResponse(url="/admin/teams", status_code=303)


    @router.post("/{team_id}/delete")
    async def delete_team(team_id: int, auth: AuthDep, db: DbDep):
        """Delete a team."""
        team = db.query(Team).filter(Team.id == team_id).first()
        if team:
            db.delete(team)
            db.commit()

        return RedirectResponse(url="/admin/teams", status_code=303)
    ```
  </action>
  <verify>python -c "from app.routers.teams import router; print('OK')"</verify>
  <done>Teams router with CRUD endpoints created</done>
</task>

<task type="auto">
  <name>Task 2: Register teams router in main app</name>
  <files>the55/app/main.py, the55/app/routers/__init__.py</files>
  <action>
    Update routers/__init__.py to export teams_router:
    ```python
    from app.routers.auth import router as auth_router
    from app.routers.admin import router as admin_router
    from app.routers.images import router as images_router
    from app.routers.teams import router as teams_router
    ```

    Update main.py to include teams router:
    ```python
    from app.routers import auth_router, admin_router, images_router, teams_router

    # In app setup section, add:
    app.include_router(teams_router)
    ```
  </action>
  <verify>grep "teams_router" /var/www/the55/app/main.py</verify>
  <done>Teams router registered in main app</done>
</task>

<task type="auto">
  <name>Task 3: Create team list template</name>
  <files>the55/app/templates/admin/teams/list.html</files>
  <action>
    Create templates/admin/teams directory and list.html:
    ```bash
    mkdir -p /var/www/the55/app/templates/admin/teams
    ```

    Create list.html:
    ```html
    {% extends "base.html" %}

    {% block title %}Teams - The 55{% endblock %}

    {% block nav %}
    <nav>
        <a href="/admin" class="btn btn-secondary">Dashboard</a>
    </nav>
    {% endblock %}

    {% block content %}
    <div class="card">
        <div class="card-header">
            <h2>Teams</h2>
            <a href="/admin/teams/create" class="btn btn-primary">Create Team</a>
        </div>

        {% if teams %}
        <div class="team-list">
            {% for team in teams %}
            <div class="team-item">
                <div class="team-info">
                    <div class="team-name">{{ team.company_name }} - {{ team.team_name }}</div>
                    <div class="team-code">Code: <strong>{{ team.code }}</strong></div>
                    <div class="team-members">{{ team.members | length }} members</div>
                </div>
                <div class="team-actions">
                    <a href="/admin/teams/{{ team.id }}" class="btn btn-secondary">Edit</a>
                    <a href="/admin/teams/{{ team.id }}/members" class="btn btn-secondary">Members</a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="empty-state">No teams yet. Create your first team to get started.</p>
        {% endif %}
    </div>
    {% endblock %}
    ```
  </action>
  <verify>test -f /var/www/the55/app/templates/admin/teams/list.html</verify>
  <done>Team list template created</done>
</task>

<task type="auto">
  <name>Task 4: Create team form templates</name>
  <files>the55/app/templates/admin/teams/create.html, the55/app/templates/admin/teams/edit.html</files>
  <action>
    Create create.html:
    ```html
    {% extends "base.html" %}

    {% block title %}Create Team - The 55{% endblock %}

    {% block nav %}
    <nav>
        <a href="/admin/teams" class="btn btn-secondary">Back to Teams</a>
    </nav>
    {% endblock %}

    {% block content %}
    <div class="card">
        <h2>Create Team</h2>

        {% if error %}
        <div class="error">{{ error }}</div>
        {% endif %}

        <form method="post" action="/admin/teams/create">
            <div class="form-group">
                <label for="company_name">Company Name</label>
                <input type="text" id="company_name" name="company_name" required
                       placeholder="Acme Corporation">
            </div>

            <div class="form-group">
                <label for="team_name">Team Name</label>
                <input type="text" id="team_name" name="team_name" required
                       placeholder="Leadership Team">
            </div>

            <div class="form-group">
                <label for="code">Team Code (optional - will be auto-generated)</label>
                <input type="text" id="code" name="code" maxlength="20"
                       placeholder="ACME01" pattern="[A-Za-z0-9]+"
                       style="text-transform: uppercase;">
                <small>6-character code participants use to join. Leave blank to auto-generate.</small>
            </div>

            <div class="form-group">
                <label for="strategy_statement">Strategy Statement (3AM Test)</label>
                <textarea id="strategy_statement" name="strategy_statement" rows="3"
                          placeholder="Our strategy is to..."></textarea>
                <small>The strategy participants should keep in mind when selecting their image.</small>
            </div>

            <button type="submit" class="btn btn-primary">Create Team</button>
        </form>
    </div>
    {% endblock %}
    ```

    Create edit.html:
    ```html
    {% extends "base.html" %}

    {% block title %}Edit Team - The 55{% endblock %}

    {% block nav %}
    <nav>
        <a href="/admin/teams" class="btn btn-secondary">Back to Teams</a>
    </nav>
    {% endblock %}

    {% block content %}
    <div class="card">
        <h2>Edit Team</h2>

        {% if error %}
        <div class="error">{{ error }}</div>
        {% endif %}

        <form method="post" action="/admin/teams/{{ team.id }}">
            <div class="form-group">
                <label for="company_name">Company Name</label>
                <input type="text" id="company_name" name="company_name" required
                       value="{{ team.company_name }}">
            </div>

            <div class="form-group">
                <label for="team_name">Team Name</label>
                <input type="text" id="team_name" name="team_name" required
                       value="{{ team.team_name }}">
            </div>

            <div class="form-group">
                <label for="code">Team Code</label>
                <input type="text" id="code" name="code" required maxlength="20"
                       value="{{ team.code }}" pattern="[A-Za-z0-9]+"
                       style="text-transform: uppercase;">
            </div>

            <div class="form-group">
                <label for="strategy_statement">Strategy Statement (3AM Test)</label>
                <textarea id="strategy_statement" name="strategy_statement" rows="3"
                          >{{ team.strategy_statement or '' }}</textarea>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>

        <hr>

        <div class="danger-zone">
            <h3>Danger Zone</h3>
            <form method="post" action="/admin/teams/{{ team.id }}/delete"
                  onsubmit="return confirm('Delete this team? This cannot be undone.');">
                <button type="submit" class="btn btn-danger">Delete Team</button>
            </form>
        </div>
    </div>
    {% endblock %}
    ```
  </action>
  <verify>test -f /var/www/the55/app/templates/admin/teams/edit.html</verify>
  <done>Team create and edit templates created</done>
</task>

<task type="auto">
  <name>Task 5: Update dashboard to show teams</name>
  <files>the55/app/templates/admin/dashboard.html, the55/app/routers/admin.py</files>
  <action>
    Update admin.py to pass teams to dashboard:
    ```python
    """
    The 55 App - Admin Router

    Protected dashboard routes for facilitator.
    """

    from fastapi import APIRouter, Request
    from fastapi.templating import Jinja2Templates

    from app.dependencies import AuthDep, DbDep
    from app.db.models import Team

    router = APIRouter(prefix="/admin", tags=["admin"])
    templates = Jinja2Templates(directory="app/templates")


    @router.get("")
    async def admin_dashboard(request: Request, auth: AuthDep, db: DbDep):
        """Admin dashboard - requires authentication."""
        teams = db.query(Team).order_by(Team.company_name, Team.team_name).all()
        return templates.TemplateResponse(
            "admin/dashboard.html",
            {"request": request, "teams": teams}
        )
    ```

    Update dashboard.html to show team summary:
    ```html
    {% extends "base.html" %}

    {% block title %}Dashboard - The 55{% endblock %}

    {% block nav %}
    <nav>
        <a href="/admin/logout" class="btn btn-secondary">Logout</a>
    </nav>
    {% endblock %}

    {% block content %}
    <div class="dashboard">
        <h2>Welcome to The 55</h2>
        <p>55 minutes. Once a month. The truth about where the team actually is.</p>

        <div class="dashboard-section">
            <div class="section-header">
                <h3>Teams ({{ teams | length }})</h3>
                <a href="/admin/teams/create" class="btn btn-primary">Create Team</a>
            </div>

            {% if teams %}
            <div class="team-grid">
                {% for team in teams %}
                <a href="/admin/teams/{{ team.id }}" class="team-card">
                    <div class="team-company">{{ team.company_name }}</div>
                    <div class="team-name">{{ team.team_name }}</div>
                    <div class="team-meta">
                        <span class="team-code">{{ team.code }}</span>
                        <span class="team-members">{{ team.members | length }} members</span>
                    </div>
                </a>
                {% endfor %}
            </div>
            {% else %}
            <p class="empty-state">No teams yet. Create your first team to get started.</p>
            {% endif %}
        </div>
    </div>
    {% endblock %}
    ```
  </action>
  <verify>grep "teams" /var/www/the55/app/templates/admin/dashboard.html</verify>
  <done>Dashboard updated to show teams</done>
</task>

<task type="auto">
  <name>Task 6: Add CSS for team management UI</name>
  <files>the55/app/static/css/main.css</files>
  <action>
    Append team management styles to main.css:
    ```css
    /* Team Management */
    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
    }

    .card-header h2 {
        margin: 0;
    }

    .team-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
    }

    .team-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-md);
        background: var(--color-surface);
        border-radius: var(--radius-md);
        border: 1px solid var(--color-border);
    }

    .team-info {
        flex: 1;
    }

    .team-name {
        font-weight: 600;
        color: var(--color-text);
    }

    .team-code {
        font-size: 0.875rem;
        color: var(--color-text-secondary);
        font-family: monospace;
    }

    .team-members {
        font-size: 0.875rem;
        color: var(--color-text-secondary);
    }

    .team-actions {
        display: flex;
        gap: var(--spacing-xs);
    }

    .empty-state {
        text-align: center;
        padding: var(--spacing-xl);
        color: var(--color-text-secondary);
    }

    /* Dashboard */
    .dashboard-section {
        margin-top: var(--spacing-lg);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
    }

    .section-header h3 {
        margin: 0;
    }

    .team-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: var(--spacing-md);
    }

    .team-card {
        display: block;
        padding: var(--spacing-md);
        background: var(--color-surface);
        border-radius: var(--radius-md);
        border: 1px solid var(--color-border);
        text-decoration: none;
        color: inherit;
        transition: border-color 0.2s, box-shadow 0.2s;
    }

    .team-card:hover {
        border-color: var(--color-primary);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .team-company {
        font-size: 0.875rem;
        color: var(--color-text-secondary);
    }

    .team-card .team-name {
        font-size: 1.125rem;
        margin: var(--spacing-xs) 0;
    }

    .team-meta {
        display: flex;
        justify-content: space-between;
        font-size: 0.875rem;
        color: var(--color-text-secondary);
    }

    /* Form improvements */
    .form-actions {
        margin-top: var(--spacing-md);
    }

    hr {
        border: none;
        border-top: 1px solid var(--color-border);
        margin: var(--spacing-lg) 0;
    }

    .danger-zone {
        padding: var(--spacing-md);
        background: #fef2f2;
        border-radius: var(--radius-md);
        border: 1px solid #fecaca;
    }

    .danger-zone h3 {
        margin: 0 0 var(--spacing-sm) 0;
        color: #991b1b;
        font-size: 1rem;
    }

    .btn-danger {
        background: #dc2626;
        color: white;
    }

    .btn-danger:hover {
        background: #b91c1c;
    }

    small {
        display: block;
        margin-top: var(--spacing-xs);
        color: var(--color-text-secondary);
        font-size: 0.875rem;
    }
    ```
  </action>
  <verify>grep "team-grid" /var/www/the55/app/static/css/main.css</verify>
  <done>CSS for team management added</done>
</task>

<task type="auto">
  <name>Task 7: Test team CRUD flow</name>
  <files>None (testing only)</files>
  <action>
    Start app and verify team operations:
    ```bash
    cd /var/www/the55
    source venv/bin/activate
    uvicorn app.main:app --host 0.0.0.0 --port 8055 &
    sleep 2

    # Test endpoints require auth - verify routes load
    curl -s -o /dev/null -w "%{http_code}" http://localhost:8055/admin/teams
    # Should return 303 (redirect to login)

    # Test that create form endpoint exists
    curl -s -o /dev/null -w "%{http_code}" http://localhost:8055/admin/teams/create
    # Should return 303 (redirect to login - protected)

    pkill -f "uvicorn app.main:app"
    ```

    Verify code uniqueness constraint via Python:
    ```python
    cd /var/www/the55
    source venv/bin/activate
    python -c "
    from app.db.database import SessionLocal
    from app.db.models import Team
    from sqlalchemy import func

    db = SessionLocal()
    # Create test team
    team = Team(company_name='Test Co', team_name='Test Team', code='TEST01')
    db.add(team)
    db.commit()

    # Verify case-insensitive lookup works
    found = db.query(Team).filter(func.upper(Team.code) == 'TEST01').first()
    assert found is not None, 'Team not found'
    print(f'Found team: {found.company_name} - {found.team_name}')

    # Clean up
    db.delete(found)
    db.commit()
    db.close()
    print('Case-insensitive code lookup: OK')
    "
    ```
  </action>
  <verify>All tests pass without errors</verify>
  <done>Team CRUD flow tested</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Teams router registered and accessible
- [ ] Team list shows at /admin/teams (when authenticated)
- [ ] Create team form works with validation
- [ ] Edit team form works with validation
- [ ] Delete team works with confirmation
- [ ] Team codes are case-insensitive
- [ ] Dashboard shows team summary
</verification>

<success_criteria>
- All tasks completed
- Team CRUD endpoints functional
- Templates render correctly
- Case-insensitive code uniqueness enforced
</success_criteria>

<output>
After completion, create `.planning/phases/11-team-management/11-01-SUMMARY.md`
</output>
