---
phase: 11-team-management
plan: 02
type: execute
wave: 1
depends_on: [11-01]
files_modified:
  - the55/app/routers/members.py
  - the55/app/templates/admin/teams/members.html
autonomous: true

must_haves:
  truths:
    - "Facilitator can view member list for a team"
    - "Facilitator can add members to team (max 25)"
    - "Facilitator can remove members from team"
    - "Member names display on team details"
  artifacts:
    - path: "the55/app/routers/members.py"
      provides: "Member management endpoints"
      contains: "add_member"
    - path: "the55/app/templates/admin/teams/members.html"
      provides: "Member management UI"
      contains: "members"
  key_links:
    - from: "team edit page"
      to: "members page"
      via: "navigation link"
      pattern: "/admin/teams/{team_id}/members"
    - from: "members router"
      to: "Member model"
      via: "SQLAlchemy ORM"
      pattern: "db.query(Member)"
---

<objective>
Build member management functionality for teams.

Purpose: Enable facilitator to add and remove team members who will participate in sessions.
Output: Member list view, add member form, remove member action with 25 member limit.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@the55/app/db/models.py
@the55/app/routers/teams.py
@the55/app/dependencies.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create members router</name>
  <files>the55/app/routers/members.py</files>
  <action>
    Create members.py router for member management:
    ```python
    """
    The 55 App - Members Router

    Team member management endpoints for facilitator.
    """

    from fastapi import APIRouter, Request, Form, HTTPException
    from fastapi.responses import RedirectResponse
    from fastapi.templating import Jinja2Templates

    from app.dependencies import AuthDep, DbDep
    from app.db.models import Team, Member

    router = APIRouter(prefix="/admin/teams", tags=["members"])
    templates = Jinja2Templates(directory="app/templates")

    MAX_MEMBERS = 25


    @router.get("/{team_id}/members")
    async def list_members(request: Request, team_id: int, auth: AuthDep, db: DbDep):
        """List team members."""
        team = db.query(Team).filter(Team.id == team_id).first()
        if not team:
            return RedirectResponse(url="/admin/teams", status_code=303)

        members = db.query(Member).filter(Member.team_id == team_id).order_by(Member.name).all()
        member_count = len(members)
        can_add = member_count < MAX_MEMBERS

        return templates.TemplateResponse(
            "admin/teams/members.html",
            {
                "request": request,
                "team": team,
                "members": members,
                "member_count": member_count,
                "max_members": MAX_MEMBERS,
                "can_add": can_add,
                "error": None
            }
        )


    @router.post("/{team_id}/members")
    async def add_member(
        request: Request,
        team_id: int,
        auth: AuthDep,
        db: DbDep,
        name: str = Form(...)
    ):
        """Add a member to the team."""
        team = db.query(Team).filter(Team.id == team_id).first()
        if not team:
            return RedirectResponse(url="/admin/teams", status_code=303)

        # Check member limit
        member_count = db.query(Member).filter(Member.team_id == team_id).count()
        if member_count >= MAX_MEMBERS:
            members = db.query(Member).filter(Member.team_id == team_id).order_by(Member.name).all()
            return templates.TemplateResponse(
                "admin/teams/members.html",
                {
                    "request": request,
                    "team": team,
                    "members": members,
                    "member_count": member_count,
                    "max_members": MAX_MEMBERS,
                    "can_add": False,
                    "error": f"Maximum of {MAX_MEMBERS} members reached"
                }
            )

        # Check for duplicate name in team
        name = name.strip()
        existing = db.query(Member).filter(
            Member.team_id == team_id,
            Member.name == name
        ).first()
        if existing:
            members = db.query(Member).filter(Member.team_id == team_id).order_by(Member.name).all()
            return templates.TemplateResponse(
                "admin/teams/members.html",
                {
                    "request": request,
                    "team": team,
                    "members": members,
                    "member_count": member_count,
                    "max_members": MAX_MEMBERS,
                    "can_add": True,
                    "error": f"'{name}' is already a member of this team"
                }
            )

        # Add member
        member = Member(team_id=team_id, name=name)
        db.add(member)
        db.commit()

        return RedirectResponse(url=f"/admin/teams/{team_id}/members", status_code=303)


    @router.post("/{team_id}/members/{member_id}/delete")
    async def remove_member(team_id: int, member_id: int, auth: AuthDep, db: DbDep):
        """Remove a member from the team."""
        member = db.query(Member).filter(
            Member.id == member_id,
            Member.team_id == team_id
        ).first()

        if member:
            db.delete(member)
            db.commit()

        return RedirectResponse(url=f"/admin/teams/{team_id}/members", status_code=303)
    ```
  </action>
  <verify>python -c "from app.routers.members import router; print('OK')"</verify>
  <done>Members router created</done>
</task>

<task type="auto">
  <name>Task 2: Register members router</name>
  <files>the55/app/routers/__init__.py, the55/app/main.py</files>
  <action>
    Update routers/__init__.py:
    ```python
    from app.routers.auth import router as auth_router
    from app.routers.admin import router as admin_router
    from app.routers.images import router as images_router
    from app.routers.teams import router as teams_router
    from app.routers.members import router as members_router
    ```

    Update main.py to include members router:
    ```python
    from app.routers import auth_router, admin_router, images_router, teams_router, members_router

    # In app setup section, add:
    app.include_router(members_router)
    ```
  </action>
  <verify>grep "members_router" /var/www/the55/app/main.py</verify>
  <done>Members router registered</done>
</task>

<task type="auto">
  <name>Task 3: Create members template</name>
  <files>the55/app/templates/admin/teams/members.html</files>
  <action>
    Create members.html template:
    ```html
    {% extends "base.html" %}

    {% block title %}{{ team.team_name }} Members - The 55{% endblock %}

    {% block nav %}
    <nav>
        <a href="/admin/teams/{{ team.id }}" class="btn btn-secondary">Back to Team</a>
    </nav>
    {% endblock %}

    {% block content %}
    <div class="card">
        <div class="card-header">
            <div>
                <h2>{{ team.team_name }}</h2>
                <p class="team-subtitle">{{ team.company_name }}</p>
            </div>
            <span class="member-count">{{ member_count }}/{{ max_members }} members</span>
        </div>

        {% if error %}
        <div class="error">{{ error }}</div>
        {% endif %}

        {% if can_add %}
        <form method="post" action="/admin/teams/{{ team.id }}/members" class="add-member-form">
            <div class="form-row">
                <input type="text" name="name" required placeholder="Enter member name"
                       autocomplete="off" class="member-input">
                <button type="submit" class="btn btn-primary">Add Member</button>
            </div>
        </form>
        {% else %}
        <div class="limit-reached">
            Maximum of {{ max_members }} members reached. Remove a member to add more.
        </div>
        {% endif %}

        {% if members %}
        <div class="member-list">
            {% for member in members %}
            <div class="member-item">
                <span class="member-name">{{ member.name }}</span>
                <form method="post" action="/admin/teams/{{ team.id }}/members/{{ member.id }}/delete"
                      class="delete-form"
                      onsubmit="return confirm('Remove {{ member.name }} from this team?');">
                    <button type="submit" class="btn btn-text btn-small">Remove</button>
                </form>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="empty-state">No members yet. Add team members above.</p>
        {% endif %}
    </div>

    {% if team.strategy_statement %}
    <div class="card">
        <h3>Strategy Statement (3AM Test)</h3>
        <p class="strategy-text">{{ team.strategy_statement }}</p>
        <a href="/admin/teams/{{ team.id }}" class="btn btn-secondary btn-small">Edit Strategy</a>
    </div>
    {% endif %}
    {% endblock %}
    ```
  </action>
  <verify>test -f /var/www/the55/app/templates/admin/teams/members.html</verify>
  <done>Members template created</done>
</task>

<task type="auto">
  <name>Task 4: Add member management CSS</name>
  <files>the55/app/static/css/main.css</files>
  <action>
    Append member management styles to main.css:
    ```css
    /* Member Management */
    .team-subtitle {
        margin: 0;
        color: var(--color-text-secondary);
        font-size: 0.875rem;
    }

    .member-count {
        font-size: 0.875rem;
        color: var(--color-text-secondary);
        background: var(--color-surface);
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: var(--radius-sm);
    }

    .add-member-form {
        margin-bottom: var(--spacing-md);
    }

    .form-row {
        display: flex;
        gap: var(--spacing-sm);
    }

    .member-input {
        flex: 1;
    }

    .limit-reached {
        padding: var(--spacing-md);
        background: #fef3c7;
        border-radius: var(--radius-md);
        color: #92400e;
        margin-bottom: var(--spacing-md);
    }

    .member-list {
        display: flex;
        flex-direction: column;
    }

    .member-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-sm) var(--spacing-md);
        border-bottom: 1px solid var(--color-border);
    }

    .member-item:last-child {
        border-bottom: none;
    }

    .member-name {
        font-weight: 500;
    }

    .delete-form {
        margin: 0;
    }

    .btn-text {
        background: transparent;
        color: var(--color-text-secondary);
        padding: var(--spacing-xs) var(--spacing-sm);
    }

    .btn-text:hover {
        color: #dc2626;
        background: #fef2f2;
    }

    .btn-small {
        font-size: 0.875rem;
        padding: var(--spacing-xs) var(--spacing-sm);
        min-height: 36px;
    }

    .strategy-text {
        font-style: italic;
        color: var(--color-text-secondary);
        margin: var(--spacing-sm) 0;
    }

    /* Responsive adjustments for member form */
    @media (max-width: 480px) {
        .form-row {
            flex-direction: column;
        }

        .form-row .btn {
            width: 100%;
        }
    }
    ```
  </action>
  <verify>grep "member-list" /var/www/the55/app/static/css/main.css</verify>
  <done>Member CSS added</done>
</task>

<task type="auto">
  <name>Task 5: Test member management</name>
  <files>None (testing only)</files>
  <action>
    Test member operations via Python:
    ```bash
    cd /var/www/the55
    source venv/bin/activate
    python -c "
    from app.db.database import SessionLocal
    from app.db.models import Team, Member

    db = SessionLocal()

    # Create test team
    team = Team(company_name='Test Co', team_name='Test Team', code='MBRTEST')
    db.add(team)
    db.commit()
    print(f'Created team: {team.id}')

    # Add members up to limit
    for i in range(25):
        member = Member(team_id=team.id, name=f'Member {i+1}')
        db.add(member)
    db.commit()

    # Verify count
    count = db.query(Member).filter(Member.team_id == team.id).count()
    assert count == 25, f'Expected 25 members, got {count}'
    print(f'Added 25 members: OK')

    # Test removal
    member = db.query(Member).filter(Member.team_id == team.id).first()
    db.delete(member)
    db.commit()

    count = db.query(Member).filter(Member.team_id == team.id).count()
    assert count == 24, f'Expected 24 members after removal, got {count}'
    print('Member removal: OK')

    # Clean up (cascade should delete remaining members)
    db.delete(team)
    db.commit()

    remaining = db.query(Member).filter(Member.team_id == team.id).count()
    assert remaining == 0, f'Expected 0 members after team delete, got {remaining}'
    print('Cascade delete: OK')

    db.close()
    print('All member tests passed')
    "
    ```

    Verify endpoints accessible:
    ```bash
    cd /var/www/the55
    source venv/bin/activate
    uvicorn app.main:app --host 0.0.0.0 --port 8055 &
    sleep 2

    # Verify members endpoint exists (will redirect to login)
    curl -s -o /dev/null -w "%{http_code}" http://localhost:8055/admin/teams/1/members
    # Should return 303 (redirect to login)

    pkill -f "uvicorn app.main:app"
    ```
  </action>
  <verify>All tests pass</verify>
  <done>Member management tested</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Members router registered
- [ ] Member list displays for team
- [ ] Add member works with 25 member limit
- [ ] Remove member works
- [ ] Duplicate name detection works
- [ ] Cascade delete works (team delete removes members)
</verification>

<success_criteria>
- All tasks completed
- Member CRUD functional
- 25 member limit enforced
- Template renders correctly
</success_criteria>

<output>
After completion, create `.planning/phases/11-team-management/11-02-SUMMARY.md`
</output>
