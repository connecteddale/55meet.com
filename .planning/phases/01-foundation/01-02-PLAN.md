---
phase: 10-foundation
plan: 02
type: execute
wave: 2
depends_on: [10-01]
files_modified:
  - the55/app/db/__init__.py
  - the55/app/db/models.py
  - the55/app/db/database.py
  - the55/app/dependencies.py
autonomous: true

must_haves:
  truths:
    - "SQLite database creates with WAL mode enabled"
    - "All models define proper table relationships"
    - "Session state enum enforced at database level"
  artifacts:
    - path: "the55/app/db/models.py"
      provides: "SQLAlchemy ORM models"
      contains: "class Team"
    - path: "the55/app/db/database.py"
      provides: "Database session management"
      contains: "create_engine"
  key_links:
    - from: "dependencies.py"
      to: "database.py"
      via: "get_db dependency"
      pattern: "from app.db.database import"
---

<objective>
Create SQLite database layer with SQLAlchemy ORM models for teams, members, sessions, and responses.

Purpose: Establish data persistence layer that all subsequent features build upon.
Output: Working database with all tables created and WAL mode enabled.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/research/STACK.md
@.planning/research/ARCHITECTURE.md
@.planning/research/PITFALLS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database engine and session management</name>
  <files>the55/app/db/database.py</files>
  <action>
    Create database.py with SQLAlchemy setup:
    ```python
    from sqlalchemy import create_engine, event
    from sqlalchemy.orm import sessionmaker, declarative_base

    SQLALCHEMY_DATABASE_URL = "sqlite:///db/the55.db"

    engine = create_engine(
        SQLALCHEMY_DATABASE_URL,
        connect_args={"check_same_thread": False}
    )

    # Enable WAL mode and busy_timeout for better concurrency
    @event.listens_for(engine, "connect")
    def set_sqlite_pragma(dbapi_connection, connection_record):
        cursor = dbapi_connection.cursor()
        cursor.execute("PRAGMA journal_mode=WAL")
        cursor.execute("PRAGMA busy_timeout=5000")
        cursor.close()

    SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

    Base = declarative_base()

    def get_db():
        db = SessionLocal()
        try:
            yield db
        finally:
            db.close()
    ```

    Update dependencies.py to add database dependency:
    ```python
    from typing import Annotated
    from fastapi import Depends
    from sqlalchemy.orm import Session
    from app.config import Settings
    from app.db.database import get_db

    def get_settings():
        return Settings()

    SettingsDep = Annotated[Settings, Depends(get_settings)]
    DbDep = Annotated[Session, Depends(get_db)]
    ```
  </action>
  <verify>python -c "from app.db.database import engine; print('OK')"</verify>
  <done>Database engine configured with WAL mode pragma</done>
</task>

<task type="auto">
  <name>Task 2: Create ORM models</name>
  <files>the55/app/db/models.py</files>
  <action>
    Create models.py with all entity definitions:
    ```python
    import enum
    from datetime import datetime
    from sqlalchemy import (
        Column, Integer, String, Text, DateTime, ForeignKey, Enum, Boolean
    )
    from sqlalchemy.orm import relationship
    from app.db.database import Base


    class SessionState(enum.Enum):
        DRAFT = "draft"
        CAPTURING = "capturing"
        CLOSED = "closed"
        REVEALED = "revealed"


    class Team(Base):
        __tablename__ = "teams"

        id = Column(Integer, primary_key=True, index=True)
        company_name = Column(String(255), nullable=False)
        team_name = Column(String(255), nullable=False)
        code = Column(String(20), unique=True, nullable=False, index=True)
        strategy_statement = Column(Text, nullable=True)
        created_at = Column(DateTime, default=datetime.utcnow)
        updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

        members = relationship("Member", back_populates="team", cascade="all, delete-orphan")
        sessions = relationship("Session", back_populates="team", cascade="all, delete-orphan")


    class Member(Base):
        __tablename__ = "members"

        id = Column(Integer, primary_key=True, index=True)
        team_id = Column(Integer, ForeignKey("teams.id"), nullable=False)
        name = Column(String(255), nullable=False)
        created_at = Column(DateTime, default=datetime.utcnow)

        team = relationship("Team", back_populates="members")
        responses = relationship("Response", back_populates="member")


    class Session(Base):
        __tablename__ = "sessions"

        id = Column(Integer, primary_key=True, index=True)
        team_id = Column(Integer, ForeignKey("teams.id"), nullable=False)
        month = Column(String(7), nullable=False)  # Format: "2025-05"
        state = Column(Enum(SessionState), default=SessionState.DRAFT, nullable=False)
        synthesis_themes = Column(Text, nullable=True)
        synthesis_statements = Column(Text, nullable=True)
        synthesis_gap_type = Column(String(50), nullable=True)
        facilitator_notes = Column(Text, nullable=True)
        recalibration_action = Column(Text, nullable=True)
        recalibration_completed = Column(Boolean, default=False)
        created_at = Column(DateTime, default=datetime.utcnow)
        closed_at = Column(DateTime, nullable=True)
        revealed_at = Column(DateTime, nullable=True)

        team = relationship("Team", back_populates="sessions")
        responses = relationship("Response", back_populates="session", cascade="all, delete-orphan")


    class Response(Base):
        __tablename__ = "responses"

        id = Column(Integer, primary_key=True, index=True)
        session_id = Column(Integer, ForeignKey("sessions.id"), nullable=False)
        member_id = Column(Integer, ForeignKey("members.id"), nullable=False)
        image_number = Column(Integer, nullable=False)  # 1-55
        bullets = Column(Text, nullable=False)  # JSON array of 1-5 strings
        submitted_at = Column(DateTime, default=datetime.utcnow)
        updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

        session = relationship("Session", back_populates="responses")
        member = relationship("Member", back_populates="responses")
    ```

    Update db/__init__.py to export models:
    ```python
    from app.db.database import Base, engine, get_db, SessionLocal
    from app.db.models import Team, Member, Session, Response, SessionState
    ```
  </action>
  <verify>python -c "from app.db.models import Team, Session, SessionState; print('OK')"</verify>
  <done>All ORM models defined with relationships</done>
</task>

<task type="auto">
  <name>Task 3: Initialize database and verify</name>
  <files>the55/app/main.py</files>
  <action>
    Update main.py lifespan to create tables on startup:
    ```python
    from contextlib import asynccontextmanager
    from fastapi import FastAPI
    from fastapi.staticfiles import StaticFiles
    from fastapi.templating import Jinja2Templates
    from app.db.database import Base, engine

    @asynccontextmanager
    async def lifespan(app: FastAPI):
        # Create tables on startup
        Base.metadata.create_all(bind=engine)
        yield
        # Cleanup on shutdown (if needed)

    app = FastAPI(title="The 55", lifespan=lifespan)
    # ... rest of app setup
    ```

    Test database creation:
    ```bash
    cd /var/www/the55
    python -c "
    from app.db.database import engine, Base
    from app.db import models  # Import to register models
    Base.metadata.create_all(bind=engine)
    print('Tables created')

    # Verify WAL mode
    import sqlite3
    conn = sqlite3.connect('db/the55.db')
    result = conn.execute('PRAGMA journal_mode').fetchone()
    print(f'Journal mode: {result[0]}')
    conn.close()
    "
    ```
  </action>
  <verify>sqlite3 db/the55.db "PRAGMA journal_mode" returns "wal"</verify>
  <done>Database initialized with WAL mode, all tables created</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] database.py creates engine with WAL mode pragma
- [ ] models.py defines Team, Member, Session, Response
- [ ] SessionState enum has all four states
- [ ] Tables created in SQLite database
- [ ] WAL mode confirmed active
- [ ] dependencies.py exports DbDep
</verification>

<success_criteria>
- All tasks completed
- Database file exists at db/the55.db
- WAL mode enabled
- All models importable without errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-foundation/10-02-SUMMARY.md`
</output>
