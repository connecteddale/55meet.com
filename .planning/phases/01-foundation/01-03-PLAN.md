---
phase: 10-foundation
plan: 03
type: execute
wave: 2
depends_on: [10-01]
files_modified:
  - the55/app/routers/auth.py
  - the55/app/services/auth.py
  - the55/app/templates/login.html
  - the55/app/main.py
autonomous: true

must_haves:
  truths:
    - "Login page renders at /admin/login"
    - "Invalid credentials show error message"
    - "Valid credentials create session and redirect to /admin"
  artifacts:
    - path: "the55/app/routers/auth.py"
      provides: "Authentication routes"
      contains: "login"
    - path: "the55/app/services/auth.py"
      provides: "Password verification"
      contains: "verify_password"
  key_links:
    - from: "auth.py router"
      to: "auth.py service"
      via: "verify_password import"
      pattern: "from app.services.auth import"
---

<objective>
Create facilitator authentication system with login page, password verification, and session management.

Purpose: Secure admin area so only Dale can manage teams and sessions.
Output: Working login flow at /admin/login with session-based authentication.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/research/STACK.md
@.planning/research/ARCHITECTURE.md
@.planning/research/PITFALLS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create auth service with password verification</name>
  <files>the55/app/services/auth.py, the55/app/services/__init__.py</files>
  <action>
    Create auth.py service:
    ```python
    from pwdlib import PasswordHash
    from itsdangerous import URLSafeTimedSerializer, BadSignature, SignatureExpired
    from app.config import Settings

    password_hash = PasswordHash.recommended()

    def verify_password(plain_password: str, hashed_password: str) -> bool:
        """Verify a password against its hash."""
        return password_hash.verify(plain_password, hashed_password)

    def hash_password(password: str) -> str:
        """Hash a password for storage."""
        return password_hash.hash(password)

    def create_session_token(settings: Settings) -> str:
        """Create a signed session token."""
        serializer = URLSafeTimedSerializer(settings.secret_key)
        return serializer.dumps({"facilitator": True})

    def verify_session_token(token: str, settings: Settings, max_age: int = 86400) -> bool:
        """Verify a session token (default 24h expiry)."""
        serializer = URLSafeTimedSerializer(settings.secret_key)
        try:
            data = serializer.loads(token, max_age=max_age)
            return data.get("facilitator") is True
        except (BadSignature, SignatureExpired):
            return False
    ```

    Update services/__init__.py:
    ```python
    from app.services.auth import verify_password, hash_password, create_session_token, verify_session_token
    ```
  </action>
  <verify>python -c "from app.services.auth import verify_password; print('OK')"</verify>
  <done>Auth service with password and token functions</done>
</task>

<task type="auto">
  <name>Task 2: Create auth router with login/logout</name>
  <files>the55/app/routers/auth.py, the55/app/routers/__init__.py</files>
  <action>
    Create auth.py router:
    ```python
    from fastapi import APIRouter, Request, Response, Form, Depends
    from fastapi.responses import RedirectResponse
    from fastapi.templating import Jinja2Templates
    from app.config import Settings
    from app.dependencies import SettingsDep
    from app.services.auth import verify_password, create_session_token

    router = APIRouter(prefix="/admin", tags=["auth"])
    templates = Jinja2Templates(directory="app/templates")

    @router.get("/login")
    async def login_page(request: Request, error: str = None):
        """Render login page."""
        return templates.TemplateResponse(
            "login.html",
            {"request": request, "error": error}
        )

    @router.post("/login")
    async def login(
        request: Request,
        response: Response,
        settings: SettingsDep,
        password: str = Form(...)
    ):
        """Process login form."""
        if not verify_password(password, settings.facilitator_password_hash):
            return templates.TemplateResponse(
                "login.html",
                {"request": request, "error": "Invalid password"},
                status_code=401
            )

        # Create session token and set cookie
        token = create_session_token(settings)
        redirect = RedirectResponse(url="/admin", status_code=303)
        redirect.set_cookie(
            key="session",
            value=token,
            httponly=True,
            secure=True,
            samesite="lax",
            max_age=86400  # 24 hours
        )
        return redirect

    @router.get("/logout")
    async def logout():
        """Clear session and redirect to login."""
        response = RedirectResponse(url="/admin/login", status_code=303)
        response.delete_cookie("session")
        return response
    ```

    Update routers/__init__.py:
    ```python
    from app.routers.auth import router as auth_router
    ```
  </action>
  <verify>python -c "from app.routers.auth import router; print('OK')"</verify>
  <done>Auth router with login/logout endpoints</done>
</task>

<task type="auto">
  <name>Task 3: Create auth dependency and admin placeholder</name>
  <files>the55/app/dependencies.py, the55/app/routers/admin.py</files>
  <action>
    Update dependencies.py with auth check:
    ```python
    from typing import Annotated
    from fastapi import Depends, Request, HTTPException
    from sqlalchemy.orm import Session
    from app.config import Settings
    from app.db.database import get_db

    def get_settings():
        return Settings()

    SettingsDep = Annotated[Settings, Depends(get_settings)]
    DbDep = Annotated[Session, Depends(get_db)]

    async def require_auth(request: Request, settings: SettingsDep):
        """Dependency that requires facilitator authentication."""
        from app.services.auth import verify_session_token

        token = request.cookies.get("session")
        if not token or not verify_session_token(token, settings):
            from fastapi.responses import RedirectResponse
            raise HTTPException(
                status_code=303,
                headers={"Location": "/admin/login"}
            )
        return True

    AuthDep = Annotated[bool, Depends(require_auth)]
    ```

    Create admin.py router placeholder:
    ```python
    from fastapi import APIRouter, Request
    from fastapi.templating import Jinja2Templates
    from app.dependencies import AuthDep

    router = APIRouter(prefix="/admin", tags=["admin"])
    templates = Jinja2Templates(directory="app/templates")

    @router.get("")
    async def admin_dashboard(request: Request, auth: AuthDep):
        """Admin dashboard - requires authentication."""
        return templates.TemplateResponse(
            "admin/dashboard.html",
            {"request": request}
        )
    ```

    Update routers/__init__.py:
    ```python
    from app.routers.auth import router as auth_router
    from app.routers.admin import router as admin_router
    ```
  </action>
  <verify>python -c "from app.dependencies import AuthDep; print('OK')"</verify>
  <done>Auth dependency and admin placeholder router</done>
</task>

<task type="auto">
  <name>Task 4: Create login template</name>
  <files>the55/app/templates/login.html, the55/app/templates/admin/dashboard.html</files>
  <action>
    Create login.html:
    ```html
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Login - The 55</title>
        <link rel="stylesheet" href="/static/css/main.css">
    </head>
    <body class="login-page">
        <main class="login-container">
            <h1>The 55</h1>
            <h2>Facilitator Login</h2>

            {% if error %}
            <div class="error-message">{{ error }}</div>
            {% endif %}

            <form method="post" action="/admin/login">
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required autofocus>
                </div>
                <button type="submit" class="btn-primary">Login</button>
            </form>
        </main>
    </body>
    </html>
    ```

    Create admin/dashboard.html placeholder:
    ```html
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Dashboard - The 55</title>
        <link rel="stylesheet" href="/static/css/main.css">
    </head>
    <body>
        <header>
            <h1>The 55</h1>
            <nav>
                <a href="/admin/logout">Logout</a>
            </nav>
        </header>
        <main>
            <h2>Dashboard</h2>
            <p>Welcome, Facilitator. Team management coming in Phase 11.</p>
        </main>
    </body>
    </html>
    ```
  </action>
  <verify>ls -la /var/www/the55/app/templates/login.html shows file exists</verify>
  <done>Login and dashboard templates created</done>
</task>

<task type="auto">
  <name>Task 5: Register routers in main app</name>
  <files>the55/app/main.py</files>
  <action>
    Update main.py to include auth and admin routers:
    ```python
    from contextlib import asynccontextmanager
    from fastapi import FastAPI
    from fastapi.staticfiles import StaticFiles
    from fastapi.templating import Jinja2Templates
    from app.db.database import Base, engine
    from app.routers import auth_router, admin_router

    @asynccontextmanager
    async def lifespan(app: FastAPI):
        Base.metadata.create_all(bind=engine)
        yield

    app = FastAPI(title="The 55", lifespan=lifespan)

    # Mount static files
    app.mount("/static", StaticFiles(directory="app/static"), name="static")

    # Include routers
    app.include_router(auth_router)
    app.include_router(admin_router)

    @app.get("/health")
    async def health():
        return {"status": "ok"}
    ```

    Test the full login flow:
    ```bash
    cd /var/www/the55
    uvicorn app.main:app --host 0.0.0.0 --port 8055 &
    sleep 2
    # Test login page renders
    curl -s http://localhost:8055/admin/login | grep -q "Facilitator Login" && echo "Login page OK"
    # Test invalid password
    curl -s -X POST -d "password=wrong" http://localhost:8055/admin/login | grep -q "Invalid password" && echo "Invalid password OK"
    # Stop uvicorn
    pkill -f "uvicorn app.main:app"
    ```
  </action>
  <verify>curl http://localhost:8055/admin/login returns login form</verify>
  <done>Routers registered, login flow working</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] /admin/login renders login form
- [ ] Invalid password shows error
- [ ] Valid password sets session cookie and redirects
- [ ] /admin requires authentication
- [ ] /admin/logout clears session
- [ ] Session cookie is httponly and secure
</verification>

<success_criteria>
- All tasks completed
- Login page accessible at /admin/login
- Password verification working
- Session-based authentication functional
</success_criteria>

<output>
After completion, create `.planning/phases/10-foundation/10-03-SUMMARY.md`
</output>
