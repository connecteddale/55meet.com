---
phase: 27-unified-meeting-screen
plan: 02
type: execute
wave: 2
depends_on: [27-01]
files_modified:
  - the55/app/static/js/meeting.js
  - the55/app/static/css/main.css
  - the55/app/templates/admin/sessions/meeting.html
  - the55/app/templates/admin/sessions/view.html
autonomous: true

must_haves:
  truths:
    - "Participant status updates via polling without page reload"
    - "Status section collapses when all participants submitted"
    - "Synthesis reveals with animated ceremony moment"
    - "Keyboard 1/2/3 switches between synthesis levels"
    - "State transitions are smooth (no jarring jumps)"
  artifacts:
    - path: "the55/app/static/js/meeting.js"
      provides: "Meeting screen controller with polling and transitions"
      min_lines: 100
    - path: "the55/app/static/css/main.css"
      provides: "Animation keyframes for collapse and reveal"
      contains: "@keyframes ceremony-reveal"
  key_links:
    - from: "the55/app/static/js/meeting.js"
      to: "/admin/sessions/{id}/status"
      via: "fetch polling"
      pattern: "fetch.*status"
    - from: "the55/app/templates/admin/sessions/view.html"
      to: "/admin/sessions/{id}/meeting"
      via: "href link"
      pattern: "meeting"
---

<objective>
Add interactive behaviors to the unified meeting screen: real-time polling, status collapse animation, ceremony reveal transition, and keyboard navigation.

Purpose: Create a seamless, professional facilitation experience where the screen flows naturally from capture to synthesis reveal (MEET-03, MEET-04, MEET-05, MEET-07).
Output: Polished meeting screen with animated state transitions and keyboard controls.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-unified-meeting-screen/27-RESEARCH.md
@.planning/phases/27-unified-meeting-screen/27-01-SUMMARY.md

# Existing implementations to reference
@the55/app/static/js/polling.js (existing polling pattern)
@the55/app/static/css/variables.css (animation variables)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create meeting.js controller</name>
  <files>the55/app/static/js/meeting.js</files>
  <action>
Create new JavaScript file for meeting screen interactivity:

```javascript
/**
 * The 55 - Meeting Screen Controller
 *
 * Handles:
 * - Status polling during capture phase
 * - All-submitted detection and status collapse
 * - State change detection and ceremony reveal
 * - Keyboard navigation for synthesis levels (1/2/3)
 */

(function() {
    'use strict';

    const POLL_INTERVAL = 2500; // 2.5 seconds (same as polling.js)
    let pollTimer = null;
    let currentState = null;

    // Get meeting screen container
    const container = document.querySelector('.meeting-screen');
    if (!container) return;

    const sessionId = container.dataset.sessionId;
    currentState = container.dataset.state;

    /**
     * Poll session status from API
     */
    async function pollMeetingStatus() {
        try {
            const response = await fetch(`/admin/sessions/${sessionId}/status`, {
                credentials: 'same-origin'
            });

            if (!response.ok) {
                console.error('Meeting status poll failed:', response.status);
                return;
            }

            const data = await response.json();

            // Update UI based on current state
            if (currentState === 'capturing' || currentState === 'draft') {
                updateMemberStatus(data);
                checkAllSubmitted(data);
            }

            // State transition detection
            if (data.state !== currentState) {
                handleStateTransition(currentState, data.state, data);
            }
        } catch (error) {
            console.error('Meeting status poll error:', error);
        }
    }

    /**
     * Update member status indicators
     */
    function updateMemberStatus(data) {
        // Update counts
        const submittedEl = document.getElementById('submitted-count');
        const totalEl = document.getElementById('total-members');

        if (submittedEl) submittedEl.textContent = data.submitted_count;
        if (totalEl) totalEl.textContent = data.total_members;

        // Update member indicators
        const memberList = document.getElementById('member-status-list');
        if (!memberList || !data.members) return;

        data.members.forEach(member => {
            const memberEl = memberList.querySelector(`[data-member-id="${member.id}"]`);
            if (!memberEl) return;

            const indicator = memberEl.querySelector('.status-indicator');
            if (!indicator) return;

            if (member.submitted) {
                indicator.classList.remove('waiting');
                indicator.classList.add('submitted');
                indicator.textContent = '\u2713'; // Checkmark
            } else {
                indicator.classList.remove('submitted');
                indicator.classList.add('waiting');
                indicator.textContent = '...';
            }
        });
    }

    /**
     * Check if all participants have submitted (MEET-03)
     */
    function checkAllSubmitted(data) {
        if (data.submitted_count === data.total_members && data.total_members > 0) {
            const captureSection = document.getElementById('capture-section');
            if (captureSection && !captureSection.classList.contains('all-submitted')) {
                captureSection.classList.add('all-submitted');
                showAllSubmittedMessage();
            }
        }
    }

    /**
     * Show "All submitted" visual indicator
     */
    function showAllSubmittedMessage() {
        const progress = document.querySelector('.meeting-progress');
        if (progress) {
            progress.innerHTML = '<span class="all-submitted-text">All Responses Received</span>';
        }
    }

    /**
     * Handle state transitions (MEET-04, MEET-07)
     */
    function handleStateTransition(fromState, toState, data) {
        console.log(`Meeting state transition: ${fromState} -> ${toState}`);

        if (toState === 'revealed') {
            // Trigger ceremony reveal animation
            triggerCeremonyReveal();
        } else if (toState === 'closed') {
            // Transition to waiting state - reload to show waiting UI
            window.location.reload();
        } else {
            // Other transitions - reload to get fresh template
            window.location.reload();
        }
    }

    /**
     * Trigger ceremony reveal animation (MEET-07)
     */
    function triggerCeremonyReveal() {
        stopPolling();

        // Add transition class to body
        document.body.classList.add('meeting-transitioning');

        // Collapse capture section if visible
        const captureSection = document.getElementById('capture-section');
        if (captureSection) {
            captureSection.classList.add('collapsing');
        }

        // After collapse animation, reload to show synthesis
        // Using reload ensures we get server-rendered synthesis data
        setTimeout(() => {
            window.location.reload();
        }, 800); // Match CSS transition duration
    }

    /**
     * Start polling
     */
    function startPolling() {
        if (pollTimer) return;
        pollTimer = setInterval(pollMeetingStatus, POLL_INTERVAL);
        console.log('Meeting status polling started');
    }

    /**
     * Stop polling
     */
    function stopPolling() {
        if (pollTimer) {
            clearInterval(pollTimer);
            pollTimer = null;
            console.log('Meeting status polling stopped');
        }
    }

    /**
     * Initialize level tab navigation (MEET-05)
     */
    function initLevelTabs() {
        const tabs = document.querySelectorAll('.meeting-synthesis .level-tab');
        const contents = document.querySelectorAll('.meeting-synthesis .level-content');

        if (tabs.length === 0) return;

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const level = tab.dataset.level;
                showLevel(level);
            });
        });
    }

    /**
     * Show specific level content
     */
    function showLevel(level) {
        const tabs = document.querySelectorAll('.meeting-synthesis .level-tab');
        const contents = document.querySelectorAll('.meeting-synthesis .level-content');

        tabs.forEach(tab => {
            tab.classList.toggle('active', tab.dataset.level === String(level));
        });

        contents.forEach(content => {
            content.classList.toggle('active', content.dataset.level === String(level));
        });
    }

    /**
     * Initialize keyboard navigation (MEET-05)
     */
    function initKeyboardNav() {
        document.addEventListener('keydown', function(e) {
            // Only in revealed state with synthesis visible
            if (currentState !== 'revealed') return;

            // Ignore if typing in input/textarea
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            // 1, 2, 3 keys for level switching
            if (e.key === '1' || e.key === '2' || e.key === '3') {
                e.preventDefault();
                showLevel(parseInt(e.key, 10));
            }
        });
    }

    /**
     * Initialize on page load
     */
    function init() {
        // Start polling in capturing/draft/closed states
        if (currentState === 'capturing' || currentState === 'draft' || currentState === 'closed') {
            startPolling();
            // Initial poll immediately
            pollMeetingStatus();
        }

        // Initialize level tabs and keyboard nav for revealed state
        if (currentState === 'revealed') {
            initLevelTabs();
            initKeyboardNav();
        }
    }

    // Initialize
    init();

    // Clean up on page unload
    window.addEventListener('beforeunload', stopPolling);
})();
```

Key features:
- Reuses proven polling pattern from polling.js (2.5s interval)
- All-submitted detection triggers visual feedback (MEET-03)
- State transition to 'revealed' triggers reload after animation (MEET-07)
- Keyboard 1/2/3 for level navigation (MEET-05)
- Clean separation of concerns
  </action>
  <verify>
ls -la the55/app/static/js/meeting.js
wc -l the55/app/static/js/meeting.js (should be 100+ lines)
grep -c "pollMeetingStatus" the55/app/static/js/meeting.js
  </verify>
  <done>Meeting.js provides polling, state transitions, and keyboard navigation</done>
</task>

<task type="auto">
  <name>Task 2: Add transition and animation CSS</name>
  <files>the55/app/static/css/main.css</files>
  <action>
Add animation CSS after the existing meeting mode section (at end of file):

```css
/* ========================================
   Meeting Mode - Transitions & Animations
   ======================================== */

/* All-submitted state indicator (MEET-03) */
.meeting-capture.all-submitted .meeting-status {
    border: 2px solid #22c55e;
}

.meeting-capture.all-submitted .meeting-progress {
    color: #22c55e;
}

.all-submitted-text {
    font-size: 0.7em;
    animation: pulse-green 2s ease-in-out infinite;
}

@keyframes pulse-green {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* Status collapse animation (MEET-03) */
.meeting-capture.collapsing {
    animation: collapse-capture 0.6s var(--ease-out) forwards;
}

@keyframes collapse-capture {
    0% {
        opacity: 1;
        transform: scale(1);
    }
    100% {
        opacity: 0;
        transform: scale(0.95);
    }
}

/* Ceremony reveal animation (MEET-07) */
.meeting-synthesis {
    animation: ceremony-reveal 0.8s var(--ease-out) forwards;
}

@keyframes ceremony-reveal {
    0% {
        opacity: 0;
        transform: translateY(40px) scale(0.95);
    }
    60% {
        opacity: 1;
        transform: translateY(-10px) scale(1.02);
    }
    100% {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* Level content transitions (MEET-05) */
.meeting-synthesis .level-content {
    display: none;
    animation: fade-in-up 0.3s var(--ease-out) forwards;
}

.meeting-synthesis .level-content.active {
    display: block;
}

@keyframes fade-in-up {
    0% {
        opacity: 0;
        transform: translateY(10px);
    }
    100% {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Tab transition */
.meeting-synthesis .level-tab {
    transition: all 0.2s var(--ease-out);
}

/* Waiting state spinner (for closed state) */
.meeting-waiting {
    animation: fade-in 0.5s var(--ease-out);
}

@keyframes fade-in {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Body transition state */
.meeting-transitioning {
    pointer-events: none;
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
    .meeting-synthesis,
    .meeting-capture.collapsing,
    .meeting-synthesis .level-content,
    .all-submitted-text {
        animation: none;
        opacity: 1;
        transform: none;
    }
}
```

This provides:
- MEET-03: Visual indicator when all submitted + collapse animation
- MEET-07: "Ceremony moment" reveal animation with overshoot effect
- MEET-05: Smooth level switching animations
- Accessibility: Respects prefers-reduced-motion
  </action>
  <verify>
grep -n "@keyframes ceremony-reveal" the55/app/static/css/main.css
grep -n "all-submitted" the55/app/static/css/main.css
  </verify>
  <done>CSS provides animated transitions for all-submitted, collapse, and ceremony reveal states</done>
</task>

<task type="auto">
  <name>Task 3: Update view.html to link to meeting screen</name>
  <files>the55/app/templates/admin/sessions/view.html</files>
  <action>
Update the session control panel to include meeting screen link:

1. In CAPTURING state block (around line 54), change "Capture View (Project)" to "Meeting Screen" and update the URL:

Replace:
```html
<a href="/admin/sessions/{{ session.id }}/capture" class="btn btn-primary">
    Capture View (Project)
</a>
```

With:
```html
<a href="/admin/sessions/{{ session.id }}/meeting" class="btn btn-primary">
    Meeting Screen (Project)
</a>
```

2. In REVEALED state block (around line 97), change "Presentation Mode" to use meeting screen:

Replace:
```html
<a href="/admin/sessions/{{ session.id }}/present" class="btn btn-primary">
    Presentation Mode
</a>
```

With:
```html
<a href="/admin/sessions/{{ session.id }}/meeting" class="btn btn-primary">
    Meeting Screen (Project)
</a>
```

This consolidates both "Capture View" and "Presentation Mode" into a single "Meeting Screen" link that works in all states, providing the unified experience (MEET-01).

Keep existing `/capture` and `/present` endpoints functional for backwards compatibility (already in router).
  </action>
  <verify>
grep -n "meeting" the55/app/templates/admin/sessions/view.html
grep -c "/admin/sessions/{{ session.id }}/meeting" the55/app/templates/admin/sessions/view.html (should be 2)
  </verify>
  <done>Session control panel links to unified meeting screen instead of separate capture/present views</done>
</task>

</tasks>

<verification>
1. Open meeting screen during CAPTURING state - participant status updates without page reload
2. When all participants submit - "All Responses Received" message appears with green border
3. When state changes to REVEALED - smooth animation before synthesis appears
4. Press 1, 2, 3 keys - synthesis levels switch smoothly
5. Verify animations respect prefers-reduced-motion setting
</verification>

<success_criteria>
- MEET-03: Status area shows "All Responses Received" when all participants submitted
- MEET-04: Synthesis reveals below capture section (via page reload with animation)
- MEET-05: Keyboard navigation (1/2/3) works for synthesis levels
- MEET-07: "Ceremony moment" animation creates anticipation for synthesis reveal
- All transitions are smooth (MS-2 pitfall avoided)
</success_criteria>

<output>
After completion, create `.planning/phases/27-unified-meeting-screen/27-02-SUMMARY.md`
</output>
