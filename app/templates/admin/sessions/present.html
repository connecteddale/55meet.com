{% extends "base.html" %}

{% block title %}{{ team.team_name }} - {{ session.month }} | The 55{% endblock %}

{% block head %}
<style>
    /* Presentation-specific overrides for projector mode */
    body { background: #000; color: #fff; }
    header { display: none; }
    main { padding: 0; }
    .container { max-width: 1200px; }
</style>
{% endblock %}

{% block body_class %} class="presentation-mode"{% endblock %}

{% block header %}{% endblock %}

{% block content %}
<div class="presentation-container">
    <div class="presentation-header">
        <div class="presentation-team">{{ team.company_name }} &middot; {{ team.team_name }}</div>
        <div class="presentation-month">{{ session.month }}</div>
    </div>

    {% if synthesis_failed %}
    {# Synthesis Error State #}
    <div class="synthesis-error">
        <p class="synthesis-error-message">Synthesis generation failed</p>
        <p style="color: rgba(255,255,255,0.6); margin-bottom: var(--space-4);">{{ synthesis_themes }}</p>
        <form method="POST" action="/admin/sessions/{{ session.id }}/synthesize/retry">
            <button type="submit" class="retry-button">Retry Synthesis</button>
        </form>
    </div>
    {% else %}
    {# Level Tab Navigation #}
    <div class="level-tabs" role="tablist" aria-label="Presentation levels">
        <button class="level-tab active" data-level="1" role="tab" aria-selected="true" aria-controls="level-1">1. Themes</button>
        <button class="level-tab" data-level="2" role="tab" aria-selected="false" aria-controls="level-2">2. Insights</button>
        <button class="level-tab" data-level="3" role="tab" aria-selected="false" aria-controls="level-3">3. Raw</button>
    </div>

    {# Level 1: Themes #}
    <div id="level-1" class="level-content active" data-level="1" role="tabpanel" aria-labelledby="tab-1">
        {% if synthesis_themes %}
        <div class="presentation-section">
            <h2 class="presentation-label">What We Heard</h2>
            <p class="presentation-themes">{{ synthesis_themes }}</p>
        </div>
        {% endif %}

        {% if synthesis_gap_type %}
        <div class="presentation-section">
            <h2 class="presentation-label">Primary Gap</h2>
            <div class="presentation-gap gap-{{ synthesis_gap_type|lower }}">
                {{ synthesis_gap_type }}
            </div>
            <p class="presentation-gap-desc">
                {% if synthesis_gap_type == "Direction" %}
                Team members see different destinations. Where are we going?
                {% elif synthesis_gap_type == "Alignment" %}
                Team members are pulling in different directions. How do our efforts connect?
                {% elif synthesis_gap_type == "Commitment" %}
                Individual priorities outweigh collective goals. What will we sacrifice?
                {% endif %}
            </p>
        </div>
        {% endif %}

        <a href="/admin/sessions/{{ session.id }}/export/level1" class="level-export">Export Level 1</a>
    </div>

    {# Level 2: Insights #}
    <div id="level-2" class="level-content" data-level="2" role="tabpanel" aria-labelledby="tab-2">
        {% if synthesis_statements %}
        <div class="presentation-section">
            <h2 class="presentation-label">Key Insights (Attributed)</h2>
            <ul class="presentation-insights">
                {% for stmt in synthesis_statements %}
                <li>
                    <span class="insight-statement">{{ stmt.statement }}</span>
                    <span class="insight-names">({{ stmt.participants|join(', ') }})</span>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% else %}
        <div class="presentation-section">
            <p style="color: rgba(255,255,255,0.5);">No insights available.</p>
        </div>
        {% endif %}

        <a href="/admin/sessions/{{ session.id }}/export/level2" class="level-export">Export Level 2</a>
    </div>

    {# Level 3: Raw Responses #}
    <div id="level-3" class="level-content" data-level="3" role="tabpanel" aria-labelledby="tab-3">
        <div class="presentation-section">
            <h2 class="presentation-label">Raw Participant Responses</h2>
            {% if raw_responses %}
            {% for response in raw_responses %}
            <div class="raw-participant">
                <div class="raw-participant-name">{{ response.participant }}</div>
                <div class="raw-participant-image">Image #{{ response.image_number }}</div>
                {% if response.bullets %}
                <ul class="raw-bullets">
                    {% for bullet in response.bullets %}
                    <li>{{ bullet }}</li>
                    {% endfor %}
                </ul>
                {% else %}
                <p style="color: rgba(255,255,255,0.4); font-style: italic;">No bullets submitted</p>
                {% endif %}
            </div>
            {% endfor %}
            {% else %}
            <p style="color: rgba(255,255,255,0.5);">No responses recorded.</p>
            {% endif %}
        </div>

        <a href="/admin/sessions/{{ session.id }}/export/level3" class="level-export">Export Level 3</a>
    </div>

    {# Recalibration Action (shown on all levels if set) #}
    {% if session.recalibration_action %}
    <div class="presentation-section presentation-action">
        <h2 class="presentation-label">Recalibration Action</h2>
        <p class="presentation-action-text">{{ session.recalibration_action }}</p>
    </div>
    {% endif %}
    {% endif %}

    <div class="presentation-footer">
        <a href="/admin/sessions/{{ session.id }}" class="exit-presentation">Exit Presentation</a>
    </div>

    {# Keyboard hint #}
    {% if not synthesis_failed %}
    <div class="keyboard-hint">
        Press <kbd>1</kbd> <kbd>2</kbd> <kbd>3</kbd> to switch levels
    </div>
    {% endif %}
</div>

{% if not synthesis_failed %}
<script src="/static/js/presentation.js"></script>
{% endif %}
{% endblock %}
