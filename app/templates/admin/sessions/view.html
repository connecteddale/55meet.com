{% extends "base.html" %}

{% block title %}Session {{ session.month }} - The 55{% endblock %}

{% block nav %}
<nav>
    <a href="/admin/sessions/team/{{ team.id }}" class="btn btn-secondary">Back to Sessions</a>
</nav>
{% endblock %}

{% block content %}
<div class="session-control" data-session-id="{{ session.id }}">
    <div class="card">
        <div class="session-header">
            <div>
                <h2>{{ team.team_name }}</h2>
                <p class="team-subtitle">{{ team.company_name }} &middot; {{ session.month }}</p>
            </div>
            <div class="session-state-badge state-{{ session.state.value }}">
                {{ session.state.value }}
            </div>
        </div>

        <div class="session-stats" id="session-stats">
            <div class="stat">
                <span class="stat-value" id="submitted-count">{{ submitted_count }}</span>
                <span class="stat-label">Submitted</span>
            </div>
            <div class="stat">
                <span class="stat-value" id="total-members">{{ total_members }}</span>
                <span class="stat-label">Total Members</span>
            </div>
        </div>

        <div class="session-controls">
            {% if session.state.value == 'draft' %}
            <form method="post" action="/admin/sessions/{{ session.id }}/start">
                <button type="submit" class="btn btn-primary btn-large">
                    Start Capturing
                </button>
            </form>
            <p class="control-hint">Participants can join once capturing starts.</p>

            {% elif session.state.value == 'capturing' %}
            <form method="post" action="/admin/sessions/{{ session.id }}/close"
                  onsubmit="return confirm('Close capture? Participants will no longer be able to submit.');">
                <button type="submit" class="btn btn-warning btn-large">
                    Close Capture
                </button>
            </form>
            <p class="control-hint">Close when all participants have submitted.</p>

            {% elif session.state.value == 'closed' %}
            {% if synthesis_pending %}
            <form method="post" action="/admin/sessions/{{ session.id }}/synthesize">
                <button type="submit" class="btn btn-primary btn-large">
                    Generate Synthesis
                </button>
            </form>
            <p class="control-hint">This will analyze responses and generate themes.</p>
            {% elif synthesis_themes %}
            <form method="post" action="/admin/sessions/{{ session.id }}/reveal">
                <button type="submit" class="btn btn-primary btn-large">
                    Reveal to Participants
                </button>
            </form>
            <p class="control-hint">Shows synthesis to all participants.</p>
            {% else %}
            <div class="synthesis-generating">
                <div class="spinner"></div>
                <p>Generating synthesis...</p>
            </div>
            {% endif %}

            {# Reopen capture option for latecomers #}
            <div class="secondary-controls" style="margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--border-color);">
                <form method="post" action="/admin/sessions/{{ session.id }}/reopen"
                      onsubmit="return confirm('Reopen capture for latecomers?\n\nThis will clear any existing synthesis and allow new submissions.');">
                    <button type="submit" class="btn btn-secondary">
                        Reopen Capture
                    </button>
                </form>
                <p class="control-hint">Allow latecomers to submit. Clears synthesis if generated.</p>
            </div>

            {% elif session.state.value == 'revealed' %}
            <div class="session-complete">
                <p>Session complete. Synthesis revealed to participants.</p>
                <div class="session-actions" style="margin-top: var(--space-4);">
                    <a href="/admin/sessions/{{ session.id }}/present" class="btn btn-primary">
                        Presentation Mode
                    </a>
                    <a href="/admin/sessions/{{ session.id }}/export" class="btn btn-secondary">
                        Export JSON
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <h3>Participant Status</h3>
        <div class="member-status-list" id="member-status-list">
            {% for member in member_status %}
            <div class="member-status-item" data-member-id="{{ member.id }}">
                <span class="member-name">{{ member.name }}</span>
                <span class="status-indicator {% if member.submitted %}submitted{% else %}waiting{% endif %}">
                    {% if member.submitted %}Submitted{% else %}Waiting...{% endif %}
                </span>
                {% if session.state.value == 'capturing' and member.submitted %}
                <form method="post" action="/admin/sessions/{{ session.id }}/member/{{ member.id }}/clear"
                      onsubmit="return confirm('Clear {{ member.name }}\'s submission? They will need to resubmit.');"
                      style="margin-left: auto;">
                    <button type="submit" class="btn btn-small btn-danger">
                        Clear
                    </button>
                </form>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    {% if synthesis_themes %}
    <div class="card synthesis-preview">
        <h3>Synthesis Preview</h3>
        <div class="synthesis-themes">
            <h4>Themes</h4>
            <p>{{ synthesis_themes }}</p>
        </div>
        {% if synthesis_gap_type %}
        <div class="synthesis-gap">
            <h4>Gap Type</h4>
            <span class="gap-badge gap-{{ synthesis_gap_type|lower }}">{{ synthesis_gap_type }}</span>
        </div>
        {% endif %}
        {% if synthesis_statements %}
        <div class="synthesis-statements">
            <h4>Key Insights</h4>
            <ul>
            {% for stmt in synthesis_statements %}
                <li>{{ stmt.statement }} <em>({{ stmt.participants|join(', ') }})</em></li>
            {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>
    {% endif %}

    {% if session.state.value == 'revealed' %}
    <div class="card">
        <h3>Facilitator Notes</h3>
        <form method="post" action="/admin/sessions/{{ session.id }}/notes">
            <div class="form-group">
                <textarea name="facilitator_notes" rows="4" placeholder="Session observations, context, follow-up items...">{{ session.facilitator_notes or '' }}</textarea>
            </div>
            <button type="submit" class="btn btn-primary btn-small">Save Notes</button>
        </form>
    </div>

    <div class="card">
        <h3>Recalibration Action</h3>
        {% if session.recalibration_action %}
        <p class="recalibration-text">{{ session.recalibration_action }}</p>
        {% endif %}
        <form method="post" action="/admin/sessions/{{ session.id }}/notes">
            <div class="form-group">
                <textarea name="recalibration_action" rows="2" placeholder="ONE action the team commits to...">{{ session.recalibration_action or '' }}</textarea>
            </div>
            <button type="submit" class="btn btn-primary btn-small">Save Action</button>
        </form>
        {% if session.recalibration_action %}
        <form method="post" action="/admin/sessions/{{ session.id }}/recalibration" style="margin-top: var(--space-3);">
            <input type="hidden" name="completed" value="{{ 'false' if session.recalibration_completed else 'true' }}">
            <button type="submit" class="btn {% if session.recalibration_completed %}btn-secondary{% else %}btn-primary{% endif %} btn-small">
                {% if session.recalibration_completed %}Mark Incomplete{% else %}Mark Complete{% endif %}
            </button>
        </form>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{% if session.state.value == 'capturing' or session.state.value == 'closed' %}
<script src="/static/js/polling.js"></script>
{% endif %}
{% endblock %}
