{% extends "base.html" %}

{% block title %}Waiting - The 55{% endblock %}

{% block header %}
<header class="participant-header">
    <div class="container">
        <h1>The 55</h1>
        <span class="team-badge">{{ team.team_name }}</span>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="waiting-page" data-session-id="{{ session.id }}" data-team-code="{{ team.code }}" data-member-id="{{ member.id }}">
    <div class="waiting-card">
        <div class="waiting-icon">
            <svg viewBox="0 0 24 24" width="64" height="64" class="spinner">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-dasharray="31.4 31.4" />
            </svg>
        </div>

        <h2>Thank You, {{ member.name }}</h2>

        <p class="waiting-message" id="waiting-message">
            {% if session.state.value == 'capturing' %}
            Your response has been saved. You can edit until the facilitator closes capture.
            {% elif session.state.value == 'closed' %}
            Capture is closed. Waiting for facilitator to reveal synthesis.
            {% else %}
            Please wait while the facilitator reveals the results...
            {% endif %}
        </p>

        <div class="waiting-status">
            <span class="status-badge state-{{ session.state.value }}">
                {{ session.state.value | title }}
            </span>
        </div>

        <div class="waiting-actions" id="waiting-actions">
            {% if session.state.value == 'capturing' %}
            <a href="/join/{{ team.code }}/session/{{ session.id }}/member/{{ member.id }}/respond"
               class="btn btn-secondary" id="edit-btn">
                Edit Response
            </a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const POLL_INTERVAL = 3000;
    const container = document.querySelector('.waiting-page');
    const sessionId = container.dataset.sessionId;
    const teamCode = container.dataset.teamCode;
    const memberId = container.dataset.memberId;

    async function checkStatus() {
        try {
            const response = await fetch(`/join/${teamCode}/session/${sessionId}/status`);
            if (!response.ok) return;

            const data = await response.json();

            // Update message and edit button based on state
            const messageEl = document.getElementById('waiting-message');
            const actionsEl = document.getElementById('waiting-actions');

            if (data.state === 'revealed') {
                // Redirect to synthesis view
                window.location.href = `/join/${teamCode}/session/${sessionId}/synthesis`;
                return;
            } else if (data.state === 'closed') {
                messageEl.textContent = 'Capture is closed. Waiting for facilitator to reveal synthesis.';
                // Hide edit button when closed
                actionsEl.innerHTML = '';
            } else if (data.state === 'capturing') {
                messageEl.textContent = `Your response has been saved. Waiting for others (${data.submitted_count}/${data.total_members})...`;
                // Ensure edit button is visible
                if (!document.getElementById('edit-btn')) {
                    actionsEl.innerHTML = `<a href="/join/${teamCode}/session/${sessionId}/member/${memberId}/respond" class="btn btn-secondary" id="edit-btn">Edit Response</a>`;
                }
            }
        } catch (err) {
            console.error('Status check failed:', err);
        }
    }

    // Poll every 3 seconds
    setInterval(checkStatus, POLL_INTERVAL);
})();
</script>
{% endblock %}
