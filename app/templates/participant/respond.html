{% extends "base.html" %}

{% block title %}Select an Image - The 55{% endblock %}

{% block header %}
<header class="participant-header">
    <div class="container">
        <h1>The 55</h1>
        <span class="team-badge">{{ team.team_name }}</span>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="image-browser">
    <div class="browser-header">
        <h2>Select an Image, {{ member.name }}</h2>
        <p class="browser-subtitle">Choose the image that best represents how you feel about where your team is in executing the strategy.</p>
    </div>

    <form id="respond-form" method="POST" action="/join/{{ team.code }}/session/{{ session.id }}/member/{{ member.id }}/respond">
        <!-- Hidden inputs for form submission -->
        <input type="hidden" name="image_number" id="selected-image" value="{% if existing_response %}{{ existing_response.image_number }}{% endif %}">
        <input type="hidden" name="bullets" id="bullets-json" value="{% if existing_response %}{{ existing_response.bullets }}{% else %}[]{% endif %}">

        <!-- Image Grid Container -->
        <div class="image-grid" id="image-grid">
            {% for page_idx in range(image_pages|length) %}
            {% set start, end = image_pages[page_idx] %}
            <div class="image-page {% if page_idx == 0 %}active{% endif %}" data-page="{{ page_idx }}">
                {% for img_num in range(start, end + 1) %}
                <div class="image-card {% if existing_response and existing_response.image_number == img_num %}selected{% endif %}"
                     data-image="{{ img_num }}"
                     role="button"
                     tabindex="0"
                     aria-label="Image {{ img_num }}">
                    <img src="/static/images/55/{{ img_num }}.png"
                         alt="Image {{ img_num }}"
                         {% if page_idx == 0 %}loading="eager" fetchpriority="high"{% else %}loading="lazy"{% endif %}>
                    <span class="image-number">{{ img_num }}</span>
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>

        <!-- Pagination Controls -->
        <div class="pagination-controls">
            <button type="button" id="prev-btn" class="pagination-btn" disabled aria-label="Previous page">
                <span class="pagination-arrow">&larr;</span> Previous
            </button>
            <span class="pagination-info" id="pagination-info">1-6 of 55</span>
            <button type="button" id="next-btn" class="pagination-btn" aria-label="Next page">
                Next <span class="pagination-arrow">&rarr;</span>
            </button>
        </div>

        <!-- Bullet Point Section (shown after image selection) -->
        <div class="bullet-section" id="bullet-section" style="display: none;">
            <h3>Why does this image represent where you are?</h3>
            <p>Enter 1-5 bullet points explaining your choice.</p>

            {% if error %}
            <div class="form-error">{{ error }}</div>
            {% endif %}

            <div class="bullet-inputs">
                <input type="text"
                       class="bullet-input"
                       id="bullet-1"
                       placeholder="Bullet point 1 (required)"
                       maxlength="500"
                       required>
                <input type="text"
                       class="bullet-input"
                       id="bullet-2"
                       placeholder="Bullet point 2 (optional)"
                       maxlength="500">
                <input type="text"
                       class="bullet-input"
                       id="bullet-3"
                       placeholder="Bullet point 3 (optional)"
                       maxlength="500">
                <input type="text"
                       class="bullet-input"
                       id="bullet-4"
                       placeholder="Bullet point 4 (optional)"
                       maxlength="500">
                <input type="text"
                       class="bullet-input"
                       id="bullet-5"
                       placeholder="Bullet point 5 (optional)"
                       maxlength="500">
            </div>
        </div>

        <!-- Submit Button -->
        <div class="submit-section" id="submit-section">
            <button type="submit" id="submit-btn" class="btn-submit" disabled>
                Submit Response
            </button>
            <p class="selection-hint" id="selection-hint">Select an image to continue</p>
        </div>
    </form>
</div>

<script>
(function() {
    'use strict';

    // State
    let currentPage = 0;
    let selectedImage = null;
    const totalPages = {{ image_pages|length }};
    const imagePages = {{ image_pages|tojson }};
    const sessionId = {{ session.id }};
    const memberId = {{ member.id }};
    const draftKey = `draft-${sessionId}-${memberId}`;

    // DOM Elements
    const pages = document.querySelectorAll('.image-page');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const paginationInfo = document.getElementById('pagination-info');
    const selectedImageInput = document.getElementById('selected-image');
    const bulletsJsonInput = document.getElementById('bullets-json');
    const submitBtn = document.getElementById('submit-btn');
    const selectionHint = document.getElementById('selection-hint');
    const imageCards = document.querySelectorAll('.image-card');
    const bulletSection = document.getElementById('bullet-section');
    const bulletInputs = [
        document.getElementById('bullet-1'),
        document.getElementById('bullet-2'),
        document.getElementById('bullet-3'),
        document.getElementById('bullet-4'),
        document.getElementById('bullet-5')
    ];
    const respondForm = document.getElementById('respond-form');

    // Load draft from localStorage
    function loadDraft() {
        try {
            const draft = JSON.parse(localStorage.getItem(draftKey));
            if (draft) {
                if (draft.image && !selectedImageInput.value) {
                    selectedImage = draft.image;
                    selectedImageInput.value = draft.image;
                    // Find page
                    for (let i = 0; i < imagePages.length; i++) {
                        if (selectedImage >= imagePages[i][0] && selectedImage <= imagePages[i][1]) {
                            currentPage = i;
                            break;
                        }
                    }
                    updateSelection();
                    showBulletSection();
                }
                if (draft.bullets && draft.bullets.length > 0) {
                    draft.bullets.forEach((bullet, idx) => {
                        if (bulletInputs[idx]) {
                            bulletInputs[idx].value = bullet;
                        }
                    });
                    updateBulletsJson();
                    updateSubmitButton();
                }
            }
        } catch (e) {
            // Ignore localStorage errors
        }
    }

    // Save draft to localStorage
    function saveDraft() {
        try {
            const bullets = bulletInputs.map(input => input.value.trim()).filter(b => b);
            const draft = {
                image: selectedImage,
                bullets: bullets
            };
            localStorage.setItem(draftKey, JSON.stringify(draft));
        } catch (e) {
            // Ignore localStorage errors
        }
    }

    // Clear draft from localStorage
    function clearDraft() {
        try {
            localStorage.removeItem(draftKey);
        } catch (e) {
            // Ignore
        }
    }

    // Update hidden bullets JSON field
    function updateBulletsJson() {
        const bullets = bulletInputs.map(input => input.value.trim()).filter(b => b);
        bulletsJsonInput.value = JSON.stringify(bullets);
    }

    // Update submit button state
    function updateSubmitButton() {
        const hasImage = selectedImage !== null;
        const hasBullet = bulletInputs[0].value.trim().length > 0;
        submitBtn.disabled = !(hasImage && hasBullet);

        if (hasImage && hasBullet) {
            selectionHint.textContent = 'Ready to submit';
        } else if (hasImage) {
            selectionHint.textContent = 'Enter at least one bullet point';
        } else {
            selectionHint.textContent = 'Select an image to continue';
        }
    }

    // Show bullet section
    function showBulletSection() {
        bulletSection.style.display = 'block';
        // Scroll to bullet section smoothly
        setTimeout(() => {
            bulletSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
    }

    // Initialize from existing response
    const existingValue = selectedImageInput.value;
    const existingBullets = bulletsJsonInput.value;
    if (existingValue) {
        selectedImage = parseInt(existingValue, 10);
        // Find which page contains this image
        for (let i = 0; i < imagePages.length; i++) {
            if (selectedImage >= imagePages[i][0] && selectedImage <= imagePages[i][1]) {
                currentPage = i;
                break;
            }
        }
        updateSelection();
        showBulletSection();

        // Pre-fill bullets if editing
        if (existingBullets && existingBullets !== '[]') {
            try {
                const bullets = JSON.parse(existingBullets);
                bullets.forEach((bullet, idx) => {
                    if (bulletInputs[idx]) {
                        bulletInputs[idx].value = bullet;
                    }
                });
            } catch (e) {
                // Ignore parse errors
            }
        }
        updateSubmitButton();
    } else {
        // Try to restore from draft
        loadDraft();
    }

    // Update page display
    function showPage(pageIndex) {
        pages.forEach((page, idx) => {
            page.classList.toggle('active', idx === pageIndex);
        });

        // Update pagination info
        const [start, end] = imagePages[pageIndex];
        paginationInfo.textContent = `${start}-${end} of 55`;

        // Update button states
        prevBtn.disabled = pageIndex === 0;
        nextBtn.disabled = pageIndex === totalPages - 1;
    }

    // Handle page navigation
    prevBtn.addEventListener('click', function() {
        if (currentPage > 0) {
            currentPage--;
            showPage(currentPage);
        }
    });

    nextBtn.addEventListener('click', function() {
        if (currentPage < totalPages - 1) {
            currentPage++;
            showPage(currentPage);
        }
    });

    // Handle image selection
    function selectImage(imageNum) {
        selectedImage = imageNum;
        selectedImageInput.value = imageNum;
        updateSelection();
        showBulletSection();
        updateSubmitButton();
        saveDraft();
    }

    function updateSelection() {
        imageCards.forEach(card => {
            const cardImageNum = parseInt(card.dataset.image, 10);
            card.classList.toggle('selected', cardImageNum === selectedImage);
        });
    }

    // Attach click handlers to all image cards
    imageCards.forEach(card => {
        // Click handler (works for touch and mouse)
        card.addEventListener('click', function() {
            const imageNum = parseInt(this.dataset.image, 10);
            selectImage(imageNum);
        });

        // Keyboard accessibility
        card.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                const imageNum = parseInt(this.dataset.image, 10);
                selectImage(imageNum);
            }
        });
    });

    // Attach event handlers to bullet inputs
    bulletInputs.forEach(input => {
        input.addEventListener('input', function() {
            updateBulletsJson();
            updateSubmitButton();
            saveDraft();
        });
    });

    // Handle form submission
    respondForm.addEventListener('submit', function(e) {
        // Update bullets JSON before submission
        updateBulletsJson();

        // Check validation
        const bullets = bulletInputs.map(input => input.value.trim()).filter(b => b);
        if (bullets.length === 0) {
            e.preventDefault();
            alert('Please enter at least one bullet point.');
            return;
        }

        // Show loading state
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        submitBtn.classList.add('loading');

        // Clear draft on submit
        clearDraft();
    });

    // Initialize page display
    showPage(currentPage);
})();
</script>
{% endblock %}
