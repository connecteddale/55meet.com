{% extends "base.html" %}

{% block title %}Select an Image - The 55{% endblock %}

{% block header %}
<header class="participant-header">
    <div class="container">
        <h1>The 55</h1>
        <span class="team-badge">{{ team.team_name }}</span>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="image-browser">
    <!-- Sticky Header: Instructions -->
    <div class="image-browser-sticky">
        <div class="browser-instruction">
            {% if team.image_prompt %}
            <p>{{ team.image_prompt }}</p>
            {% elif team.strategy_statement %}
            <p>Select an image, {{ member.name }}.<br>Choose the one that best represents how your team is executing your strategy:</p>
            <p style="font-style: italic; font-weight: 700; font-size: 1.1em; margin-top: var(--space-2);">{{ team.strategy_statement }}</p>
            {% else %}
            <p>Select an image, {{ member.name }}. Choose the one that best represents how your team is working together right now.</p>
            {% endif %}
            <a href="/join/{{ team.code }}/session/{{ session.id }}/name"
               class="not-me-link">Not {{ member.name }}?</a>
        </div>
        <!-- Hidden pagination elements (required by JS) -->
        <div class="pagination-header" style="display: none;">
            <button type="button" id="prev-btn" class="pagination-btn" disabled>Prev</button>
            <span class="page-indicator" id="page-indicator">Page 1 of 1</span>
            <button type="button" id="next-btn" class="pagination-btn">Next</button>
        </div>
        <div class="jump-to-selection" id="jump-to-selection" style="display: none;"></div>
    </div>

    <form id="respond-form" method="POST" action="/join/{{ team.code }}/session/{{ session.id }}/member/{{ member.id }}/respond">
        <!-- Hidden inputs for form submission -->
        <input type="hidden" name="image_id" id="selected-image" value="{% if existing_response %}{{ existing_response.image_id }}{% endif %}">
        <input type="hidden" name="bullets" id="bullets-json" value="{% if existing_response %}{{ existing_response.bullets }}{% else %}[]{% endif %}">

        <!-- Image Grid Container (loaded via AJAX) -->
        <div class="image-grid-container" id="image-grid-container">
            <div class="image-page active" id="image-page">
                <!-- Images loaded via JavaScript -->
            </div>
        </div>

        <!-- Bullet Point Section (shown after image selection) -->
        <div class="bullet-section" id="bullet-section" style="display: none;">
            <div class="selected-image-preview" id="selected-image-preview">
                <!-- Selected image shown here via JS -->
            </div>
            {% if team.bullet_prompt %}
            <h3>{{ team.bullet_prompt }}</h3>
            {% elif team.strategy_statement %}
            <h3>Why does this image represent how you're executing your strategy?</h3>
            {% else %}
            <h3>Why does this image represent your team right now?</h3>
            {% endif %}
            <p>Enter at least one bullet point explaining your choice.</p>

            {% if error %}
            <div class="form-error">{{ error }}</div>
            {% endif %}

            <div class="bullet-inputs">
                <input type="text"
                       class="bullet-input"
                       id="bullet-1"
                       placeholder="Bullet point 1 (required)"
                       maxlength="500"
                       required>
                <span class="input-error-message" id="bullet-1-error">at least 2 words</span>
                <input type="text"
                       class="bullet-input bullet-input-hidden"
                       id="bullet-2"
                       placeholder="Bullet point 2 (optional)"
                       maxlength="500">
                <input type="text"
                       class="bullet-input bullet-input-hidden"
                       id="bullet-3"
                       placeholder="Bullet point 3 (optional)"
                       maxlength="500">
                <input type="text"
                       class="bullet-input bullet-input-hidden"
                       id="bullet-4"
                       placeholder="Bullet point 4 (optional)"
                       maxlength="500">
                <input type="text"
                       class="bullet-input bullet-input-hidden"
                       id="bullet-5"
                       placeholder="Bullet point 5 (optional)"
                       maxlength="500">
            </div>
            <button type="button" id="clear-btn" class="clear-response-btn">Clear responses</button>
        </div>

        <!-- Submit Button -->
        <div class="submit-section" id="submit-section">
            <button type="submit" id="submit-btn" class="btn-submit" disabled>
                Capture Snapshot
            </button>
            <p class="selection-hint" id="selection-hint">Select an image to continue</p>
        </div>
    </form>
</div>

<script>
(function() {
    'use strict';

    // Configuration from server
    const sessionId = {{ session.id }};
    const memberId = {{ member.id }};
    const teamCode = "{{ team.code }}";
    const perPage = 60;  // Show all 60 images on single page

    // State
    let currentPage = 1;
    let totalPages = 1;
    let selectedImageId = null;
    let selectedImagePage = null;
    let loadedPages = new Map();  // page -> images array
    const storageKey = `image-browser-${sessionId}-${memberId}`;
    const draftKey = `draft-${sessionId}-${memberId}`;

    // DOM Elements
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const pageIndicator = document.getElementById('page-indicator');
    const imagePage = document.getElementById('image-page');
    const jumpSection = document.getElementById('jump-to-selection');
    const selectedImageInput = document.getElementById('selected-image');
    const bulletsJsonInput = document.getElementById('bullets-json');
    const submitBtn = document.getElementById('submit-btn');
    const selectionHint = document.getElementById('selection-hint');
    const bulletSection = document.getElementById('bullet-section');
    const selectedImagePreview = document.getElementById('selected-image-preview');
    let selectedImageUrl = null;  // Store URL for preview
    const bulletInputs = [
        document.getElementById('bullet-1'),
        document.getElementById('bullet-2'),
        document.getElementById('bullet-3'),
        document.getElementById('bullet-4'),
        document.getElementById('bullet-5')
    ];
    const bullet1Error = document.getElementById('bullet-1-error');
    const respondForm = document.getElementById('respond-form');

    // ========================================
    // Page Loading (AJAX)
    // ========================================

    async function loadPage(pageNum) {
        // Show loading state
        imagePage.innerHTML = '<div class="image-page-loading"><div class="spinner"></div></div>';

        try {
            const url = `/api/images?page=${pageNum}&per_page=${perPage}&seed=${sessionId}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to load images');

            const data = await response.json();
            totalPages = data.total_pages;

            // Cache the page
            loadedPages.set(pageNum, data.images);

            // Render images
            renderPage(data.images);

            // Update pagination
            updatePagination(pageNum);

            // Save state to sessionStorage (IG-2)
            savePageState(pageNum);

        } catch (error) {
            console.error('Error loading images:', error);
            imagePage.innerHTML = '<p class="error">Failed to load images. Please refresh the page.</p>';
        }
    }

    function renderPage(images) {
        // Build grid HTML - no filenames or IDs shown to users
        const html = images.map((img, idx) => {
            const isSelected = img.id === selectedImageId;
            const imageNum = idx + 1 + ((currentPage - 1) * perPage);  // Sequential number for accessibility
            return `
                <div class="image-card ${isSelected ? 'selected' : ''}"
                     data-image="${img.id}"
                     role="button"
                     tabindex="0"
                     aria-label="Image option ${imageNum}">
                    <img src="${img.url}"
                         alt="Image option"
                         loading="${idx < 6 ? 'eager' : 'lazy'}">
                </div>
            `;
        }).join('');

        imagePage.innerHTML = html;
        imagePage.classList.add('active');

        // Attach event handlers to new cards
        attachCardHandlers();
    }

    function attachCardHandlers() {
        const cards = imagePage.querySelectorAll('.image-card');
        cards.forEach(card => {
            card.addEventListener('click', function() {
                const imageId = this.dataset.image;
                selectImage(imageId);
            });
            card.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    const imageId = this.dataset.image;
                    selectImage(imageId);
                }
            });
        });
    }

    function updatePagination(pageNum) {
        currentPage = pageNum;
        pageIndicator.textContent = `Page ${pageNum} of ${totalPages}`;
        prevBtn.disabled = pageNum <= 1;
        nextBtn.disabled = pageNum >= totalPages;

        // Show "jump to selection" if selection is on different page
        if (selectedImagePage && selectedImagePage !== pageNum) {
            jumpSection.classList.add('visible');
        } else {
            jumpSection.classList.remove('visible');
        }
    }

    // ========================================
    // State Persistence (IG-2)
    // ========================================

    function savePageState(pageNum) {
        try {
            sessionStorage.setItem(storageKey, JSON.stringify({
                page: pageNum,
                selectedId: selectedImageId,
                selectedPage: selectedImagePage
            }));
        } catch (e) {
            // Ignore storage errors
        }
    }

    function loadPageState() {
        try {
            const saved = sessionStorage.getItem(storageKey);
            if (saved) {
                const state = JSON.parse(saved);
                if (state.selectedId) {
                    selectedImageId = state.selectedId;
                    selectedImagePage = state.selectedPage;
                }
                return state.page || 1;
            }
        } catch (e) {
            // Ignore
        }
        return 1;
    }

    // ========================================
    // Draft Persistence
    // ========================================

    function loadDraft() {
        try {
            const draft = JSON.parse(localStorage.getItem(draftKey));
            if (draft) {
                if (draft.image && !selectedImageInput.value) {
                    selectedImageId = draft.image;
                    selectedImageInput.value = draft.image;
                    // We'll find the page when we load
                }
                if (draft.bullets && draft.bullets.length > 0) {
                    draft.bullets.forEach((bullet, idx) => {
                        if (bulletInputs[idx]) {
                            bulletInputs[idx].value = bullet;
                        }
                    });
                    updateBulletsJson();
                }
            }
        } catch (e) {
            // Ignore
        }
    }

    function saveDraft() {
        try {
            const bullets = bulletInputs.map(input => input.value.trim()).filter(b => b);
            localStorage.setItem(draftKey, JSON.stringify({
                image: selectedImageId,
                bullets: bullets
            }));
        } catch (e) {
            // Ignore
        }
    }

    function clearDraft() {
        try {
            localStorage.removeItem(draftKey);
            sessionStorage.removeItem(storageKey);
        } catch (e) {
            // Ignore
        }
    }

    // ========================================
    // Image Selection
    // ========================================

    function selectImage(imageId) {
        selectedImageId = imageId;
        selectedImageInput.value = imageId;
        selectedImagePage = currentPage;

        // Update visual selection and get image URL
        const cards = imagePage.querySelectorAll('.image-card');
        cards.forEach(card => {
            const isSelected = card.dataset.image === imageId;
            card.classList.toggle('selected', isSelected);
            if (isSelected) {
                selectedImageUrl = card.querySelector('img').src;
            }
        });

        // Update the preview with selected image
        if (selectedImageUrl) {
            selectedImagePreview.innerHTML = `<img src="${selectedImageUrl}" alt="Your selected image">`;
        }

        // Show bullet section, scroll to it, and focus the first input
        bulletSection.style.display = 'block';
        setTimeout(() => {
            bulletSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            // Focus the first bullet input after scrolling
            setTimeout(() => {
                bulletInputs[0].focus();
            }, 300);
        }, 100);

        updateSubmitButton();
        saveDraft();
        savePageState(currentPage);

        // Hide jump button since we're on selection page
        jumpSection.classList.remove('visible');
    }

    function jumpToSelection() {
        if (selectedImagePage && selectedImagePage !== currentPage) {
            loadPage(selectedImagePage);
        }
    }
    // Expose to global for onclick
    window.jumpToSelection = jumpToSelection;

    // ========================================
    // Bullet Points
    // ========================================

    function updateBulletsJson() {
        const bullets = bulletInputs.map(input => input.value.trim()).filter(b => b);
        bulletsJsonInput.value = JSON.stringify(bullets);
    }

    function hasAtLeastTwoWords(text) {
        // Rule: at least 1 letter, space, at least 1 letter
        // "I am" (1 letter + 2 letters) is fine, "a b" (1+1) is fine
        // Split on whitespace and filter for words with at least 1 letter
        const words = text.trim().split(/\s+/).filter(word => {
            return word.length >= 1 && /[a-zA-Z]/.test(word);
        });
        return words.length >= 2;
    }

    function updateSubmitButton() {
        const hasImage = selectedImageId !== null;
        const bulletText = bulletInputs[0].value.trim();
        const hasValidBullet = hasAtLeastTwoWords(bulletText);
        submitBtn.disabled = !(hasImage && hasValidBullet);

        // Inline validation for first bullet input
        if (hasImage && bulletText.length > 0 && !hasValidBullet) {
            bulletInputs[0].classList.add('input-error');
            bullet1Error.classList.add('visible');
        } else {
            bulletInputs[0].classList.remove('input-error');
            bullet1Error.classList.remove('visible');
        }

        // Update bottom hint
        if (hasImage && hasValidBullet) {
            selectionHint.style.display = 'none';
        } else if (!hasImage) {
            selectionHint.style.display = '';
            selectionHint.textContent = 'Select an image to continue';
        } else {
            selectionHint.style.display = 'none';
        }
    }

    // ========================================
    // Event Handlers
    // ========================================

    prevBtn.addEventListener('click', function() {
        if (currentPage > 1) {
            loadPage(currentPage - 1);
        }
    });

    nextBtn.addEventListener('click', function() {
        if (currentPage < totalPages) {
            loadPage(currentPage + 1);
        }
    });

    bulletInputs.forEach(input => {
        input.addEventListener('input', function() {
            // Clear error state when typing
            this.classList.remove('input-error');
            const errorMsg = document.getElementById(this.id + '-error');
            if (errorMsg) errorMsg.classList.remove('visible');

            updateBulletsJson();
            updateSubmitButton();
            saveDraft();
        });
    });

    // Blur validation for first bullet - must have 2 words to leave
    bulletInputs[0].addEventListener('blur', function(e) {
        const text = this.value.trim();
        // Only validate if they've started typing (not empty)
        if (text.length > 0 && !hasAtLeastTwoWords(text)) {
            // Show error state
            this.classList.add('input-error');
            bullet1Error.classList.add('visible');
            // Refocus to prevent leaving
            setTimeout(() => {
                this.focus();
            }, 0);
        }
    });

    // Clear responses button handler - keeps image, clears only bullet text
    const clearBtn = document.getElementById('clear-btn');
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            // Clear all bullet inputs and reset error state
            bulletInputs.forEach((input, idx) => {
                input.value = '';
                input.classList.remove('input-error');
                if (idx > 0) {
                    input.classList.add('bullet-input-hidden');
                    input.classList.remove('bullet-input-reveal');
                }
            });
            bullet1Error.classList.remove('visible');

            // Update bullets JSON to empty
            bulletsJsonInput.value = '[]';

            // Keep the image selected - do NOT clear selectedImageId, selectedImageInput, etc.
            // Image preview stays visible

            // Save draft with cleared bullets but same image
            saveDraft();

            // Reset submit button (needs valid bullet to enable)
            submitBtn.disabled = true;

            // Focus the first bullet input
            bulletInputs[0].focus();
        });
    }

    respondForm.addEventListener('submit', function(e) {
        updateBulletsJson();

        const bullets = bulletInputs.map(input => input.value.trim()).filter(b => b);
        if (bullets.length === 0 || !hasAtLeastTwoWords(bullets[0])) {
            e.preventDefault();
            alert('Please enter at least two words in your first bullet point.');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        submitBtn.classList.add('loading');

        clearDraft();
    });

    // ========================================
    // Initialization
    // ========================================

    function init() {
        // Load from existing response first
        const existingValue = selectedImageInput.value;
        const existingBullets = bulletsJsonInput.value;

        if (existingValue) {
            selectedImageId = existingValue;
            // Pre-fill bullets if editing
            if (existingBullets && existingBullets !== '[]') {
                try {
                    const bullets = JSON.parse(existingBullets);
                    bullets.forEach((bullet, idx) => {
                        if (bulletInputs[idx]) {
                            bulletInputs[idx].value = bullet;
                        }
                    });
                } catch (e) {}
            }
            bulletSection.style.display = 'block';
            updateSubmitButton();
        } else {
            // Try to restore from draft
            loadDraft();
            if (selectedImageId) {
                bulletSection.style.display = 'block';
                updateSubmitButton();
            }
        }

        // Restore page position
        const savedPage = loadPageState();

        // Load the page (either saved position or page 1)
        loadPage(savedPage);
    }

    init();
})();
</script>
<script src="/static/js/progressive-inputs.js"></script>
{% endblock %}
