{% extends "base.html" %}

{% block title %}Waiting - The 55{% endblock %}

{% block header %}
<header class="participant-header">
    <div class="container">
        <h1>The 55</h1>
        <span class="team-badge">{{ team.team_name }}</span>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="waiting-page" data-session-id="{{ session.id }}" data-team-code="{{ team.code }}" data-member-id="{{ member.id }}">
    <!-- Waiting state view -->
    <div class="waiting-card" id="waiting-card">
        <div class="waiting-icon">
            <svg viewBox="0 0 24 24" width="64" height="64" class="spinner">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-dasharray="31.4 31.4" />
            </svg>
        </div>

        <h2>Thank You, {{ member.name }}</h2>

        <p class="waiting-message" id="waiting-message">
            {% if session.state.value == 'capturing' %}
            Your response has been saved. You can edit until the facilitator closes capture.
            {% elif session.state.value == 'closed' %}
            Capture Closed
            {% else %}
            Please wait while the facilitator reveals the results...
            {% endif %}
        </p>
        <p class="waiting-submessage" id="waiting-submessage" style="color: var(--color-text-secondary); font-size: var(--text-sm); margin-top: var(--space-2); {% if session.state.value != 'closed' %}display: none;{% endif %}">
            Your facilitator will share results.
        </p>

        <div class="waiting-status">
            <span class="status-badge state-{{ session.state.value }}">
                {{ session.state.value | title }}
            </span>
        </div>

        <div class="submitted-names" id="submitted-names" style="display: none; margin-top: 1.5rem; text-align: left; width: 100%; max-width: 320px; margin-left: auto; margin-right: auto;">
            <p style="font-size: 0.85rem; color: var(--color-text-muted); margin-bottom: 0.5rem;">Submitted:</p>
            <ul id="names-list" style="list-style: none; padding: 0; margin: 0; display: flex; flex-wrap: wrap; gap: 0.5rem;">
            </ul>
        </div>

        <div class="unsubmitted-names" id="unsubmitted-names" style="display: none; margin-top: 1rem; text-align: left; width: 100%; max-width: 320px; margin-left: auto; margin-right: auto;">
            <p style="font-size: 0.85rem; color: var(--color-text-muted); margin-bottom: 0.5rem;">Still to submit:</p>
            <ul id="unsubmitted-list" style="list-style: none; padding: 0; margin: 0; display: flex; flex-wrap: wrap; gap: 0.5rem;"></ul>
        </div>

        <div class="waiting-actions" id="waiting-actions" style="margin-top: var(--space-6);">
            {% if session.state.value == 'capturing' %}
            <a href="/join/{{ team.code }}/session/{{ session.id }}/member/{{ member.id }}/respond"
               class="btn btn-primary" id="edit-btn">
                Edit Response
            </a>
            {% endif %}
        </div>
    </div>

    <!-- My response view (shown when closed) -->
    <div class="my-response-card" id="my-response-card" style="display: none;">
        <div class="my-response-header">
            <h2>{{ member.name }}'s Response</h2>
            <span class="status-badge state-closed">Capture Closed</span>
        </div>

        <div class="my-response-strategy" id="my-response-strategy" style="display: none;">
            <p class="strategy-label">Strategy:</p>
            <p class="strategy-text" id="strategy-text"></p>
        </div>

        <div class="my-response-prompt" id="my-response-prompt">
            <p class="prompt-text" id="prompt-text"></p>
        </div>

        <div class="my-response-image">
            <img id="my-image" src="" alt="Your chosen image">
        </div>

        <div class="my-response-bullets">
            <p class="bullets-label" id="bullets-label"></p>
            <ul id="my-bullets"></ul>
        </div>

        <p class="my-response-footer">
            Your facilitator will share the team results.
        </p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const POLL_INTERVAL = 3000;
    const container = document.querySelector('.waiting-page');
    const sessionId = container.dataset.sessionId;
    const teamCode = container.dataset.teamCode;
    const memberId = container.dataset.memberId;
    let responseShown = false;

    function showMyResponse(data) {
        if (responseShown) return;
        responseShown = true;

        const waitingCard = document.getElementById('waiting-card');
        const responseCard = document.getElementById('my-response-card');

        // Populate response data
        const resp = data.my_response;
        if (resp.strategy_statement) {
            document.getElementById('my-response-strategy').style.display = 'block';
            document.getElementById('strategy-text').textContent = resp.strategy_statement;
        }

        document.getElementById('prompt-text').textContent = resp.image_prompt;
        document.getElementById('my-image').src = resp.image_url;
        document.getElementById('bullets-label').textContent = resp.bullet_prompt + ':';

        const bulletsList = document.getElementById('my-bullets');
        bulletsList.innerHTML = resp.bullets.map(b => `<li>${b}</li>`).join('');

        // Transition between cards
        if (document.startViewTransition) {
            document.startViewTransition(() => {
                waitingCard.style.display = 'none';
                responseCard.style.display = 'block';
            });
        } else {
            waitingCard.style.display = 'none';
            responseCard.style.display = 'block';
        }
    }

    async function checkStatus() {
        try {
            const response = await fetch(`/join/${teamCode}/session/${sessionId}/status?member_id=${memberId}`);
            if (!response.ok) return;

            const data = await response.json();

            // Update message and edit button based on state
            const messageEl = document.getElementById('waiting-message');
            const actionsEl = document.getElementById('waiting-actions');

            // Update submitted names list
            const namesList = document.getElementById('names-list');
            if (namesList && data.submitted_members && data.submitted_members.length > 0) {
                document.getElementById('submitted-names').style.display = 'block';
                namesList.innerHTML = data.submitted_members.map(m =>
                    `<li style="background: var(--color-primary-light, #e8f4f8); color: var(--color-primary-dark, #1a5276); padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.85rem; font-weight: 500;">${m.name}</li>`
                ).join('');
            } else if (namesList) {
                document.getElementById('submitted-names').style.display = 'none';
            }

            // Update unsubmitted names list
            const unsubmittedList = document.getElementById('unsubmitted-list');
            if (unsubmittedList && data.unsubmitted_members && data.unsubmitted_members.length > 0) {
                document.getElementById('unsubmitted-names').style.display = 'block';
                unsubmittedList.innerHTML = data.unsubmitted_members.map(m =>
                    `<li style="background: var(--color-bg-secondary, #f1f5f9); color: var(--color-text-muted, #64748b); padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.85rem; font-weight: 500;">${m.name}</li>`
                ).join('');
            } else if (unsubmittedList) {
                document.getElementById('unsubmitted-names').style.display = 'none';
            }

            if (data.state === 'revealed') {
                // Redirect to synthesis view with View Transition
                const url = `/join/${teamCode}/session/${sessionId}/synthesis`;
                if (document.startViewTransition) {
                    document.startViewTransition(() => {
                        window.location.href = url;
                    });
                } else {
                    window.location.href = url;
                }
                return;
            } else if (data.state === 'closed') {
                // Show member's own response when closed
                if (data.my_response) {
                    showMyResponse(data);
                } else {
                    messageEl.textContent = 'Capture Closed';
                    const submessageEl = document.getElementById('waiting-submessage');
                    if (submessageEl) submessageEl.style.display = 'block';
                    actionsEl.innerHTML = '';
                }
            } else if (data.state === 'capturing') {
                messageEl.textContent = `Waiting for others (${data.submitted_count}/${data.total_members})...`;
                // Hide submessage and ensure edit button is visible
                const submessageEl = document.getElementById('waiting-submessage');
                if (submessageEl) submessageEl.style.display = 'none';
                if (!document.getElementById('edit-btn')) {
                    actionsEl.innerHTML = `<a href="/join/${teamCode}/session/${sessionId}/member/${memberId}/respond" class="btn btn-primary" id="edit-btn">Edit Response</a>`;
                }
            }
        } catch (err) {
            console.error('Status check failed:', err);
        }
    }

    // Poll every 3 seconds
    setInterval(checkStatus, POLL_INTERVAL);
    // Check immediately on load
    checkStatus();
})();
</script>
{% endblock %}
