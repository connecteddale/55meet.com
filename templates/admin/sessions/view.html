{% extends "base.html" %}

{% block title %}Session {{ session.month }} - The 55{% endblock %}

{% block nav %}
<nav class="admin-nav">
    <div class="nav-links">
        <a href="/admin" class="nav-link">Dashboard</a>
    </div>
    <div style="display: flex; gap: var(--space-2); align-items: center;">
        <a href="/admin/settings" class="settings-icon-btn" title="Settings">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
        </a>
        <a href="/admin/logout" class="btn btn-ghost btn-small">Logout</a>
    </div>
</nav>
{% endblock %}

{% block content %}
<a href="/admin" class="back-link">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="15 18 9 12 15 6"></polyline>
    </svg>
    Dashboard
</a>

<div class="session-view" data-session-id="{{ session.id }}">
    {# Header - Team info and state #}
    <div class="session-view-header">
        <div class="session-title">
            <h1>{{ team.team_name }}</h1>
            <span class="session-meta">{{ team.company_name }} &middot; {{ session.month }}</span>
        </div>
        <span class="state-badge state-{{ session.state.value }}">{{ session.state.value }}</span>
    </div>

    {# Main content - Two column layout #}
    <div class="session-view-grid">
        {# Left column: QR, join info, controls #}
        <div class="session-left-col">
            {% if session.state.value == 'capturing' %}
            <div class="qr-panel">
                <a href="/join?code={{ team.code }}" target="_blank" class="qr-link" title="Click to open join page">
                    <img src="/admin/qr/team/{{ team.id }}" alt="Scan to join" class="qr-image">
                </a>
                <div class="join-info">
                    <a href="/join?code={{ team.code }}" target="_blank" class="join-code">{{ team.code }}</a>
                    <span class="join-url">55meet.com/join</span>
                </div>
            </div>
            {% endif %}

            <div class="stats-row">
                <div class="stat-box">
                    <span class="stat-number" id="submitted-count">{{ submitted_count }}</span>
                    <span class="stat-label">Submitted</span>
                </div>
                <div class="stat-box">
                    <span class="stat-number" id="total-members">{{ total_members }}</span>
                    <span class="stat-label">Total</span>
                </div>
            </div>

            <div class="controls-panel">
                {% if session.state.value == 'capturing' %}
                <form method="post" action="/admin/sessions/{{ session.id }}/close"
                      onsubmit="return confirm('Close capture? Participants will no longer be able to submit.');">
                    <button type="submit" class="btn btn-warning btn-block">Close Capture</button>
                </form>
                <p class="hint">Close when all participants have submitted.</p>

                {% elif session.state.value in ['closed', 'revealed'] %}
                {% if synthesis_pending or synthesis_generating %}
                <div class="synthesis-loading">
                    <div class="spinner"></div>
                    <p>Synthesizing responses...</p>
                    <p class="hint">Results will appear automatically (30-60 seconds)</p>
                </div>
                {% elif synthesis_themes %}
                {# Export buttons after synthesis is generated #}
                <a href="/admin/sessions/{{ session.id }}/export/pdf" class="btn btn-primary btn-block">Export PDF</a>
                <a href="/admin/sessions/{{ session.id }}/export" class="btn btn-secondary btn-block">Export JSON</a>
                <a href="/admin/sessions/{{ session.id }}/export/markdown" class="btn btn-secondary btn-block">Export Markdown</a>
                <form method="post" action="/admin/sessions/{{ session.id }}/synthesize/retry" id="regenerate-form"
                      onsubmit="return confirm('Regenerate synthesis? This will replace the current analysis.');">
                    <button type="submit" class="btn btn-ghost btn-block" id="regenerate-btn">Regenerate Synthesis</button>
                </form>
                {% endif %}
                <form method="post" action="/admin/sessions/{{ session.id }}/reopen"
                      onsubmit="return confirm('Reopen engagement?\n\n{% if synthesis_themes %}WARNING: This will clear the current synthesis. You will need to regenerate it after closing again.{% else %}Participants will be able to submit or resubmit.{% endif %}');">
                    <button type="submit" class="btn btn-ghost btn-block">Reopen Engagement</button>
                </form>
                {% endif %}
            </div>
        </div>

        {# Right column: Member status #}
        <div class="session-right-col">
            <div class="participants-header">
                <h2>Participants</h2>
                <span class="member-count">{{ member_status|length }}</span>
            </div>

            {# Add member form #}
            <form method="post" action="/admin/sessions/{{ session.id }}/members/add" class="add-member-inline" id="add-member-form">
                <input type="text" name="name" id="add-member-input" placeholder="Add participant..." required autocomplete="off">
                <button type="submit" class="btn-add" title="Add participant">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                </button>
            </form>
            {% if error %}
            <div class="member-error" id="member-error">{{ error }}</div>
            {% endif %}

            <div class="member-list" id="member-status-list">
                {% for member in member_status %}
                <div class="member-row" data-member-id="{{ member.id }}">
                    <span class="member-name">{{ member.name }}</span>
                    <span class="member-status {% if member.submitted %}done{% else %}waiting{% endif %}">
                        {% if member.submitted %}&#10003;{% else %}&hellip;{% endif %}
                    </span>
                    <div class="member-actions">
                        {% if session.state.value == 'capturing' and member.submitted %}
                        <form method="post" action="/admin/sessions/{{ session.id }}/member/{{ member.id }}/clear"
                              onsubmit="return confirm('Clear {{ member.name }}\'s submission?');" class="clear-form">
                            <button type="submit" class="btn-clear" title="Clear submission">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </form>
                        {% endif %}
                        <form method="post" action="/admin/sessions/{{ session.id }}/members/{{ member.id }}/remove"
                              onsubmit="return confirm('Remove {{ member.name }} from the team?');" class="remove-form">
                            <button type="submit" class="btn-remove" title="Remove from team">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    {# Facilitator section (shown when synthesis is available in closed or revealed state) #}
    {% if synthesis_themes and session.state.value in ['closed', 'revealed'] %}
    <div class="facilitator-section">
        <div class="facilitator-card">
            <h2>Facilitator Notes</h2>
            <form method="post" action="/admin/sessions/{{ session.id }}/notes">
                <textarea name="facilitator_notes" rows="3" placeholder="Session observations, context, follow-up items...">{{ session.facilitator_notes or '' }}</textarea>
                <button type="submit" class="btn btn-primary btn-small">Save</button>
            </form>
            {% if session.facilitator_notes_updated_at %}
            <p class="last-saved">Last saved: {{ session.facilitator_notes_updated_at.strftime('%Y-%m-%d %H:%M') }}</p>
            {% endif %}
        </div>

        <div class="facilitator-card">
            <h2>Recalibration Action</h2>
            <form method="post" action="/admin/sessions/{{ session.id }}/notes">
                <textarea name="recalibration_action" rows="3" placeholder="ONE action the team commits to...">{{ session.recalibration_action or '' }}</textarea>
                <button type="submit" class="btn btn-primary btn-small">Save</button>
            </form>
            {% if session.recalibration_action_updated_at %}
            <p class="last-saved">Last saved: {{ session.recalibration_action_updated_at.strftime('%Y-%m-%d %H:%M') }}</p>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {# Synthesis results (shown when available) #}
    {% if synthesis_themes %}
    <div class="synthesis-results">
        <div class="synthesis-card">
            <h2>What We Heard</h2>
            <p class="themes-text">{{ synthesis_themes }}</p>
        </div>

        {% if synthesis_statements %}
        <div class="synthesis-card">
            <h2>Key Insights</h2>
            <ul class="insights-list">
                {% for stmt in synthesis_statements %}
                <li>
                    <span class="insight-text">{{ stmt.statement }}</span>
                    <span class="insight-attr">&mdash; {{ stmt.participants|join(', ') }}</span>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        {% if synthesis_gap_type %}
        <div class="synthesis-card">
            <h2>Diagnosis</h2>
            <p class="diagnosis-text">Suggested area to work on: <strong>{{ synthesis_gap_type }}</strong></p>

            <h2>Rationale</h2>
            <p class="rationale-text">{{ synthesis_gap_reasoning }}</p>
        </div>
        {% endif %}

    </div>
    {% endif %}

    {# Participant Responses (shown when synthesis is available) #}
    {% if synthesis_themes and participant_responses %}
    <div class="participant-responses-section">
        <h2>Participant Responses</h2>
        <div class="responses-grid">
            {% for response in participant_responses %}
            <div class="response-card">
                <div class="response-header">
                    <span class="participant-name">{{ response.name }}</span>
                </div>
                {% if response.image_url %}
                <div class="response-image">
                    <img src="{{ response.image_url }}" alt="Selected image" class="zoomable">
                </div>
                {% endif %}
                <ul class="response-bullets">
                    {% for bullet in response.bullets %}
                    <li>{{ bullet }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Focus add-member input on page load (for quick successive adds)
    const input = document.getElementById('add-member-input');
    if (input) input.focus();

    // Auto-dismiss error after 3 seconds
    const error = document.getElementById('member-error');
    if (error) {
        setTimeout(function() {
            error.style.opacity = '0';
            error.style.transition = 'opacity 0.3s ease';
            setTimeout(function() { error.remove(); }, 300);
        }, 3000);
    }
});
</script>

{% if session.state.value == 'capturing' %}
<script src="/static/js/polling.js?v=4"></script>
{% endif %}

{% if session.state.value == 'closed' and (synthesis_pending or synthesis_generating) %}
{# Synthesis auto-triggered - poll for completion #}
<script>
(function() {
    'use strict';
    const sessionId = {{ session.id }};
    const POLL_INTERVAL = 3000;

    async function checkSynthesis() {
        try {
            const response = await fetch(`/admin/sessions/${sessionId}/synthesis-status`);
            if (!response.ok) return;

            const data = await response.json();
            if (data.status === 'complete' || data.status === 'failed') {
                window.location.reload();
            }
        } catch (error) {
            console.error('Synthesis poll error:', error);
        }
    }

    setInterval(checkSynthesis, POLL_INTERVAL);
    console.log('Synthesis status polling started');
})();
</script>
{% endif %}

{% if synthesis_themes %}
{# Handle regenerate button loading state #}
<script>
(function() {
    'use strict';
    const form = document.getElementById('regenerate-form');
    const btn = document.getElementById('regenerate-btn');

    if (form && btn) {
        form.addEventListener('submit', function(e) {
            // Only proceed if confirm returned true (form is actually submitting)
            setTimeout(function() {
                btn.disabled = true;
                btn.textContent = 'Regenerating...';
                btn.classList.add('btn-loading');
            }, 10);
        });
    }
})();
</script>
{% endif %}
{% endblock %}
