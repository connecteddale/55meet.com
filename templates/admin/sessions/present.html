{% extends "base.html" %}

{% block title %}{{ team.team_name }} - {{ session.month }} | The 55{% endblock %}

{% block nav %}
<nav>
    <a href="/admin/sessions/{{ session.id }}" class="btn btn-secondary">Back to Session</a>
</nav>
{% endblock %}

{% block content %}
<div class="results-page">
    {# Header #}
    <div class="results-header">
        <h1>{{ team.team_name }}</h1>
        <p class="results-meta">{{ team.company_name }} &middot; {{ session.month }}</p>
    </div>

    {% if synthesis_failed %}
    {# Synthesis Error State #}
    <div class="card">
        <div class="synthesis-error-box">
            <h3>Synthesis Generation Failed</h3>
            <p>{{ synthesis_themes }}</p>
            <form method="POST" action="/admin/sessions/{{ session.id }}/synthesize/retry">
                <button type="submit" class="btn btn-primary">Retry Synthesis</button>
            </form>
        </div>
    </div>
    {% else %}

    {# Section 1: Synthesis Summary #}
    <div class="card">
        <h2>What We Heard</h2>
        {% if synthesis_themes %}
        <p class="results-themes">{{ synthesis_themes }}</p>
        {% else %}
        <p class="text-muted">No synthesis available.</p>
        {% endif %}

        {% if synthesis_gap_type %}
        <h2>Suggested Gap</h2>
        <div class="results-gap">
            <span class="gap-badge gap-{{ synthesis_gap_type|lower }}">{{ synthesis_gap_type }}</span>
            {% if synthesis_gap_reasoning %}
            <p class="gap-reasoning">{{ synthesis_gap_reasoning }}</p>
            {% else %}
            <p class="gap-reasoning text-muted">
                {% if synthesis_gap_type == "Direction" %}
                The responses suggest team members may see different destinations.
                {% elif synthesis_gap_type == "Alignment" %}
                The responses suggest team members may be pulling in different directions.
                {% elif synthesis_gap_type == "Commitment" %}
                The responses suggest individual priorities may outweigh collective goals.
                {% endif %}
            </p>
            {% endif %}
        </div>
        {% endif %}
    </div>

    {# Section 2: Key Insights #}
    {% if synthesis_statements %}
    <div class="card">
        <h2>Key Insights</h2>
        <ul class="results-insights">
            {% for stmt in synthesis_statements %}
            <li>
                {% if stmt.name %}<span class="insight-name">{{ stmt.name }}</span>{% endif %}
                <span class="insight-text">{{ stmt.statement }}</span>
                <span class="insight-attribution">&mdash; {{ stmt.participants|join(', ') }}</span>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {# Section 3: Individual Responses #}
    <div class="card">
        <h2>Individual Responses</h2>
        {% if raw_responses %}
        <div class="responses-list">
            {% for response in raw_responses %}
            <div class="response-item">
                <h3 class="response-name">{{ response.participant }}</h3>
                <div class="response-body">
                    <div class="response-image">
                        <img src="{{ response.image_url }}" alt="Selected image" loading="lazy" class="zoomable">
                    </div>
                    {% if response.bullets %}
                    <ul class="response-bullets">
                        {% for bullet in response.bullets %}
                        <li>{{ bullet }}</li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted">No explanation provided</p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted">No responses recorded.</p>
        {% endif %}
    </div>

    {# Section 4: Recalibration Action #}
    {% if session.recalibration_action %}
    <div class="card results-action">
        <h2>Recalibration Action</h2>
        <p class="action-text">{{ session.recalibration_action }}</p>
        {% if session.recalibration_completed %}
        <span class="action-status completed">Completed</span>
        {% else %}
        <span class="action-status pending">Pending</span>
        {% endif %}
    </div>
    {% endif %}

    {% endif %}

    {# Footer Actions #}
    <div class="results-footer">
        <div class="export-links">
            <span>Export:</span>
            <a href="/admin/sessions/{{ session.id }}/export/level1" class="btn btn-small btn-secondary">Themes</a>
            <a href="/admin/sessions/{{ session.id }}/export/level2" class="btn btn-small btn-secondary">Insights</a>
            <a href="/admin/sessions/{{ session.id }}/export/level3" class="btn btn-small btn-secondary">Raw Data</a>
            <a href="/admin/sessions/{{ session.id }}/export" class="btn btn-small btn-secondary">Full JSON</a>
        </div>
    </div>
</div>
{% endblock %}
